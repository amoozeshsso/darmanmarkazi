// ثبت پاسخ‌ها و محاسبه نمره و ذخیره score در exam_results
quizForm.addEventListener('submit', async e => {
  e.preventDefault();
  resultBox.style.display = 'none';
  loading.style.display = 'block';

  // گرفتن user_id از جدول users
  const { data: userData, error: userError } = await supabase
    .from('users')
    .select('id')
    .eq('username', username)
    .single();
  if (userError || !userData) {
    loading.style.display = 'none';
    errorBox.textContent = 'خطا در شناسایی کاربر!';
    return;
  }
  const user_id = userData.id;

  let correct = 0;
  let total = questions.length;
  let answers = [];

  questions.forEach(q => {
    const selected = quizForm.elements[`q${q.id}`].value;
    if (Number(selected) === q.correct_option) correct++;
    answers.push({
      user_id,
      exam_id: Number(selectedExamId),
      question_id: q.id,
      selected_option: Number(selected)
    });
  });

  // پاک کردن پاسخ‌های قبلی کاربر برای این آزمون
  await supabase
    .from('user_answers')
    .delete()
    .eq('user_id', user_id)
    .eq('exam_id', selectedExamId);

  // ذخیره پاسخ‌های جدید
  for (const ans of answers) {
    await supabase.from('user_answers').insert([ans]);
  }

  // محاسبه و ذخیره نمره از 100 در جدول exam_results
  const score = Math.round((correct / total) * 100);

  // حذف رکورد قبلی (اگر وجود داشته باشد)
  await supabase
    .from('exam_results')
    .delete()
    .eq('user_id', user_id)
    .eq('exam_id', selectedExamId);

  // درج نمره جدید
  await supabase.from('exam_results').insert([{
    user_id: user_id,
    exam_id: Number(selectedExamId),
    score: score
  }]);

  loading.style.display = 'none';
  resultBox.style.display = 'block';
  resultBox.innerHTML = `تعداد پاسخ صحیح: <b>${correct}</b> از <b>${total}</b> <br> نمره شما: <b>${score}</b> از 100`;
});

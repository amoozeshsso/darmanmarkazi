<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>آزمون آنلاین</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); padding: 30px; }
    h1 { text-align: center; color: #333; }
    .question { margin-bottom: 25px; }
    .question-title { font-weight: bold; margin-bottom: 10px; }
    .options label { display: block; margin-bottom: 7px; cursor: pointer; }
    .submit-btn { background: #4e54c8; color: #fff; border: none; padding: 12px 30px; border-radius: 8px; font-size: 17px; cursor: pointer; margin-top: 20px; }
    #timer { font-size: 18px; color: #c0392b; text-align: left; margin-bottom: 15px; }
    #result { margin-top: 30px; font-size: 20px; text-align: center; }
    #error { color: #c0392b; text-align: center; margin: 20px 0; }
    .back { margin-bottom: 18px; text-align: right; }
    .back a { background: #4e54c8; color: #fff; padding: 8px 18px; border-radius: 5px; text-decoration: none; }
    @media (max-width: 600px) {
      .container { padding: 10px; }
      .submit-btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back">
      <a href="exam-list.html">بازگشت به لیست آزمون‌ها</a>
    </div>
    <h1 id="examTitle">آزمون</h1>
    <div id="timer"></div>
    <form id="quizForm"></form>
    <button id="submitBtn" class="submit-btn" style="display:none;">ثبت پاسخ‌ها</button>
    <div id="result"></div>
    <div id="error"></div>
  </div>
  <script>
    // --- تنظیمات Supabase ---
    const SUPABASE_URL = "https://qdccjbakfuywvdqfcoyg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU";
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- متغیرها ---
    const urlParams = new URLSearchParams(window.location.search);
    const examId = parseInt(urlParams.get('exam_id'));
    const userId = sessionStorage.getItem('userId');
    if (!userId) {
      alert('لطفاً ابتدا وارد شوید.');
      window.location.href = 'login.html';
    }

    let questions = [];
    let examData = null;
    let timerInterval = null;
    let duration = 20; // پیش‌فرض
    let timeLeft = 0;
    let quizFinished = false;

    const examTitle = document.getElementById('examTitle');
    const quizForm = document.getElementById('quizForm');
    const submitBtn = document.getElementById('submitBtn');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const timerDiv = document.getElementById('timer');

    // --- بارگذاری آزمون و سوالات ---
    async function loadQuiz() {
      errorDiv.textContent = '';
      resultDiv.textContent = '';
      quizForm.innerHTML = '';
      submitBtn.style.display = 'none';
      timerDiv.textContent = '';

      // دریافت اطلاعات آزمون
      const { data: exam, error: examError } = await supabase
        .from('exams')
        .select('title, duration_minutes, random_question_count, start_at, end_at')
        .eq('id', examId)
        .single();

      if (examError || !exam) {
        errorDiv.textContent = 'خطا در دریافت اطلاعات آزمون!';
        return;
      }
      examData = exam;
      examTitle.textContent = exam.title || 'آزمون';
      duration = exam.duration_minutes || 20;

      // بررسی بازه زمانی آزمون
      const now = new Date();
      if (exam.start_at && now < new Date(exam.start_at)) {
        errorDiv.textContent = 'آزمون هنوز شروع نشده است!';
        return;
      }
      if (exam.end_at && now > new Date(exam.end_at)) {
        errorDiv.textContent = 'مهلت شرکت در آزمون به پایان رسیده است!';
        return;
      }

      // تعداد سوالات تصادفی این آزمون
      const questionCount = exam.random_question_count || 10;

      // دریافت سوالات تصادفی با rpc
      const { data: qData, error: qErr } = await supabase
        .rpc('get_random_questions', {
          exam_id_param: examId,
          limit_count: questionCount
        });

      if (qErr || !qData || !qData.length) {
        errorDiv.textContent = 'سوالی برای این آزمون ثبت نشده است!';
        return;
      }
      questions = qData;

      // نمایش سوالات
      renderQuestions();
      submitBtn.style.display = 'block';

      // شروع تایمر
      startTimer(duration);
    }

    // --- نمایش سوالات ---
    function renderQuestions() {
      quizForm.innerHTML = questions.map((q, idx) => `
        <div class="question">
          <div class="question-title">${idx + 1}. ${q.question_text}</div>
          <div class="options">
            <label><input type="radio" name="q_${q.id}" value="1" required /> ${q.option1}</label>
            <label><input type="radio" name="q_${q.id}" value="2" /> ${q.option2}</label>
            <label><input type="radio" name="q_${q.id}" value="3" /> ${q.option3}</label>
            <label><input type="radio" name="q_${q.id}" value="4" /> ${q.option4}</label>
          </div>
        </div>
      `).join('');
    }

    // --- مدیریت تایمر آزمون ---
    function startTimer(minutes) {
      timeLeft = minutes * 60;
      updateTimer();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (!quizFinished) {
            submitQuiz(true);
          }
        }
      }, 1000);
    }

    function updateTimer() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      timerDiv.textContent = `زمان باقی‌مانده: ${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // --- ثبت پاسخ‌ها ---
    submitBtn.addEventListener('click', function (e) {
      e.preventDefault();
      submitQuiz(false);
    });

    async function submitQuiz(isTimeout) {
      quizFinished = true;
      submitBtn.disabled = true;
      clearInterval(timerInterval);

      // جمع‌آوری پاسخ‌ها
      const answers = [];
      let answeredCount = 0;
      questions.forEach(q => {
        const radios = document.getElementsByName('q_' + q.id);
        let selected = null;
        for (const r of radios) {
          if (r.checked) selected = r.value;
        }
        if (selected) answeredCount++;
        answers.push({
          question_id: q.id,
          answer: selected ? parseInt(selected) : null
        });
      });

      // اگر زمان تمام نشده و همه سوالات پاسخ داده نشده
      if (!isTimeout && answeredCount < questions.length) {
        errorDiv.textContent = 'لطفاً به همه سوالات پاسخ دهید!';
        submitBtn.disabled = false;
        return;
      }

      // بررسی پاسخ صحیح
      let correct = 0;
      questions.forEach((q, idx) => {
        if (answers[idx].answer === q.correct_option) correct++;
      });

      // ذخیره نتیجه در exam_results
      const { error: resErr } = await supabase.from('exam_results').insert([{
        exam_id: examId,
        user_id: userId,
        score: correct,
        total: questions.length,
        answers: JSON.stringify(answers),
        finished_at: new Date().toISOString()
      }]);
      if (resErr) {
        resultDiv.textContent = '';
        errorDiv.textContent = 'خطا در ذخیره نتیجه آزمون!';
        return;
      }

      // نمایش نتیجه
      resultDiv.innerHTML = `
        <div style="color:#27ae60;font-size:22px;font-weight:bold;">
          آزمون شما با موفقیت ثبت شد!
        </div>
        <div style="margin-top:10px;">
          تعداد پاسخ صحیح: <b>${correct}</b> از <b>${questions.length}</b>
        </div>
      `;
      quizForm.innerHTML = '';
      submitBtn.style.display = 'none';
      timerDiv.textContent = '';
    }

    // --- شروع ---
    loadQuiz();
  </script>
</body>
</html>

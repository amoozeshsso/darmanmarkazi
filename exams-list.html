<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لیست آزمون‌ها</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <style>
    body { font-family: Tahoma; background: #f8f8f8; margin: 0; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: #fff; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); padding: 30px; }
    h1 { text-align: center; color: #333; }
    .exam-item { background: #f3f7fa; margin: 15px 0; padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .exam-title { font-size: 18px; font-weight: bold; color: #222; }
    .enter-btn { background: #4e54c8; color: #fff; border: none; padding: 8px 22px; border-radius: 6px; font-size: 15px; cursor: pointer; }
    #error { margin-top: 20px; color: #c0392b; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>لیست آزمون‌های فعال</h1>
    <div id="examsList"></div>
    <div id="error"></div>
  </div>
  <script>
    const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const examsList = document.getElementById('examsList');
    const errorDiv = document.getElementById('error');

    // گرفتن userId کاربر لاگین‌شده
    const userId = sessionStorage.getItem('userId');
    if (!userId) {
      alert('لطفاً ابتدا وارد شوید.');
      window.location.href = 'login.html';
    }

    async function loadExams() {
      examsList.innerHTML = 'در حال بارگذاری...';
      errorDiv.textContent = '';

      // دریافت همه آزمون‌های فعال
      const { data: exams, error: examsError } = await supabase
        .from('exams')
        .select('*')
        .eq('active', true)
        .order('id', { ascending: false });

      if (examsError) {
        errorDiv.textContent = 'خطا در دریافت لیست آزمون‌ها!';
        examsList.innerHTML = '';
        return;
      }
      if (!exams.length) {
        examsList.innerHTML = '<div>آزمونی فعال وجود ندارد.</div>';
        return;
      }

      // دریافت لیست آزمون‌هایی که کاربر قبلاً شرکت کرده است
      const { data: results, error: resultsError } = await supabase
        .from('exam_results')
        .select('exam_id')
        .eq('user_id', userId);

      if (resultsError) {
        errorDiv.textContent = 'خطا در دریافت سوابق آزمون!';
        examsList.innerHTML = '';
        return;
      }

      // استخراج شناسه آزمون‌هایی که کاربر قبلاً شرکت کرده
      const attemptedExamIds = results.map(r => r.exam_id);

      // فیلتر آزمون‌هایی که کاربر هنوز شرکت نکرده
      const availableExams = exams.filter(exam => !attemptedExamIds.includes(exam.id));

      if (!availableExams.length) {
        examsList.innerHTML = '<div>شما در همه آزمون‌های فعال شرکت کرده‌اید.</div>';
        return;
      }

      examsList.innerHTML = availableExams.map(exam => `
        <div class="exam-item">
          <span class="exam-title">${exam.title}</span>
          <button class="enter-btn" onclick="enterExam(${exam.id})">شروع آزمون</button>
        </div>
      `).join('');
    }

    window.enterExam = function(examId) {
      sessionStorage.setItem('examId', examId);
      window.location.href = 'quiz.html?exam_id=' + examId;
    }

    loadExams();
  </script>
</body>
</html>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';

    const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById('loginForm');
    const btn = document.getElementById('loginBtn');
    const err = document.getElementById('error');

    const showError = msg => {
      err.textContent = msg;
      btn.disabled = false;
    };

    form.addEventListener('submit', async e => {
      e.preventDefault();
      err.textContent = '';
      btn.disabled = true;

      const username = form.username.value.trim();
      const password = form.password.value.trim();

      if (!username || !password) {
        return showError('لطفاً همهٔ فیلدها را پر کنید.');
      }

      // جستجو در جدول users برای username واردشده
      const { data, error } = await sbClient
        .from('users')
        .select('id, username, password, role')
        .eq('username', username)
        .single();

      if (error) {
        console.error('DB Error:', error);
        showError('خطا در ارتباط با پایگاه داده یا نام کاربری وجود ندارد.');
        btn.disabled = false;
        return;
      }

      if (!data || data.password !== password) {
        showError('نام کاربری یا رمز عبور اشتباه است.');
        btn.disabled = false;
        return;
      }

      // ذخیره اطلاعات ورود در sessionStorage
      sessionStorage.setItem('userId', data.id);      // 👈 این خط باید اینجا باشد!
      sessionStorage.setItem('userRole', data.role);
      sessionStorage.setItem('username', data.username);
      sessionStorage.setItem('loginTime', new Date().toISOString());

      window.location.href = data.role === 'admin' ? 'admin-dashboard.html' : 'quiz.html';
    });
  });
</script>

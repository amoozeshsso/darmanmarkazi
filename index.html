<script>
  document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';

    const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById('loginForm');
    const btn = document.getElementById('loginBtn');
    const err = document.getElementById('error');

    const showError = msg => {
      err.textContent = msg;
      btn.disabled = false;
    };

    form.addEventListener('submit', async e => {
      e.preventDefault();
      err.textContent = '';
      btn.disabled = true;

      const username = form.username.value.trim();
      const password = form.password.value.trim();

      if (!username || !password) {
        return showError('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡Ù” ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.');
      }

      // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¬Ø¯ÙˆÙ„ users Ø¨Ø±Ø§ÛŒ username ÙˆØ§Ø±Ø¯Ø´Ø¯Ù‡
      const { data, error } = await sbClient
        .from('users')
        .select('id, username, password, role')
        .eq('username', username)
        .single();

      if (error) {
        console.error('DB Error:', error);
        showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
        btn.disabled = false;
        return;
      }

      if (!data || data.password !== password) {
        showError('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
        btn.disabled = false;
        return;
      }

      // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯ Ø¯Ø± sessionStorage
      sessionStorage.setItem('userId', data.id);      // ğŸ‘ˆ Ø§ÛŒÙ† Ø®Ø· Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§Ø´Ø¯!
      sessionStorage.setItem('userRole', data.role);
      sessionStorage.setItem('username', data.username);
      sessionStorage.setItem('loginTime', new Date().toISOString());

      window.location.href = data.role === 'admin' ? 'admin-dashboard.html' : 'quiz.html';
    });
  });
</script>

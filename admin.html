<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل مدیریت کاربران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Tahoma; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { color: #333; text-align: center; }
    .container { max-width: 1000px; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th { background: #2c3e50; color: white; padding: 12px; text-align: center; }
    td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e9f7ef; }
    button { padding: 8px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
    button:hover { opacity: 0.8; }
    .add-btn { background: #27ae60; color: white; width: 100%; padding: 10px; font-size: 16px; }
    .edit-btn { background: #2980b9; color: white; }
    .delete-btn { background: #c0392b; color: white; }
    #formBox { margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; max-width: 600px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    input, select { padding: 10px; margin: 8px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
    input:focus, select:focus { border-color: #3498db; outline: none; }
    label { display: block; margin-top: 10px; color: #555; font-weight: bold; }
    #error, #success { margin-top: 15px; text-align: center; padding: 10px; border-radius: 4px; }
    #error { color: white; background-color: rgba(231, 76, 60, 0.8); }
    #success { color: white; background-color: rgba(46, 204, 113, 0.8); }
    .loading { text-align: center; margin: 20px; }
    .spinner { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .action-column { min-width: 150px; }
  </style>
  <!-- بارگذاری کتابخانه supabase-js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h1>مدیریت کاربران</h1>
    
    <div id="formBox">
      <h3 id="formTitle">افزودن کاربر جدید</h3>
      <form id="userForm">
        <input type="hidden" id="editId" />
        
        <label for="username">نام کاربری:</label>
        <input type="text" id="username" placeholder="نام کاربری را وارد کنید" required />
        
        <label for="password">رمز عبور:</label>
        <input type="password" id="password" placeholder="رمز عبور را وارد کنید" />
        
        <label for="role">نقش:</label>
        <select id="role" required>
          <option value="">انتخاب کنید</option>
          <option value="admin">ادمین</option>
          <option value="user">کاربر</option>
        </select>
        
        <div style="margin-top: 20px;">
          <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
        </div>
        
        <div id="error" style="display: none;"></div>
        <div id="success" style="display: none;"></div>
      </form>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>نام کاربری</th>
          <th>نقش</th>
          <th class="action-column">عملیات</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="4">در حال بارگذاری کاربران...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // پیکربندی Supabase:
    // لطفاً مقادیر supabaseUrl و supabaseKey را متناسب با پروژه خود تنظیم کنید.
    const supabaseUrl = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // جایگزین کنید
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // انتظار برای بارگذاری کامل صفحه
    document.addEventListener('DOMContentLoaded', () => {
      initApp();
    });

    const initApp = async () => {
      try {
        await loadUsers();
        setupFormHandler();
        showSuccess('سیستم با موفقیت بارگذاری شد');
        setTimeout(hideMessages, 2000);
      } catch (error) {
        console.error('Error initializing app:', error);
        showError('خطا در راه‌اندازی برنامه: ' + error.message);
      }
    };

    // بارگذاری کاربران از پایگاه داده Supabase
    const loadUsers = async () => {
      setLoading(true);
      try {
        const { data: users, error } = await supabase
          .from('users')
          .select('user_id, username, role')
          .order('user_id');
        if (error) {
          throw error;
        }
        renderUsers(users);
      } catch (error) {
        console.error('خطای بارگذاری کاربران:', error);
        showError('خطای بارگذاری کاربران: ' + error.message);
        document.getElementById('userList').innerHTML = `<tr><td colspan="4">خطا در بارگذاری اطلاعات</td></tr>`;
      } finally {
        setLoading(false);
      }
    };

    // نمایش کاربران در جدول
    const renderUsers = (users) => {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      if (!users || users.length === 0) {
        userList.innerHTML = `<tr><td colspan="4">هیچ کاربری یافت نشد</td></tr>`;
        return;
      }
      users.sort((a, b) => a.user_id - b.user_id);
      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.user_id}</td>
          <td>${escapeHTML(user.username)}</td>
          <td>${user.role === 'admin' ? 'ادمین' : 'کاربر'}</td>
          <td class="action-column">
            <button class="edit-btn" onclick="handleEdit(${user.user_id})">ویرایش</button>
            <button class="delete-btn" onclick="handleDelete(${user.user_id})">حذف</button>
          </td>
        `;
        userList.appendChild(row);
      });
    };

    // تابع فرار از کاراکترهای HTML
    const escapeHTML = (str) => {
      if (!str) return '';
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    // تنظیم رویداد ارسال فرم
    const setupFormHandler = () => {
      const form = document.getElementById('userForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        if (!username) {
          showError('لطفاً نام کاربری را وارد کنید');
          return;
        }
        if (!editId && !password) {
          showError('لطفاً رمز عبور را وارد کنید');
          return;
        }
        if (!role) {
          showError('لطفاً نقش کاربر را انتخاب کنید');
          return;
        }
    
        setLoading(true);
        try {
          if (editId) {
            // به‌روزرسانی کاربر موجود
            const updateData = { username, role };
            if (password) {
              updateData.password = password;
            }
            const { error } = await supabase
              .from('users')
              .update(updateData)
              .eq('user_id', editId);
            if (error) {
              throw error;
            }
            showSuccess('کاربر با موفقیت به‌روز شد');
          } else {
            // ایجاد کاربر جدید
            const { error } = await supabase
              .from('users')
              .insert([{ username, password, role }]);
            if (error) {
              throw error;
            }
            showSuccess('کاربر جدید با موفقیت ایجاد شد');
          }
          resetForm();
          await loadUsers();
        } catch (error) {
          console.error('Error saving user:', error);
          showError(error.message);
        } finally {
          setLoading(false);
        }
      });
    };

    // تابع تغییر وضعیت بارگذاری
    const setLoading = (isLoading) => {
      document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
      document.querySelectorAll('button').forEach(btn => btn.disabled = isLoading);
    };

    // ویرایش کاربر
    const handleEdit = async (user_id) => {
      try {
        const { data: user, error } = await supabase
          .from('users')
          .select('user_id, username, role')
          .eq('user_id', user_id)
          .single();
        if (error || !user) {
          throw error || new Error('کاربر مورد نظر یافت نشد');
        }
        document.getElementById('formTitle').textContent = 'ویرایش کاربر';
        document.getElementById('editId').value = user.user_id;
        document.getElementById('username').value = user.username;
        document.getElementById('password').value = '';
        document.getElementById('role').value = user.role;
        document.getElementById('submitBtn').textContent = 'به‌روزرسانی';
        document.getElementById('formBox').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error in edit handler:', error);
        showError('خطا: ' + error.message);
      }
    };

    // حذف کاربر
    const handleDelete = async (user_id) => {
      if (!confirm('آیا از حذف این کاربر اطمینان دارید؟')) return;
      setLoading(true);
      try {
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('user_id', user_id);
        if (error) {
          throw error;
        }
        showSuccess('کاربر با موفقیت حذف شد');
        await loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        showError('خطا در حذف کاربر: ' + error.message);
      } finally {
        setLoading(false);
      }
    };

    // مخفی کردن پیام‌ها
    const hideMessages = () => {
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
    };

    const showError = (message) => {
      displayMessage('error', message, 5000);
    };

    const showSuccess = (message) => {
      displayMessage('success', message, 3000);
    };

    const displayMessage = (type, message, duration) => {
      const errorEl = document.getElementById('error');
      const successEl = document.getElementById('success');
      if (type === 'error') {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        successEl.style.display = 'none';
        setTimeout(() => errorEl.style.display = 'none', duration);
      } else {
        successEl.textContent = message;
        successEl.style.display = 'block';
        errorEl.style.display = 'none';
        setTimeout(() => successEl.style.display = 'none', duration);
      }
    };

    // پاکسازی فرم
    const resetForm = () => {
      document.getElementById('formTitle').textContent = 'افزودن کاربر جدید';
      document.getElementById('editId').value = '';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('role').value = '';
      document.getElementById('submitBtn').textContent = 'ذخیره';
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل مدیریت کاربران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; margin-bottom: 30px; }
    .container { max-width: 1000px; margin: auto; }
    table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #2c3e50; color: #fff; font-weight: bold; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f7ef; }
    .action-column { min-width: 150px; }
    button { 
      padding: 8px 15px; 
      margin: 2px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    .add-btn { background: #27ae60; color: #fff; width: 100%; font-size: 16px; }
    .edit-btn { background: #2980b9; color: #fff; }
    .delete-btn { background: #c0392b; color: #fff; }
    #formBox { 
      background: #fff; 
      padding: 25px;
      border-radius: 8px; 
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    label { display: block; margin-top: 15px; color: #444; font-weight: bold; }
    input { 
      width: 100%; 
      padding: 12px;
      margin: 8px 0; 
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }
    input:focus { 
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52,152,219,0.3);
    }
    #loading { 
      display: none; 
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
    }
    .spinner { 
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: auto;
      margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #error, #success { 
      display: none;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }
    #error { background: rgba(231,76,60,0.9); color: #fff; }
    #success { background: rgba(46,204,113,0.9); color: #fff; }
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .file-input-wrapper {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed #ddd;
      border-radius: 4px;
      text-align: center;
    }
    .last-update {
      text-align: left;
      color: #666;
      font-size: 0.9em;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>پنل مدیریت کاربران</h1>
    <div id="formBox">
      <div class="file-input-wrapper">
        <label for="excelFile">بارگذاری فایل اکسل کاربران:</label>
        <button type="button" id="downloadSampleUserExcel" class="add-btn" style="background:#27ae60;margin:10px 0;width:100%;font-size:15px;">
          دانلود نمونه فایل اکسل کاربران
        </button>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-top:10px;" />
        <button type="button" id="importBtn" class="add-btn">وارد کردن کاربران</button>
      </div>

      <button type="button" id="deleteAllUsersBtn" class="delete-btn" style="width:100%;font-size:16px;margin:20px 0;">
        حذف همه کاربران غیرادمین
      </button>

      <h3 id="formTitle">افزودن کاربر جدید</h3>
      <form id="userForm">
        <input type="hidden" id="editId" />
        <label for="username">نام کاربری:</label>
        <input type="text" id="username" required placeholder="نام کاربری را وارد کنید" />
        <label for="password">رمز عبور:</label>
        <input type="password" id="password" placeholder="رمز عبور را وارد کنید" />
        <button type="submit" id="submitBtn" class="add-btn" style="margin-top:20px;">ذخیره</button>
      </form>
      <div id="error"></div>
      <div id="success"></div>
    </div>

    <div id="loading">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>نام کاربری</th>
          <th class="action-column">عملیات</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="3">در حال بارگذاری کاربران...</td></tr>
      </tbody>
    </table>

    <div class="last-update" id="lastUpdate"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // تنظیمات Supabase
      const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF[...]';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // المان‌های DOM
      const elements = {
        form: document.getElementById('userForm'),
        list: document.getElementById('userList'),
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        success: document.getElementById('success'),
        formTitle: document.getElementById('formTitle'),
        editId: document.getElementById('editId'),
        submitBtn: document.getElementById('submitBtn'),
        lastUpdate: document.getElementById('lastUpdate')
      };

      // توابع کمکی
      const utils = {
        showLoading: (show) => elements.loading.style.display = show ? 'block' : 'none',
        showError: (msg) => {
          elements.error.textContent = msg;
          elements.error.style.display = 'block';
          elements.success.style.display = 'none';
          setTimeout(() => elements.error.style.display = 'none', 5000);
        },
        showSuccess: (msg) => {
          elements.success.textContent = msg;
          elements.success.style.display = 'block';
          elements.error.style.display = 'none';
          setTimeout(() => elements.success.style.display = 'none', 5000);
        },
        hideMessages: () => {
          elements.error.style.display = 'none';
          elements.success.style.display = 'none';
        },
        updateLastUpdateTime: () => {
          const now = new Date();
          elements.lastUpdate.textContent = `آخرین به‌روزرسانی: ${now.toLocaleString('fa-IR')}`;
        },
        validateUsername: (username) => {
          return username.length >= 3 && /^[a-zA-Z0-9_]+$/.test(username);
        },
        validatePassword: (password) => {
          return password.length >= 5;
        }
      };

      // بارگذاری کاربران
      const loadUsers = async () => {
        utils.showLoading(true);
        utils.hideMessages();

        try {
          const { data, error } = await supabase
            .from('users')
            .select('id,username')
            .eq('role', 'user')
            .order('id');

          if (error) throw error;

          elements.list.innerHTML = data.length ? data.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${u.username}</td>
              <td class="action-buttons">
                <button class="edit-btn" data-id="${u.id}" data-username="${u.username}">ویرایش</button>
                <button class="delete-btn" data-id="${u.id}">حذف</button>
              </td>
            </tr>`).join('') : '<tr><td colspan="3">کاربری یافت نشد</td></tr>';

          utils.updateLastUpdateTime();
        } catch (err) {
          utils.showError(err.message || 'خطا در دریافت داده‌ها');
          elements.list.innerHTML = '<tr><td colspan="3">خطا در دریافت داده‌ها</td></tr>';
        } finally {
          utils.showLoading(false);
        }
      };

      // مدیریت فایل اکسل نمونه
      document.getElementById('downloadSampleUserExcel').onclick = function() {
        const ws_data = [
          ['username', 'password'],
          ['user1', '12345']
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Users');
        XLSX.writeFile(wb, 'sample_users.xlsx');
      };

      // وارد کردن کاربران از فایل اکسل
      document.getElementById('importBtn').addEventListener('click', async () => {
        utils.hideMessages();
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];

        if (!file) {
          return utils.showError('لطفاً یک فایل اکسل انتخاب کنید');
        }

        utils.showLoading(true);
        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const users = [];
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const username = row[0]?.toString().trim();
            const password = row[1]?.toString();

            if (username && password) {
              if (!utils.validateUsername(username)) {
                utils.showError(`نام کاربری نامعتبر در ردیف ${i + 1}`);
                return;
              }
              if (!utils.validatePassword(password)) {
                utils.showError(`رمز عبور نامعتبر در ردیف ${i + 1}`);
                return;
              }
              users.push({ username, password, role: 'user' });
            }
          }

          if (!users.length) {
            utils.showError('هیچ کاربر معتبری در فایل یافت نشد');
            return;
          }

          const { data: existing, error: fetchError } = await supabase
            .from('users')
            .select('username');

          if (fetchError) throw fetchError;

          const existingUsernames = new Set(existing.map(u => u.username));
          const newUsers = users.filter(u => !existingUsernames.has(u.username));

          if (!newUsers.length) {
            utils.showError('همه کاربران فایل اکسل تکراری هستند');
            return;
          }

          const { error } = await supabase.from('users').insert(newUsers);
          if (error) throw error;

          utils.showSuccess(`${newUsers.length} کاربر جدید با موفقیت اضافه شد`);
          fileInput.value = '';
          await loadUsers();
        } catch (err) {
          utils.showError(err.message || 'خطا در پردازش فایل');
        } finally {
          utils.showLoading(false);
        }
      });

      // مدیریت فرم
      elements.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        utils.hideMessages();

        const id = elements.editId.value;
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!utils.validateUsername(username)) {
          return utils.showError('نام کاربری باید حداقل 3 کاراکتر و شامل حروف، اعداد یا _ باشد');
        }

        if (!id && !utils.validatePassword(password)) {
          return utils.showError('رمز عبور باید حداقل 5 کاراکتر باشد');
        }

        utils.showLoading(true);
        try {
          if (id) {
            const update = { username };
            if (password) {
              if (!utils.validatePassword(password)) {
                utils.showError('رمز عبور باید حداقل 5 کاراکتر باشد');
                return;
              }
              update.password = password;
            }
            const { error } = await supabase.from('users').update(update).eq('id', id);
            if (error) throw error;
            utils.showSuccess('کاربر با موفقیت ویرایش شد');
          } else {
            const { error } = await supabase.from('users').insert([{ 
              username, 
              password, 
              role: 'user'
            }]);
            if (error) throw error;
            utils.showSuccess('کاربر جدید با موفقیت اضافه شد');
          }

          elements.form.reset();
          elements.editId.value = '';
          elements.formTitle.textContent = 'افزودن کاربر جدید';
          elements.submitBtn.textContent = 'ذخیره';
          await loadUsers();
        } catch (err) {
          utils.showError(err.message || 'خطا در ذخیره اطلاعات');
        } finally {
          utils.showLoading(false);
        }
      });

      // مدیریت دکمه‌های جدول
      elements.list.addEventListener('click', async (e) => {
        const btn = e.target;
        if (!btn.matches('button')) return;

        const id = btn.dataset.id;
        
        if (btn.classList.contains('edit-btn')) {
          elements.editId.value = id;
          document.getElementById('username').value = btn.dataset.username;
          document.getElementById('password').value = '';
          elements.formTitle.textContent = 'ویرایش کاربر';
          elements.submitBtn.textContent = 'به‌روزرسانی';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (btn.classList.contains('delete-btn')) {
          if (!confirm('آیا از حذف این کاربر اطمینان دارید؟')) return;

          utils.showLoading(true);
          try {
            const { error } = await supabase.from('users').delete().eq('id', id);
            if (error) throw error;
            utils.showSuccess('کاربر با موفقیت حذف شد');
            await loadUsers();
          } catch (err) {
            utils.showError(err.message || 'خطا در حذف کاربر');
          } finally {
            utils.showLoading(false);
          }
        }
      });

      // حذف همه کاربران
      document.getElementById('deleteAllUsersBtn').addEventListener('click', async () => {
        if (!confirm('آیا از حذف تمام کاربران غیرادمین اطمینان دارید؟')) return;

        utils.showLoading(true);
        utils.hideMessages();
        
        try {
          const { error } = await supabase.from('users').delete().eq('role', 'user');
          if (error) throw error;
          utils.showSuccess('تمام کاربران غیرادمین با موفقیت حذف شدند');
          await loadUsers();
        } catch (err) {
          utils.showError(err.message || 'خطا در حذف کاربران');
        } finally {
          utils.showLoading(false);
        }
      });

      // بارگذاری اولیه
      await loadUsers();
    });
  </script>
</body>
</html>

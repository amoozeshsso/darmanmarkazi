<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل مدیریت کاربران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Vazirmatn', Tahoma, sans-serif; 
      background: #f8f8f8; 
      margin: 0; 
      padding: 20px; 
    }
    .container { 
      max-width: 1000px; 
      margin: auto; 
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; margin-bottom: 30px; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 12px; 
      text-align: center; 
    }
    th { background: #2c3e50; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #f5f5f5; }
    button { 
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.3s;
    }
    .add-btn { background: #27ae60; color: #fff; width: 100%; }
    .edit-btn { background: #3498db; color: #fff; }
    .delete-btn { background: #e74c3c; color: #fff; }
    button:hover { opacity: 0.9; }
    .form-group {
      margin-bottom: 15px;
    }
    input[type="text"],
    input[type="password"],
    input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 5px;
    }
    #loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #error, #success {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    #error { background: #ffe6e6; color: #e74c3c; }
    #success { background: #e6ffe6; color: #27ae60; }
    .last-update {
      font-size: 12px;
      color: #666;
      text-align: left;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>مدیریت کاربران</h1>
    
    <div class="form-group">
      <button type="button" id="downloadSampleUserExcel" class="add-btn">
        دانلود نمونه فایل اکسل کاربران
      </button>
    </div>

    <div class="form-group">
      <label for="excelFile">انتخاب فایل اکسل:</label>
      <input type="file" id="excelFile" accept=".xlsx,.xls" />
      <button type="button" id="importBtn" class="add-btn">وارد کردن کاربران</button>
    </div>

    <div class="form-group">
      <button type="button" id="deleteAllUsersBtn" class="delete-btn">
        حذف همه کاربران غیرادمین
      </button>
    </div>

    <form id="userForm">
      <input type="hidden" id="editId" />
      <div class="form-group">
        <label for="username">نام کاربری:</label>
        <input type="text" id="username" required />
      </div>
      <div class="form-group">
        <label for="password">رمز عبور:</label>
        <input type="password" id="password" />
      </div>
      <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
    </form>

    <div id="error"></div>
    <div id="success"></div>

    <div id="loading">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>نام کاربری</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="3">در حال بارگذاری کاربران...</td></tr>
      </tbody>
    </table>

    <div class="last-update" id="lastUpdate"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // تنظیمات Supabase
      const supabase = window.supabase.createClient(
        'https://qdccjbakfuywvdqfcoyg.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU'
      );

      // توابع کمکی
      const utils = {
        showLoading: (show) => {
          document.getElementById('loading').style.display = show ? 'block' : 'none';
        },
        showMessage: (type, message) => {
          const element = document.getElementById(type);
          element.textContent = message;
          element.style.display = 'block';
          setTimeout(() => element.style.display = 'none', 5000);
        },
        updateLastUpdate: () => {
          const now = new Date();
          document.getElementById('lastUpdate').textContent = 
            `آخرین به‌روزرسانی: ${now.toLocaleString('fa-IR')}`;
        }
      };

      // بارگذاری کاربران
      const loadUsers = async () => {
        utils.showLoading(true);
        try {
          const { data, error } = await supabase
            .from('users')
            .select('id, username')
            .eq('role', 'user')
            .order('id');

          if (error) throw error;

          const userList = document.getElementById('userList');
          userList.innerHTML = data.length ? data.map(user => `
            <tr>
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td>
                <button class="edit-btn" data-id="${user.id}" data-username="${user.username}">ویرایش</button>
                <button class="delete-btn" data-id="${user.id}">حذف</button>
              </td>
            </tr>
          `).join('') : '<tr><td colspan="3">کاربری یافت نشد</td></tr>';

          utils.updateLastUpdate();
        } catch (err) {
          utils.showMessage('error', 'خطا در بارگذاری کاربران');
        } finally {
          utils.showLoading(false);
        }
      };

      // دانلود نمونه فایل اکسل
      document.getElementById('downloadSampleUserExcel').onclick = () => {
        const ws_data = [
          ['username', 'password'],
          ['user1', '12345'],
          ['user2', '67890']
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Users');
        XLSX.writeFile(wb, 'sample_users.xlsx');
      };

      // وارد کردن کاربران از اکسل
      document.getElementById('importBtn').onclick = async () => {
        const file = document.getElementById('excelFile').files[0];
        if (!file) {
          return utils.showMessage('error', 'لطفاً یک فایل اکسل انتخاب کنید');
        }

        utils.showLoading(true);
        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          const users = rows.map(row => ({
            username: row.username?.toString().trim(),
            password: row.password?.toString(),
            role: 'user'
          })).filter(user => user.username && user.password);

          if (!users.length) {
            return utils.showMessage('error', 'هیچ کاربر معتبری در فایل یافت نشد');
          }

          const { error } = await supabase.from('users').insert(users);
          if (error) throw error;

          utils.showMessage('success', `${users.length} کاربر با موفقیت اضافه شد`);
          document.getElementById('excelFile').value = '';
          await loadUsers();
        } catch (err) {
          utils.showMessage('error', 'خطا در وارد کردن کاربران');
        } finally {
          utils.showLoading(false);
        }
      };

      // مدیریت فرم
      document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = {
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value,
          editId: document.getElementById('editId').value
        };

        if (!formData.username || (!formData.editId && !formData.password)) {
          return utils.showMessage('error', 'لطفاً همه فیلدها را پر کنید');
        }

        utils.showLoading(true);
        try {
          if (formData.editId) {
            const update = { username: formData.username };
            if (formData.password) update.password = formData.password;
            
            const { error } = await supabase
              .from('users')
              .update(update)
              .eq('id', formData.editId);
            
            if (error) throw error;
            utils.showMessage('success', 'کاربر با موفقیت ویرایش شد');
          } else {
            const { error } = await supabase
              .from('users')
              .insert([{ 
                username: formData.username,
                password: formData.password,
                role: 'user'
              }]);
            
            if (error) throw error;
            utils.showMessage('success', 'کاربر جدید اضافه شد');
          }

          e.target.reset();
          document.getElementById('editId').value = '';
          await loadUsers();
        } catch (err) {
          utils.showMessage('error', 'خطا در ذخیره اطلاعات');
        } finally {
          utils.showLoading(false);
        }
      };

      // حذف کاربر
      document.getElementById('userList').onclick = async (e) => {
        const btn = e.target;
        if (btn.classList.contains('delete-btn')) {
          if (!confirm('آیا از حذف این کاربر اطمینان دارید؟')) return;
          
          utils.showLoading(true);
          try {
            const { error } = await supabase
              .from('users')
              .delete()
              .eq('id', btn.dataset.id)
              .eq('role', 'user');

            if (error) throw error;
            utils.showMessage('success', 'کاربر با موفقیت حذف شد');
            await loadUsers();
          } catch (err) {
            utils.showMessage('error', 'خطا در حذف کاربر');
          } finally {
            utils.showLoading(false);
          }
        } else if (btn.classList.contains('edit-btn')) {
          document.getElementById('editId').value = btn.dataset.id;
          document.getElementById('username').value = btn.dataset.username;
          document.getElementById('password').value = '';
          document.getElementById('submitBtn').textContent = 'به‌روزرسانی';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      // حذف همه کاربران
      document.getElementById('deleteAllUsersBtn').onclick = async () => {
        if (!confirm('آیا از حذف همه کاربران غیرادمین اطمینان دارید؟')) return;
        
        utils.showLoading(true);
        try {
          const { error } = await supabase
            .from('users')
            .delete()
            .eq('role', 'user');

          if (error) throw error;
          utils.showMessage('success', 'همه کاربران غیرادمین حذف شدند');
          await loadUsers();
        } catch (err) {
          utils.showMessage('error', 'خطا در حذف کاربران');
        } finally {
          utils.showLoading(false);
        }
      };

      // بارگذاری اولیه
      await loadUsers();
    });
  </script>
</body>
</html>

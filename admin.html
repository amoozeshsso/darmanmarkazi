<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مدیریت کاربران</title>
    <link href="https://fonts.googleapis.com/css?family=Vazirmatn" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* استایل‌های قبلی بدون تغییر */
    </style>
</head>
<body>
    <div class="container">
        <h2>مدیریت کاربران</h2>
        <div class="section">
            <label>بارگذاری فایل اکسل کاربران:</label>
            <input type="file" id="excel-upload" accept=".xlsx, .xls">
            <a href="#" id="download-sample">دانلود نمونه فایل اکسل کاربران</a>
            <button id="import-users">وارد کردن کاربران</button>
            <button id="delete-all-users">حذف همه کاربران</button>
        </div>
        <div class="section">
            <h3>افزودن کاربر جدید</h3>
            <form id="add-user-form" autocomplete="off">
                <label>نام کاربری:</label>
                <input type="text" id="username" required>
                <label>رمز عبور:</label>
                <input type="password" id="password" required>
                <button type="submit">ذخیره</button>
            </form>
        </div>
        <div class="section">
            <h3>لیست کاربران</h3>
            <table id="users-table">
                <thead>
                    <tr>
                        <th>شناسه</th>
                        <th>نام کاربری</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <tr><td colspan="3">در حال بارگذاری کاربران...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // تنظیمات Supabase
            const supabaseUrl = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            let users = [];

            async function loadUsers() {
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .neq('role', 'admin');

                    if (error) throw error;

                    users = data || [];
                    renderUsers();
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('خطا در بارگذاری کاربران');
                }
            }

            function renderUsers() {
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">هیچ کاربری ثبت نشده است.</td></tr>';
                    return;
                }

                users.forEach(user => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>
                                <button class="op-btn edit-btn" onclick="editUser('${user.id}')">ویرایش</button>
                                <button class="op-btn delete-btn" onclick="deleteUser('${user.id}')">حذف</button>
                            </td>
                        </tr>
                    `;
                });
            }

            // افزودن کاربر جدید
            document.getElementById('add-user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;

                if (!username || !password) return;

                try {
                    const { data, error } = await supabase
                        .from('users')
                        .insert([{ username, password }]);

                    if (error) throw error;

                    await loadUsers();
                    this.reset();
                    alert('کاربر با موفقیت اضافه شد');
                } catch (error) {
                    console.error('Error adding user:', error);
                    alert('خطا در افزودن کاربر');
                }
            });

            // حذف کاربر
            window.deleteUser = async function(id) {
                if (!confirm('آیا مطمئن هستید؟')) return;

                try {
                    const { error } = await supabase
                        .from('users')
                        .delete()
                        .eq('id', id)
                        .neq('role', 'admin');

                    if (error) throw error;

                    await loadUsers();
                    alert('کاربر با موفقیت حذف شد');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('خطا در حذف کاربر');
                }
            };

            // ویرایش کاربر
            window.editUser = async function(id) {
                const newUsername = prompt('نام کاربری جدید:');
                if (!newUsername) return;

                try {
                    const { error } = await supabase
                        .from('users')
                        .update({ username: newUsername })
                        .eq('id', id)
                        .neq('role', 'admin');

                    if (error) throw error;

                    await loadUsers();
                    alert('کاربر با موفقیت ویرایش شد');
                } catch (error) {
                    console.error('Error updating user:', error);
                    alert('خطا در ویرایش کاربر');
                }
            };

            // حذف همه کاربران
            document.getElementById('delete-all-users').addEventListener('click', async function() {
                if (!confirm('آیا مطمئن هستید که می‌خواهید همه کاربران را حذف کنید؟')) return;

                try {
                    const { error } = await supabase
                        .from('users')
                        .delete()
                        .neq('role', 'admin');

                    if (error) throw error;

                    await loadUsers();
                    alert('همه کاربران با موفقیت حذف شدند');
                } catch (error) {
                    console.error('Error deleting all users:', error);
                    alert('خطا در حذف کاربران');
                }
            });

            // وارد کردن از اکسل
            document.getElementById('import-users').addEventListener('click', async function() {
                const fileInput = document.getElementById('excel-upload');
                const file = fileInput.files[0];

                if (!file) {
                    alert('لطفاً یک فایل انتخاب کنید');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (jsonData.length === 0) {
                            alert('فایل خالی است!');
                            return;
                        }

                        const { error } = await supabase
                            .from('users')
                            .insert(jsonData);

                        if (error) throw error;

                        await loadUsers();
                        fileInput.value = '';
                        alert('کاربران با موفقیت اضافه شدند');
                    } catch (error) {
                        console.error('Error importing users:', error);
                        alert('خطا در وارد کردن کاربران');
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // دانلود نمونه اکسل
            document.getElementById('download-sample').addEventListener('click', function(e) {
                e.preventDefault();
                const data = [
                    ["username", "password"],
                    ["user1", "12345"],
                    ["user2", "abcde"]
                ];
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "UsersSample");
                XLSX.writeFile(wb, "users_sample.xlsx");
            });

            // بارگذاری اولیه
            loadUsers();
        });
    </script>
</body>
</html>

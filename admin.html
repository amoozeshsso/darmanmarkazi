<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل مدیریت کاربران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; margin-bottom: 30px; }
    .container { max-width: 1000px; margin: auto; }
    table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #2c3e50; color: #fff; font-weight: bold; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f7ef; }
    .action-column { min-width: 150px; }
    button { 
      padding: 8px 15px; 
      margin: 2px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    .add-btn { background: #27ae60; color: #fff; width: 100%; font-size: 16px; }
    .edit-btn { background: #2980b9; color: #fff; }
    .delete-btn { background: #c0392b; color: #fff; }
    #formBox { 
      background: #fff; 
      padding: 25px;
      border-radius: 8px; 
      box-shadow: 0 3px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    label { display: block; margin-top: 15px; color: #444; font-weight: bold; }
    input { 
      width: 100%; 
      padding: 12px;
      margin: 8px 0; 
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }
    input:focus { 
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52,152,219,0.3);
    }
    #loading { 
      display: none; 
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
    }
    .spinner { 
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: auto;
      margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #error, #success { 
      display: none;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }
    #error { background: rgba(231,76,60,0.9); color: #fff; }
    #success { background: rgba(46,204,113,0.9); color: #fff; }
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .file-input-wrapper {
      margin: 20px 0;
      padding: 15px;
      border: 2px dashed #ddd;
      border-radius: 4px;
      text-align: center;
    }
    .last-update {
      text-align: left;
      color: #666;
      font-size: 0.9em;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>پنل مدیریت کاربران</h1>
    <div id="formBox">
      <div class="file-input-wrapper">
        <label for="excelFile">بارگذاری فایل اکسل کاربران:</label>
        <button type="button" id="downloadSampleUserExcel" class="add-btn" style="background:#27ae60;margin:10px 0;width:100%;font-size:15px;">
          دانلود نمونه فایل اکسل کاربران
        </button>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-top:10px;" />
        <button type="button" id="importBtn" class="add-btn">وارد کردن کاربران</button>
      </div>

      <button type="button" id="deleteAllUsersBtn" class="delete-btn" style="width:100%;font-size:16px;margin:20px 0;">
        حذف همه کاربران غیرادمین
      </button>

      <h3 id="formTitle">افزودن کاربر جدید</h3>
      <form id="userForm">
        <input type="hidden" id="editId" />
        <label for="username">نام کاربری:</label>
        <input type="text" id="username" required placeholder="نام کاربری را وارد کنید" />
        <label for="password">رمز عبور:</label>
        <input type="password" id="password" placeholder="رمز عبور را وارد کنید" />
        <button type="submit" id="submitBtn" class="add-btn" style="margin-top:20px;">ذخیره</button>
      </form>
      <div id="error"></div>
      <div id="success"></div>
    </div>

    <div id="loading">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>نام کاربری</th>
          <th class="action-column">عملیات</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="3">در حال بارگذاری کاربران...</td></tr>
      </tbody>
    </table>

    <div class="last-update" id="lastUpdate"></div>
  </div>

 <!-- Keep all your existing HTML and CSS code, just update the script section: -->

<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Initialize system info
  const SYSTEM_INFO = {
    currentUser: 'amoozeshsso',
    lastUpdate: '2025-05-25 16:41:53',
    timezone: 'UTC'
  };

  // Supabase configuration with proper credentials
  const SUPABASE_CONFIG = {
    url: 'https://qdccjbakfuywvdqfcoyg.supabase.co',
    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU'
  };

  // Initialize Supabase client
  const supabase = window.supabase.createClient(
    SUPABASE_CONFIG.url,
    SUPABASE_CONFIG.key
  );

  // Connection status tracking
  const updateConnectionStatus = (status, message) => {
    const statusElement = document.getElementById('connectionStatus') || (() => {
      const el = document.createElement('div');
      el.id = 'connectionStatus';
      el.style.position = 'fixed';
      el.style.bottom = '10px';
      el.style.right = '10px';
      el.style.padding = '8px 15px';
      el.style.borderRadius = '4px';
      el.style.fontSize = '14px';
      el.style.zIndex = '1000';
      document.body.appendChild(el);
      return el;
    })();

    statusElement.style.backgroundColor = status ? '#27ae60' : '#e74c3c';
    statusElement.style.color = '#fff';
    statusElement.textContent = message;
  };

  // Test connection and initialize
  try {
    const { data, error } = await supabase
      .from('users')
      .select('count', { count: 'exact', head: true })
      .eq('role', 'user');

    if (error) throw error;
    updateConnectionStatus(true, 'اتصال برقرار است');
    console.log('Connected to Supabase successfully');
  } catch (err) {
    updateConnectionStatus(false, 'خطا در اتصال به سرور');
    console.error('Connection error:', err);
  }

  // Utility functions
  const utils = {
    formatDate: (date) => {
      return new Date(date).toLocaleString('fa-IR');
    },
    showLoading: (show) => {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    },
    showMessage: (type, message, duration = 5000) => {
      const element = document.getElementById(type);
      if (!element) return;
      
      element.textContent = message;
      element.style.display = 'block';
      
      if (type === 'success') {
        document.getElementById('error').style.display = 'none';
      } else {
        document.getElementById('success').style.display = 'none';
      }

      setTimeout(() => {
        element.style.display = 'none';
      }, duration);
    }
  };

  // Load users function with retry mechanism
  const loadUsers = async (retries = 3) => {
    utils.showLoading(true);
    
    for (let i = 0; i < retries; i++) {
      try {
        const { data, error } = await supabase
          .from('users')
          .select('id, username')
          .eq('role', 'user')
          .order('id');

        if (error) throw error;

        const userList = document.getElementById('userList');
        userList.innerHTML = data.length ? data.map(user => `
          <tr>
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>
              <button class="edit-btn" data-id="${user.id}" data-username="${user.username}">ویرایش</button>
              <button class="delete-btn" data-id="${user.id}">حذف</button>
            </td>
          </tr>
        `).join('') : '<tr><td colspan="3">کاربری یافت نشد</td></tr>';

        document.getElementById('lastUpdate').textContent = 
          `آخرین به‌روزرسانی: ${utils.formatDate(new Date())}`;
        
        break;
      } catch (err) {
        console.error(`Attempt ${i + 1} failed:`, err);
        if (i === retries - 1) {
          utils.showMessage('error', 'خطا در بارگذاری اطلاعات');
          document.getElementById('userList').innerHTML = 
            '<tr><td colspan="3">خطا در دریافت اطلاعات</td></tr>';
        } else {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }
    
    utils.showLoading(false);
  };

  // Handle form submission
  document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = {
      username: document.getElementById('username').value.trim(),
      password: document.getElementById('password').value,
      role: 'user',
      editId: document.getElementById('editId').value
    };

    if (!formData.username || (!formData.editId && !formData.password)) {
      return utils.showMessage('error', 'لطفاً تمام فیلدهای ضروری را پر کنید');
    }

    utils.showLoading(true);
    try {
      if (formData.editId) {
        const updateData = { username: formData.username };
        if (formData.password) updateData.password = formData.password;
        
        const { error } = await supabase
          .from('users')
          .update(updateData)
          .eq('id', formData.editId);
        
        if (error) throw error;
        utils.showMessage('success', 'کاربر با موفقیت ویرایش شد');
      } else {
        const { error } = await supabase
          .from('users')
          .insert([{ 
            username: formData.username,
            password: formData.password,
            role: 'user'
          }]);
        
        if (error) throw error;
        utils.showMessage('success', 'کاربر جدید با موفقیت اضافه شد');
      }

      e.target.reset();
      document.getElementById('editId').value = '';
      document.getElementById('formTitle').textContent = 'افزودن کاربر جدید';
      document.getElementById('submitBtn').textContent = 'ذخیره';
      await loadUsers();
    } catch (err) {
      utils.showMessage('error', err.message || 'خطا در ذخیره اطلاعات');
    } finally {
      utils.showLoading(false);
    }
  });

  // Initialize the application
  await loadUsers();
});
</script>
</body>
</html>

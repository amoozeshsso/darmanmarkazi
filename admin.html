<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل مدیریت کاربران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Tahoma;
      background: #f8f8f8;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #333;
      text-align: center;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    th {
      background: #2c3e50;
      color: white;
      padding: 12px;
      text-align: center;
    }
    td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #e9f7ef;
    }
    button {
      padding: 8px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      opacity: 0.8;
    }
    .add-btn {
      background: #27ae60;
      color: white;
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }
    .edit-btn {
      background: #2980b9;
      color: white;
    }
    .delete-btn {
      background: #c0392b;
      color: white;
    }
    #formBox {
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      max-width: 600px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    input,
    select {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input:focus,
    select:focus {
      border-color: #3498db;
      outline: none;
    }
    label {
      display: block;
      margin-top: 10px;
      color: #555;
      font-weight: bold;
    }
    #error,
    #success {
      margin-top: 15px;
      text-align: center;
      padding: 10px;
      border-radius: 4px;
    }
    #error {
      color: white;
      background-color: rgba(231, 76, 60, 0.8);
    }
    #success {
      color: white;
      background-color: rgba(46, 204, 113, 0.8);
    }
    .loading {
      text-align: center;
      margin: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .action-column {
      min-width: 150px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>مدیریت کاربران</h1>
    
    <div id="formBox">
      <h3 id="formTitle">افزودن کاربر جدید</h3>
      <form id="userForm">
        <input type="hidden" id="editId" />
        
        <label for="username">نام کاربری:</label>
        <input type="text" id="username" placeholder="نام کاربری را وارد کنید" required />
        
        <label for="password">رمز عبور:</label>
        <input type="password" id="password" placeholder="رمز عبور را وارد کنید" />
        
        <label for="role">نقش:</label>
        <select id="role" required>
          <option value="">انتخاب کنید</option>
          <option value="admin">ادمین</option>
          <option value="user">کاربر</option>
        </select>
        
        <div style="margin-top: 20px;">
          <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
        </div>
        
        <div id="error" style="display: none;"></div>
        <div id="success" style="display: none;"></div>
      </form>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>نام کاربری</th>
          <th>نقش</th>
          <th class="action-column">عملیات</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr>
          <td colspan="4">در حال بارگذاری کاربران...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    // کلاس مدیریت ذخیره‌سازی کاربران در LocalStorage
    class UserStorage {
      constructor() {
        this.storageKey = 'admin_users';
        this.users = this.loadUsers();
      }
      
      loadUsers() {
        try {
          const storedUsers = localStorage.getItem(this.storageKey);
          if (storedUsers) {
            return JSON.parse(storedUsers);
          }
          const defaultUsers = [
            { id: 1, username: 'admin', password: 'admin123', role: 'admin' },
            { id: 2, username: 'user1', password: 'user123', role: 'user' }
          ];
          this.saveUsers(defaultUsers);
          return defaultUsers;
        } catch (error) {
          console.error('Error loading users from storage:', error);
          return [];
        }
      }
      
      saveUsers(users) {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(users));
          this.users = users;
        } catch (error) {
          console.error('Error saving users to storage:', error);
          throw new Error('خطا در ذخیره‌سازی داده‌ها');
        }
      }
      
      getAllUsers() {
        return [...this.users];
      }
      
      getUserById(id) {
        return this.users.find(user => user.id === id) || null;
      }
      
      addUser(userData) {
        if (this.users.some(user => user.username === userData.username)) {
          throw new Error('این نام کاربری قبلاً استفاده شده است');
        }
        const maxId = this.users.reduce((max, user) => Math.max(max, user.id), 0);
        const newUser = { id: maxId + 1, ...userData };
        this.users.push(newUser);
        this.saveUsers(this.users);
        return newUser;
      }
      
      updateUser(id, userData) {
        id = Number(id);
        const index = this.users.findIndex(user => user.id === id);
        if (index === -1) {
          throw new Error('کاربر یافت نشد');
        }
        if (userData.username !== this.users[index].username && 
            this.users.some(user => user.id !== id && user.username === userData.username)) {
          throw new Error('این نام کاربری قبلاً استفاده شده است');
        }
        if (!userData.password) {
          userData.password = this.users[index].password;
        }
        this.users[index] = { ...this.users[index], ...userData };
        this.saveUsers(this.users);
        return this.users[index];
      }
      
      deleteUser(id) {
        id = Number(id);
        const index = this.users.findIndex(user => user.id === id);
        if (index === -1) {
          throw new Error('کاربر یافت نشد');
        }
        this.users.splice(index, 1);
        this.saveUsers(this.users);
        return true;
      }
    }

    const userStorage = new UserStorage();

    document.addEventListener('DOMContentLoaded', () => {
      initApp();
    });

    const initApp = () => {
      try {
        loadUsers();
        setupFormHandler();
        showSuccess('سیستم با موفقیت بارگذاری شد');
        setTimeout(hideMessages, 2000);
      } catch (error) {
        console.error('Error initializing app:', error);
        showError('خطا در راه‌اندازی برنامه: ' + error.message);
      }
    };

    const loadUsers = () => {
      setLoading(true);
      try {
        const users = userStorage.getAllUsers();
        renderUsers(users);
      } catch (error) {
        console.error('Error loading users:', error);
        showError('خطا در بارگذاری کاربران: ' + error.message);
        document.getElementById('userList').innerHTML = `<tr><td colspan="4">خطا در بارگذاری اطلاعات</td></tr>`;
      } finally {
        setLoading(false);
      }
    };

    const renderUsers = (users) => {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      if (!users || users.length === 0) {
        userList.innerHTML = `<tr><td colspan="4">هیچ کاربری یافت نشد</td></tr>`;
        return;
      }
      users.sort((a, b) => a.id - b.id);
      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.id}</td>
          <td>${escapeHTML(user.username)}</td>
          <td>${user.role === 'admin' ? 'ادمین' : 'کاربر'}</td>
          <td class="action-column">
            <button class="edit-btn" onclick="handleEdit(${user.id})">ویرایش</button>
            <button class="delete-btn" onclick="handleDelete(${user.id})">حذف</button>
          </td>
        `;
        userList.appendChild(row);
      });
    };

    const escapeHTML = (str) => {
      if (!str) return '';
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const setupFormHandler = () => {
      const form = document.getElementById('userForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        if (!username) {
          showError('لطفاً نام کاربری را وارد کنید');
          return;
        }
        if (!editId && !password) {
          showError('لطفاً رمز عبور را وارد کنید');
          return;
        }
        if (!role) {
          showError('لطفاً نقش کاربر را انتخاب کنید');
          return;
        }

        setLoading(true);
        try {
          if (editId) {
            const updateData = { username, role };
            if (password) {
              updateData.password = password;
            }
            userStorage.updateUser(editId, updateData);
            showSuccess('کاربر با موفقیت به‌روز شد');
          } else {
            userStorage.addUser({ username, password, role });
            showSuccess('کاربر جدید با موفقیت ایجاد شد');
          }
          resetForm();
          loadUsers();
        } catch (error) {
          console.error('Error saving user:', error);
          showError(error.message);
        } finally {
          setLoading(false);
        }
      });
    };

    const setLoading = (isLoading) => {
      document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
      document.querySelectorAll('button').forEach(btn => btn.disabled = isLoading);
    };

    const handleEdit = (id) => {
      try {
        const user = userStorage.getUserById(Number(id));
        if (!user) {
          showError('کاربر مورد نظر یافت نشد');
          return;
        }
        document.getElementById('formTitle').textContent = 'ویرایش کاربر';
        document.getElementById('editId').value = user.id;
        document.getElementById('username').value = user.username;
        document.getElementById('password').value = '';
        document.getElementById('role').value = user.role;
        document.getElementById('submitBtn').textContent = 'به‌روزرسانی';
        document.getElementById('formBox').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error in edit handler:', error);
        showError('خطا: ' + error.message);
      }
    };

    const handleDelete = (id) => {
      if (!confirm('آیا از حذف این کاربر اطمینان دارید؟')) return;
      setLoading(true);
      try {
        userStorage.deleteUser(Number(id));
        showSuccess('کاربر با موفقیت حذف شد');
        loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        showError('خطا در حذف کاربر: ' + error.message);
      } finally {
        setLoading(false);
      }
    };

    const hideMessages = () => {
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
    };

    const showError = (message) => {
      displayMessage('error', message, 5000);
    };

    const showSuccess = (message) => {
      displayMessage('success', message, 3000);
    };

    const displayMessage = (type, message, duration) => {
      const errorEl = document.getElementById('error');
      const successEl = document.getElementById('success');
      if (type === 'error') {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        successEl.style.display = 'none';
        setTimeout(() => errorEl.style.display = 'none', duration);
      } else {
        successEl.textContent = message;
        successEl.style.display = 'block';
        errorEl.style.display = 'none';
        setTimeout(() => successEl.style.display = 'none', duration);
      }
    };

    const resetForm = () => {
      document.getElementById('formTitle').textContent = 'افزودن کاربر جدید';
      document.getElementById('editId').value = '';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('role').value = '';
      document.getElementById('submitBtn').textContent = 'ذخیره';
    };
  </script>
</body>
</html>

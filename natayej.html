<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>پنل مدیریت آزمون‌ها</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; direction: rtl; text-align: center; }
    table { border-collapse: collapse; width: 95%; margin: 15px auto; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f0f0f0; }
    tr:nth-child(even) { background: #fafafa; }
    .buttons { margin: 10px; }
  </style>
</head>
<body>

  <h2>🔹 نتایج آزمون‌ها</h2>

  <select id="examSelect" onchange="loadResultsForSelectedExam()">
    <option value="">-- انتخاب آزمون --</option>
  </select>

  <div id="msg" style="margin:10px;color:red"></div>
  <table id="resultsTable"></table>

  <div class="buttons">
    <button id="downloadBtn" style="display:none" onclick="downloadExcel()">📥 دانلود اکسل</button>
    <button id="deleteAllBtn" style="display:none" onclick="deleteAllResults()">🗑 حذف همه</button>
  </div>

  <script>
  // ====== تنظیم Supabase ======
  const supabase = window.supabase.createClient(
    "https://qdccjbakfuywvdqfcoyg.supabase.co",
    "public-anon-key"
  );

  let currentExamTitle = "";
  let currentPassMark = 0;
  let currentExamId = null;
  let userMap = {};
  let resultsSummary = [];
  let filteredResults = [];

  // ====== بارگذاری اولیه ======
  window.onload = async function() {
    await loadExams();
    await loadUserMap();
  };

  async function loadExams() {
    const { data, error } = await supabase.from("exams").select("id, title, pass_mark").order("id", { ascending: false });
    if (error) { alert("خطا در دریافت لیست آزمون‌ها"); return; }

    const sel = document.getElementById("examSelect");
    data.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e.title;
      opt.dataset.pass = e.pass_mark;
      sel.appendChild(opt);
    });
  }

  async function loadUserMap() {
    const users = await fetchAll("users", "id, username");
    userMap = {};
    users.forEach(u => userMap[u.id] = u.username);
  }

  async function fetchAll(table, columns) {
    let all = [];
    let from = 0;
    const step = 1000;
    while (true) {
      const { data, error } = await supabase.from(table).select(columns).range(from, from + step - 1);
      if (error) break;
      all = all.concat(data);
      if (data.length < step) break;
      from += step;
    }
    return all;
  }

  async function loadResultsForSelectedExam() {
    const sel = document.getElementById("examSelect");
    const examId = sel.value;
    const examTitle = sel.options[sel.selectedIndex].text;
    const passMark = sel.options[sel.selectedIndex].dataset.pass;
    await loadResults(examId, examTitle, passMark);
  }

  async function loadResults(examId, examTitle, passMark) {
    document.getElementById('msg').textContent = '';
    document.getElementById('resultsTable').innerHTML = '';
    document.getElementById('downloadBtn').style.display = "none";
    document.getElementById('deleteAllBtn').style.display = "none";
    if (!examId) return;
    currentExamTitle = examTitle;
    currentPassMark = Number(passMark) || 0;
    currentExamId = Number(examId);

    // گام ۱: کاربران مجاز آزمون
    const examUsers = await fetchAll("exam_users", "user_id, exam_id");
    const allowedUserIds = examUsers.filter(eu => eu.exam_id === currentExamId).map(u => u.user_id);

    if (allowedUserIds.length === 0) {
      document.getElementById('msg').textContent = 'هیچ کاربری برای این آزمون تعریف نشده است.';
      return;
    }

    // گام ۲: دریافت نتایج واقعی فقط برای کاربران مجاز
    const allResults = await fetchAll("exam_results", "exam_id, user_id, score");
    const results = allResults.filter(r => r.exam_id === currentExamId && allowedUserIds.includes(r.user_id));

    // گام ۳: ترکیب کاربران مجاز و نتایج
    const userStats = {};
    allowedUserIds.forEach(uid => {
      userStats[uid] = { count: 0, maxScore: 0 };
    });

    results.forEach(row => {
      if (!userStats[row.user_id]) userStats[row.user_id] = { count: 0, maxScore: 0 };
      userStats[row.user_id].count++;
      if (row.score > userStats[row.user_id].maxScore) {
        userStats[row.user_id].maxScore = row.score;
      }
    });

    resultsSummary = Object.keys(userStats).map(user_id => {
      const username = userMap[user_id] || 'نامشخص';
      const count = userStats[user_id].count;
      const maxScore = userStats[user_id].maxScore;
      const status = maxScore >= currentPassMark ? 'قبول' : 'رد';
      return { username, user_id, count, maxScore, status };
    });

    // 🔹 مرتب‌سازی بر اساس نمره از بیشترین به کمترین
    resultsSummary.sort((a, b) => b.maxScore - a.maxScore);

    filteredResults = resultsSummary.slice();
    renderResultsTable(filteredResults);
    document.getElementById('downloadBtn').style.display = "inline-block";
    document.getElementById('deleteAllBtn').style.display = "inline-block";
  }

  function renderResultsTable(list) {
    const tbl = document.getElementById("resultsTable");
    tbl.innerHTML = `
      <tr>
        <th>ردیف</th>
        <th>نام کاربر</th>
        <th>شناسه</th>
        <th>تعداد دفعات شرکت</th>
        <th>بیشترین نمره</th>
        <th>وضعیت</th>
      </tr>
      ${list.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${r.username}</td>
          <td>${r.user_id}</td>
          <td>${r.count}</td>
          <td>${r.maxScore}</td>
          <td>${r.status}</td>
        </tr>
      `).join('')}
    `;
  }

  function downloadExcel() {
    let csv = "ردیف,نام کاربر,شناسه,تعداد دفعات,بیشترین نمره,وضعیت\n";
    filteredResults.forEach((r, i) => {
      csv += `${i + 1},${r.username},${r.user_id},${r.count},${r.maxScore},${r.status}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = currentExamTitle + ".csv";
    link.click();
  }

  async function deleteAllResults() {
    if (!confirm("آیا از حذف همه نتایج این آزمون مطمئن هستید؟")) return;
    const { error } = await supabase.from("exam_results").delete().eq("exam_id", currentExamId);
    if (error) alert("خطا در حذف نتایج.");
    else loadResults(currentExamId, currentExamTitle, currentPassMark);
  }

  </script>
</body>
</html>

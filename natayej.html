<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>مشاهده نتایج آزمون — پنل مدیریت</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- xlsx for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Choices.js برای انتخاب زیبا -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <!-- فونت -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #4e54c8; --danger: #e74c3c; --ok: #27ae60; --muted:#6b7280; }
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background:#f8f9fb; margin:0; padding:20px; direction:rtl; }
    .container { max-width:900px; margin:24px auto; background:white; border-radius:12px; padding:22px; box-shadow:0 6px 24px rgba(10,10,20,0.06); }
    h1 { margin:0 0 14px 0; text-align:center; color:#222; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    label { font-weight:600; margin-left:8px; color:var(--muted); font-family: 'Vazirmatn', Tahoma, sans-serif; }
    select, input[type="text"] { 
      padding:8px 10px; 
      border-radius:8px; 
      border:1px solid #d1d5db; 
      background:#fbfdff; 
      min-width:220px; 
      font-size:0.98rem; 
      font-family: 'Vazirmatn', Tahoma, sans-serif; 
    }
    .search-input { flex:1; width:500px; }
    .btn { 
      padding:8px 14px; 
      border-radius:8px; 
      border:none; 
      cursor:pointer; 
      font-weight:600; 
      font-family: 'Vazirmatn', Tahoma, sans-serif; 
    }
    .btn-primary { background:var(--accent); color:white; }
    .btn-danger { background:var(--danger); color:white; }
    .btn-ghost { background:transparent; border:1px solid #e5e7eb; color:#111; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .stat { background:#f1f5f9; padding:8px 12px; border-radius:8px; font-size:0.95rem; color:#111; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    table { width:100%; border-collapse:collapse; margin-top:16px; font-size:0.95rem; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    th, td { padding:10px 8px; border:1px solid #e6e9ef; text-align:center; }
    th { background:#eef2ff; color:#26304a; font-weight:700; }
    tr:nth-child(even) td { background:#fbfdff; }
    .small { font-size:0.86rem; color:var(--muted); font-family: 'Vazirmatn', Tahoma, sans-serif; }
    .action-btn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    .delete-btn { background:var(--danger); color:white; }
    .remove-btn { background:#ff7a59; color:white; }
    .attempt-list { text-align:left; padding:10px; background:#fffefa; border:1px dashed #f3e8d7; border-radius:8px; margin-top:8px; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    .muted { color:var(--muted); }
    .center { text-align:center; }
    .msg { margin-top:12px; color:#b35c00; text-align:center; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    @media (max-width:720px) { 
      .controls { flex-direction:column; align-items:stretch } 
      select, .search-input { width:100% } 
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="admin_exam.html" class="small" style="text-decoration:none;color:var(--accent); font-family: 'Vazirmatn', Tahoma, sans-serif;">← بازگشت به منوی مدیریت</a>
    <h1>مشاهده نتایج آزمون</h1>

    <div class="controls" style="flex-direction: column; gap: 8px;">
      <div>
        <label for="examSelect">انتخاب آزمون:</label><br>
        <select id="examSelect"><option value="">-- آزمون را انتخاب کنید --</option></select>
      </div>

      <div>
        <label for="searchInput">جستجو (نام کاربری):</label><br>
        <input id="searchInput" class="search-input" type="text" placeholder="نام کاربری را وارد کنید...">
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center; margin-top: 8px;">
      <button id="downloadBtn" class="btn btn-primary" style="display:none;">دانلود اکسل (دو ستون)</button>
      <button id="deleteAllResultsBtn" class="btn btn-danger" style="display:none;">حذف همه نتایج</button>
    </div>

    <div class="stats" id="statsArea" style="display:none;">
      <div class="stat" id="stat_total">کل کاربران مجاز: <strong>0</strong></div>
      <div class="stat" id="stat_participants">شرکت‌کنندگان: <strong>0</strong></div>
      <div class="stat" id="stat_avg">میانگین نمره: <strong>0</strong></div>
    </div>

    <div id="resultsTable"></div>
    <div class="msg" id="msg"></div>
  </div>

<script>
/*
  نسخهٔ کامل و جامع:
  - بارگذاری صفحه‌ای (paged) برای دور زدن محدودیت 1000 رکورد Supabase
  - نمایش تمام کاربران مجاز از exam_users حتی اگر شرکت نکرده باشند (نمره = 0)
  - نمایش تعداد دفعات شرکت، بیشترین نمره، وضعیت
  - مرتب‌سازی بر اساس بیشترین نمره (نزولی)
  - حذف تک‌تک رکوردها، حذف همه نتایج
  - خروجی اکسل فقط دو ستون: "کد پرسنلی / کد ملی" و "نمره"
*/

/* ---- کانفیگ Supabase (اگه خواستی عوضش کن) ---- */
const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---- متغیرهای سراسری ---- */
let userMap = {};           // نگاشت user_id => username (یا کد ملی)
let resultsSummary = [];    // آرایه‌ای از نتایج نهایی (هر کاربر: count, maxScore, ids)
let filteredResults = [];   // نتایجی که پس از جستجو نمایش داده می‌شوند
let allExamUsers = [];      // رکوردهای exam_users برای آزمون فعلی
let allExamResults = [];    // رکوردهای exam_results برای آزمون فعلی
let currentExamId = null;
let currentExamTitle = "";
let currentPassMark = 0;

/* ---- المان‌های DOM ---- */
const examSelect = document.getElementById('examSelect');
const searchInput = document.getElementById('searchInput');
const resultsTable = document.getElementById('resultsTable');
const msgBox = document.getElementById('msg');
const downloadBtn = document.getElementById('downloadBtn');
const deleteAllResultsBtn = document.getElementById('deleteAllResultsBtn');
const statTotal = document.getElementById('stat_total');
const statParticipants = document.getElementById('stat_participants');
const statAvg = document.getElementById('stat_avg');
const statsArea = document.getElementById('statsArea');

/* ---- مقدار اولیه/رویدادها ---- */
window.onload = async () => {
  await loadUserMap();     // بارگذاری تمام کاربران (صفحه‌ای)
  await loadExams();       // بارگذاری لیست آزمون‌ها
  // فعال‌سازی Choices.js برای select
  new Choices('#examSelect', { searchEnabled: true, shouldSort: false, itemSelectText: '' });
  // رویداد جستجو
  searchInput.addEventListener('input', e => filterResultsByUsername(e.target.value));
  // دکمه‌ها
  downloadBtn.addEventListener('click', downloadExcelTwoColumns);
  deleteAllResultsBtn.addEventListener('click', deleteAllResults);
};

/* ====================== توابع کمکی ====================== */

async function fetchAllPaged(table, columns, applyFilter = null) {
  const pageSize = 1000;
  let from = 0;
  let all = [];
  while (true) {
    try {
      let query = supabase.from(table).select(columns).range(from, from + pageSize - 1);
      if (applyFilter) query = applyFilter(query);
      const { data, error } = await query;
      if (error) {
        console.error(`خطا در خواندن جدول ${table}:`, error);
        msgBox.textContent = 'خطا در ارتباط با سرور (لطفاً تنظیمات Supabase را بررسی کنید).';
        break;
      }
      if (!data || data.length === 0) break;
      all.push(...data);
      if (data.length < pageSize) break;
      from += pageSize;
    } catch (e) {
      console.error('exception in fetchAllPaged', e);
      break;
    }
  }
  return all;
}

/* ====================== بارگذاری اولیه داده‌ها ====================== */

async function loadUserMap() {
  userMap = {};
  const users = await fetchAllPaged('users', 'id, username');
  users.forEach(u => {
    userMap[u.id] = u.username ?? String(u.id);
  });
  console.log('userMap loaded:', Object.keys(userMap).length);
}

async function loadExams() {
  msgBox.textContent = '';
  const { data: exams, error } = await supabase.from('exams').select('id, title, pass_mark').order('id', { ascending: false });
  if (error) {
    console.error('خطا در loadExams:', error);
    msgBox.textContent = 'خطا در دریافت لیست آزمون‌ها';
    return;
  }
  examSelect.innerHTML = '<option value="">-- آزمون را انتخاب کنید --</option>';
  exams?.forEach(ex => {
    const opt = document.createElement('option');
    opt.value = ex.id;
    opt.textContent = ex.title || `آزمون ${ex.id}`;
    opt.dataset.passmark = ex.pass_mark ?? 0;
    examSelect.appendChild(opt);
  });
  examSelect.onchange = async () => {
    const sel = examSelect.options[examSelect.selectedIndex];
    const pass = sel?.dataset?.passmark ?? 0;
    await loadResults(sel.value, sel.textContent, pass);
  };
}

/* ====================== بارگذاری نتایج آزمون ====================== */

async function loadResults(examId, examTitle, passMark) {
  msgBox.textContent = '';
  resultsTable.innerHTML = '';
  downloadBtn.style.display = 'none';
  deleteAllResultsBtn.style.display = 'none';
  statsArea.style.display = 'none';

  if (!examId) return;
  currentExamId = Number(examId);
  currentExamTitle = examTitle;
  currentPassMark = Number(passMark) || 0;

  allExamUsers = await fetchAllPaged('exam_users', 'id, exam_id, user_id', q => q.eq('exam_id', currentExamId));
  if (!allExamUsers || allExamUsers.length === 0) {
    msgBox.textContent = 'هیچ کاربری برای این آزمون تعریف نشده است.';
    resultsSummary = [];
    filteredResults = [];
    renderResultsTable([]);
    return;
  }
  const allowedUserIds = allExamUsers.map(r => r.user_id);

  allExamResults = await fetchAllPaged('exam_results', 'id, exam_id, user_id, score, submitted_at', q => q.eq('exam_id', currentExamId));

  const userStats = {};
  allowedUserIds.forEach(uid => { userStats[uid] = { count: 0, maxScore: 0, ids: [] }; });

  allExamResults.forEach(row => {
    const uid = row.user_id;
    if (!userStats[uid]) userStats[uid] = { count: 0, maxScore: 0, ids: [] };
    userStats[uid].count++;
    if (typeof row.score === 'number' && row.score > userStats[uid].maxScore) userStats[uid].maxScore = row.score;
    userStats[uid].ids.push({ id: row.id, score: row.score, submitted_at: row.submitted_at });
  });

  resultsSummary = Object.keys(userStats).map(uid => {
    const u = userMap[uid] ?? 'نامشخص';
    const count = userStats[uid].count || 0;
    const maxScore = userStats[uid].maxScore || 0;
    const status = maxScore >= currentPassMark ? 'قبول' : 'رد';
    const ids = userStats[uid].ids || [];
    return { username: u, user_id: uid, count, maxScore, status, ids };
  });

  resultsSummary.sort((a,b) => b.maxScore - a.maxScore);
  filteredResults = resultsSummary.slice();

  const totalAllowed = resultsSummary.length;
  const participants = resultsSummary.filter(r => r.count > 0).length;
  const avg = (() => {
    const arr = resultsSummary.filter(r => r.count > 0).map(r => r.maxScore);
    if (arr.length === 0) return 0;
    return Math.round((arr.reduce((s,x)=>s+x,0)/arr.length)*100)/100;
  })();
  statTotal.querySelector('strong').textContent = totalAllowed;
  statParticipants.querySelector('strong').textContent = participants;
  statAvg.querySelector('strong').textContent = avg;
  statsArea.style.display = 'flex';

  renderResultsTable(filteredResults);

  downloadBtn.style.display = 'inline-block';
  deleteAllResultsBtn.style.display = 'inline-block';
}

/* ====================== نمایش جدول و جزئیات ====================== */

function renderResultsTable(list) {
  if (!list || list.length === 0) {
    resultsTable.innerHTML = '<p class="center muted">نتیجه‌ای یافت نشد.</p>';
    return;
  }

  let html = `<table>
    <thead>
      <tr>
        <th>ردیف</th>
        <th>نام کاربری<br><span class="small muted">(کد پرسنلی/کد ملی)</span></th>
        <th>تعداد دفعات شرکت</th>
        <th>بیشترین نمره</th>
        <th>وضعیت</th>
        <th>جزئیات/عملیات</th>
      </tr>
    </thead>
    <tbody>
  `;

  list.forEach((r, i) => {
    const color = r.status === 'قبول' ? 'color:'+ 'var(--ok)' : 'color:var(--danger)';
    const attemptsCount = r.count || 0;
    const detailsId = `attempts-${r.user_id}`;
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(r.username)}</td>
        <td>${attemptsCount}</td>
        <td>${r.maxScore}</td>
        <td style="${color}; font-weight:700">${r.status}</td>
        <td>
          <button class="action-btn btn-ghost" onclick="toggleAttempts('${detailsId}')">مشاهده جزئیات</button>
          <button class="action-btn delete-btn" onclick="confirmDeleteUserResults('${r.user_id}')">حذف نتایج</button>
        </td>
      </tr>
      <tr id="${detailsId}" style="display:none;">
        <td colspan="6">
          ${ renderAttemptsList(r) }
        </td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  resultsTable.innerHTML = html;
}

/* helper: HTML برای لیست تلاش‌ها (attempts) برای هر کاربر */
function renderAttemptsList(r) {
  if (!r.ids || r.ids.length === 0) {
    return `<div class="attempt-list"><div class="small muted">این کاربر در این آزمون شرکت نکرده است.</div></div>`;
  }
  const attempts = r.ids.slice().sort((a,b) => {
    const ta = a.submitted_at ? new Date(a.submitted_at).getTime() : 0;
    const tb = b.submitted_at ? new Date(b.submitted_at).getTime() : 0;
    return tb - ta;
  });
  let html = `<div class="attempt-list">`;
  html += `<div class="small muted">فهرست تلاش‌ها (جدیدترین اول):</div><br>`;
  html += `<table style="width:100%;border-collapse:collapse"><thead><tr><th>آی‌دی</th><th>نمره</th><th>تاریخ</th><th>حذف</th></tr></thead><tbody>`;
  attempts.forEach(a => {
    const dateStr = a.submitted_at ? (new Date(a.submitted_at)).toLocaleString() : '-';
    html += `<tr><td>${a.id}</td><td>${a.score}</td><td>${dateStr}</td><td><button class="action-btn delete-btn" onclick="confirmDeleteAttempt(${a.id})">حذف</button></td></tr>`;
  });
  html += `</tbody></table></div>`;
  return html;
}

/* toggle نمایش جزئیات */
function toggleAttempts(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'table-row' : 'none';
}

/* ====================== جستجو/فیلتر ====================== */
function filterResultsByUsername(q) {
  q = (q || '').trim().toLowerCase();
  if (!q) {
    filteredResults = resultsSummary.slice();
  } else {
    filteredResults = resultsSummary.filter(r => (String(r.username) || '').toLowerCase().includes(q));
  }
  renderResultsTable(filteredResults);
}

/* ====================== حذف‌ها — با تأیید کاربر ====================== */

function confirmDeleteUserResults(uid) {
  if (!confirm('آیا مطمئن هستید که می‌خواهید تمام نتایج این کاربر برای این آزمون حذف شود؟ (این عمل قابل بازگشت نیست)')) return;
  deleteUserResults(uid);
}

async function deleteUserResults(uid) {
  try {
    const { error } = await supabase.from('exam_results').delete().eq('exam_id', currentExamId).eq('user_id', uid);
    if (error) {
      console.error('deleteUserResults error:', error);
      alert('خطا در حذف نتایج کاربر. کنسول را بررسی کنید.');
    } else {
      allExamResults = allExamResults.filter(r => !(r.exam_id === currentExamId && r.user_id === uid));
      await refreshAfterDataChange();
    }
  } catch (e) {
    console.error(e);
  }
}

function confirmDeleteAttempt(attemptId) {
  if (!confirm('آیا مطمئن هستید که می‌خواهید این تلاش (attempt) را حذف کنید؟')) return;
  deleteAttempt(attemptId);
}

async function deleteAttempt(attemptId) {
  try {
    const { error } = await supabase.from('exam_results').delete().eq('id', attemptId);
    if (error) {
      console.error('deleteAttempt error:', error);
      alert('خطا در حذف تلاش.');
    } else {
      allExamResults = allExamResults.filter(r => r.id !== attemptId);
      await refreshAfterDataChange();
    }
  } catch (e) {
    console.error(e);
  }
}

/* حذف همهٔ نتایج (exam_results) برای آزمون جاری */
async function deleteAllResults() {
  if (!confirm('آیا مطمئن هستید که می‌خواهید همهٔ نتایج این آزمون حذف شود؟ (این عمل قابل بازگشت نیست)')) return;
  try {
    const { error } = await supabase.from('exam_results').delete().eq('exam_id', currentExamId);
    if (error) {
      console.error('deleteAllResults error:', error);
      alert('خطا در حذف همهٔ نتایج.');
    } else {
      allExamResults = [];
      await refreshAfterDataChange();
    }
  } catch (e) {
    console.error(e);
  }
}

/* پس از هر تغییر داده، محاسبات محلی را بروز کن و جدول را دوباره بساز */
async function refreshAfterDataChange() {
  const allowedIds = allExamUsers.map(u=>u.user_id);
  const userStats = {};
  allowedIds.forEach(uid => userStats[uid] = { count:0, maxScore:0, ids:[] });
  allExamResults.forEach(r => {
    if (!userStats[r.user_id]) userStats[r.user_id] = { count:0, maxScore:0, ids:[] };
    userStats[r.user_id].count++;
    if (typeof r.score === 'number' && r.score > userStats[r.user_id].maxScore) userStats[r.user_id].maxScore = r.score;
    userStats[r.user_id].ids.push({ id:r.id, score:r.score, submitted_at:r.submitted_at });
  });

  resultsSummary = Object.keys(userStats).map(uid => {
    const u = userMap[uid] ?? 'نامشخص';
    const count = userStats[uid].count || 0;
    const maxScore = userStats[uid].maxScore || 0;
    const status = maxScore >= currentPassMark ? 'قبول' : 'رد';
    const ids = userStats[uid].ids || [];
    return { username: u, user_id: uid, count, maxScore, status, ids };
  });

  resultsSummary.sort((a,b)=> b.maxScore - a.maxScore);
  filteredResults = resultsSummary.slice();
  renderResultsTable(filteredResults);

  const totalAllowed = resultsSummary.length;
  const participants = resultsSummary.filter(r => r.count>0).length;
  const avg = (() => {
    const arr = resultsSummary.filter(r => r.count>0).map(r => r.maxScore);
    if (arr.length===0) return 0;
    return Math.round((arr.reduce((s,x)=>s+x,0)/arr.length)*100)/100;
  })();
  statTotal.querySelector('strong').textContent = totalAllowed;
  statParticipants.querySelector('strong').textContent = participants;
  statAvg.querySelector('strong').textContent = avg;
  statsArea.style.display = totalAllowed ? 'flex' : 'none';
}

/* ====================== خروجی Excel (فقط دو ستون) ====================== */

function downloadExcelTwoColumns() {
  if (!resultsSummary || resultsSummary.length === 0) return alert('هیچ داده‌ای برای خروجی وجود ندارد.');
  const rows = [['کد پرسنلی / کد ملی', 'نمره']];
  resultsSummary.forEach(r => {
    rows.push([r.username, r.maxScore]);
  });
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!sheetViews'] = [{ rightToLeft: true }];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'نتایج');
  const filename = `نتایج آزمون ${currentExamTitle || ''}.xlsx`;
  XLSX.writeFile(wb, filename);
}

/* ====================== ابزارهای کمکی ====================== */

function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
</script>
</body>
</html>




<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مشاهده نتایج آزمون</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1000px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #2c3e50; color: #fff; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f7ef; }
    button { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    .delete-btn { background: #c0392b; color: #fff; }
    .export-btn { background: #27ae60; color: #fff; }
    .delete-all-btn { background: #c0392b; color: #fff; }
    .back { margin-bottom: 18px; text-align: right; }
    .back a { background: #4e54c8; color: #fff; padding: 8px 18px; border-radius: 5px; text-decoration: none; }
    #resultsBox { margin-top: 30px; background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    #resultsBox table { margin: auto; width: 100%; }
    #resultsBox th { background: #f39c12; }
    .exam-select { width: 350px; padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #bbb; margin-bottom: 20px; }
    #error, #success { display: none; padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; }
    #error { background: rgba(231,76,60,0.8); color: #fff; }
    #success { background: rgba(46,204,113,0.8); color: #fff; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="back">
      <a href="admin_exam.html">بازگشت به منوی مدیریت</a>
    </div>
    <h1>مشاهده نتایج آزمون</h1>
    <div>
      <label for="examSelect">انتخاب آزمون:</label>
      <select id="examSelect" class="exam-select">
        <option value="">-- آزمون را انتخاب کنید --</option>
      </select>
    </div>
    <div id="resultsBox"></div>
    <div id="error"></div>
    <div id="success"></div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (sessionStorage.getItem('userRole') !== 'admin') {
        alert('شما دسترسی ادمین ندارید!');
        window.location.href = 'index.html';
      }

      const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const examSelect = document.getElementById('examSelect');
      const resultsBox = document.getElementById('resultsBox');
      const errorBox = document.getElementById('error');
      const successBox = document.getElementById('success');

      const showError = msg => { errorBox.textContent = msg; errorBox.style.display = 'block'; successBox.style.display = 'none'; };
      const showSuccess = msg => { successBox.textContent = msg; successBox.style.display = 'block'; errorBox.style.display = 'none'; };
      const hideMessages = () => { errorBox.style.display = successBox.style.display = 'none'; };

      let exams = [];
      let passMark = 0;
      let selectedExamId = null;

      // بارگذاری آزمون‌ها در سلکت
      async function loadExamOptions() {
        const { data, error } = await supabase.from('exams').select('id, title, pass_mark').order('id');
        if (error) {
          examSelect.innerHTML = '<option value="">خطا در دریافت آزمون‌ها</option>';
        } else {
          exams = data;
          examSelect.innerHTML = '<option value="">-- آزمون را انتخاب کنید --</option>' +
            data.map(exam => `<option value="${exam.id}" data-passmark="${exam.pass_mark}">${exam.title}</option>`).join('');
        }
      }

      // بارگذاری نتایج
      async function loadResults() {
        resultsBox.innerHTML = '';
        hideMessages();
        if (!selectedExamId) {
          resultsBox.innerHTML = '<p style="text-align:center;">ابتدا آزمون را انتخاب کنید.</p>';
          return;
        }
        const exam = exams.find(ex => ex.id == selectedExamId);
        passMark = exam ? exam.pass_mark : 10;

        // گرفتن نتایج کاربران
        const { data: results, error } = await supabase
          .from('results')
          .select('user_id, username, score, inserted_at')
          .eq('exam_id', selectedExamId);

        if (error) {
          showError('خطا در دریافت نتایج!');
          return;
        }
        if (!results.length) {
          resultsBox.innerHTML = '<p style="text-align:center;">هنوز کاربری در این آزمون شرکت نکرده است.</p>';
          return;
        }

        // گروه‌بندی نتایج بر اساس کاربر
        const userMap = {};
        results.forEach(r => {
          if (!userMap[r.user_id]) {
            userMap[r.user_id] = { username: r.username, maxScore: r.score, count: 1, user_id: r.user_id };
          } else {
            userMap[r.user_id].count += 1;
            if (r.score > userMap[r.user_id].maxScore) userMap[r.user_id].maxScore = r.score;
          }
        });
        const finalResults = Object.values(userMap);

        // ساخت جدول نتایج
        let table = `
        <table>
          <thead>
            <tr>
              <th>ردیف</th>
              <th>نام کاربری</th>
              <th>بیشترین نمره</th>
              <th>تعداد دفعات شرکت</th>
              <th>وضعیت</th>
              <th>عملیات</th>
            </tr>
          </thead>
          <tbody>
            ${finalResults.map((r, i) => `
              <tr>
                <td>${i + 1}</td>
                <td>${r.username}</td>
                <td>${r.maxScore}</td>
                <td>${r.count}</td>
                <td>${r.maxScore >= passMark ? 'قبول' : 'مردود'}</td>
                <td>
                  <button class="delete-user-result-btn" data-userid="${r.user_id}" data-examid="${selectedExamId}">حذف</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <button id="exportExcelBtn" class="export-btn" style="margin-top:18px;">دانلود اکسل</button>
        <button id="deleteAllResultsBtn" class="delete-all-btn" style="margin-top:18px;margin-right:8px;">حذف همه نتایج</button>
        `;
        resultsBox.innerHTML = table;

        // دکمه خروجی اکسل
        document.getElementById('exportExcelBtn').onclick = () => {
          const ws_data = [
            ['ردیف', 'نام کاربری', 'بیشترین نمره', 'تعداد دفعات شرکت', 'وضعیت'],
            ...finalResults.map((r, i) => [
              i + 1,
              r.username,
              r.maxScore,
              r.count,
              r.maxScore >= passMark ? 'قبول' : 'مردود'
            ])
          ];
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'نتایج');
          XLSX.writeFile(wb, 'exam_results.xlsx');
        };

        // دکمه حذف همه نتایج
        document.getElementById('deleteAllResultsBtn').onclick = async () => {
          if (confirm('آیا از حذف همه نتایج این آزمون مطمئن هستید؟')) {
            const { error } = await supabase.from('results').delete().eq('exam_id', selectedExamId);
            if (error) showError(error.message);
            else {
              showSuccess('همه نتایج حذف شد');
              await loadResults();
            }
          }
        };

        // دکمه حذف نتیجه هر کاربر
        Array.from(document.getElementsByClassName('delete-user-result-btn')).forEach(btn => {
          btn.onclick = async () => {
            const userId = btn.dataset.userid;
            if (confirm(`آیا از حذف همه نتایج کاربر "${userId}" در این آزمون مطمئن هستید؟`)) {
              const { error } = await supabase.from('results').delete().eq('exam_id', selectedExamId).eq('user_id', userId);
              if (error) showError(error.message);
              else {
                showSuccess('نتایج کاربر حذف شد');
                await loadResults();
              }
            }
          };
        });
      }

      // انتخاب آزمون
      examSelect.addEventListener('change', async () => {
        selectedExamId = examSelect.value;
        await loadResults();
      });

      // بارگذاری اولیه آزمون‌ها
      await loadExamOptions();
    });
  </script>
</body>
</html>

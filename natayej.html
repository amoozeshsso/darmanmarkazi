<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>مشاهده نتایج آزمون — پنل مدیریت</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #4e54c8; --danger: #e74c3c; --ok: #27ae60; --muted:#6b7280; }
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background:#f8f9fb; margin:0; padding:20px; direction:rtl; }
    .container { max-width:900px; margin:24px auto; background:white; border-radius:12px; padding:22px; box-shadow:0 6px 24px rgba(10,10,20,0.06); }
    h1 { margin:0 0 14px 0; text-align:center; color:#222; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    label { font-weight:600; margin-left:8px; color:var(--muted); }
    select, input[type="text"] { padding:10px 14px; border-radius:8px; border:1px solid #d1d5db; background:#fbfdff; min-width:220px; font-size:1rem; }
    .search-input { flex:1; min-width:220px; margin-top:8px; }
    .btn { padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary { background:var(--accent); color:white; }
    .btn-danger { background:var(--danger); color:white; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .stat { background:#f1f5f9; padding:8px 12px; border-radius:8px; font-size:0.95rem; color:#111; }
    table { width:100%; border-collapse:collapse; margin-top:16px; font-size:0.95rem; }
    th, td { padding:10px 8px; border:1px solid #e6e9ef; text-align:center; }
    th { background:#eef2ff; color:#26304a; font-weight:700; }
    tr:nth-child(even) td { background:#fbfdff; }
    .action-btn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
    .remove-btn { background:#ff7a59; color:white; }
    .muted { color:var(--muted); }
    .center { text-align:center; }
    .msg { margin-top:12px; color:#b35c00; text-align:center; }
    @media (max-width:720px){ .controls { flex-direction:column; align-items:stretch } select, .search-input { width:100% } }
  </style>
</head>
<body>
  <div class="container">
    <a href="admin_exam.html" class="small" style="text-decoration:none;color:var(--accent)">← بازگشت به منوی مدیریت</a>
    <h1>مشاهده نتایج آزمون</h1>

    <div class="controls">
      <div>
        <label for="examSelect">انتخاب آزمون:</label><br>
        <select id="examSelect"><option value="">-- آزمون را انتخاب کنید --</option></select>
      </div>
      <div style="flex:1;">
        <label for="searchInput">جستجو (نام کاربری):</label><br>
        <input id="searchInput" class="search-input" type="text" placeholder="نام کاربری را وارد کنید...">
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="downloadBtn" class="btn btn-primary" style="display:none;">دانلود اکسل (دو ستون)</button>
      </div>
    </div>

    <div class="stats" id="statsArea" style="display:none;">
      <div class="stat" id="stat_total">کل کاربران مجاز: <strong>0</strong></div>
      <div class="stat" id="stat_participants">شرکت‌کنندگان: <strong>0</strong></div>
      <div class="stat" id="stat_avg">میانگین نمره: <strong>0</strong></div>
    </div>

    <div id="resultsTable"></div>
    <div class="msg" id="msg"></div>
  </div>

<script>
const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userMap = {};
let resultsSummary = [];
let filteredResults = [];
let allExamUsers = [];
let allExamResults = [];
let currentExamId = null;
let currentExamTitle = "";
let currentPassMark = 0;

const examSelect = document.getElementById('examSelect');
const searchInput = document.getElementById('searchInput');
const resultsTable = document.getElementById('resultsTable');
const msgBox = document.getElementById('msg');
const downloadBtn = document.getElementById('downloadBtn');
const statTotal = document.getElementById('stat_total');
const statParticipants = document.getElementById('stat_participants');
const statAvg = document.getElementById('stat_avg');
const statsArea = document.getElementById('statsArea');

window.onload = async () => {
  await loadUserMap();
  await loadExams();
  new Choices('#examSelect', { searchEnabled: true, shouldSort: false, itemSelectText: '' });
  searchInput.addEventListener('input', e => filterResultsByUsername(e.target.value));
  downloadBtn.addEventListener('click', downloadExcelTwoColumns);
};

async function fetchAllPaged(table, columns, applyFilter = null) {
  const pageSize = 1000;
  let from = 0;
  let all = [];
  while (true) {
    let query = supabase.from(table).select(columns).range(from, from + pageSize - 1);
    if (applyFilter) query = applyFilter(query);
    const { data, error } = await query;
    if (error) { console.error(error); break; }
    if (!data || data.length === 0) break;
    all.push(...data);
    if (data.length < pageSize) break;
    from += pageSize;
  }
  return all;
}

async function loadUserMap() {
  userMap = {};
  const users = await fetchAllPaged('users', 'id, username');
  users.forEach(u => { userMap[u.id] = u.username ?? String(u.id); });
}

async function loadExams() {
  msgBox.textContent = '';
  const { data: exams, error } = await supabase.from('exams').select('id, title, pass_mark').order('id', { ascending: false });
  if (error) { msgBox.textContent = 'خطا در دریافت لیست آزمون‌ها'; return; }
  examSelect.innerHTML = '<option value="">-- آزمون را انتخاب کنید --</option>';
  exams?.forEach(ex => {
    const opt = document.createElement('option');
    opt.value = ex.id;
    opt.textContent = ex.title || `آزمون ${ex.id}`;
    opt.dataset.passmark = ex.pass_mark ?? 0;
    examSelect.appendChild(opt);
  });
  examSelect.onchange = async () => {
    const sel = examSelect.options[examSelect.selectedIndex];
    const pass = sel?.dataset?.passmark ?? 0;
    await loadResults(sel.value, sel.textContent, pass);
  };
}

async function loadResults(examId, examTitle, passMark) {
  msgBox.textContent = '';
  resultsTable.innerHTML = '';
  downloadBtn.style.display = 'none';
  statsArea.style.display = 'none';
  if (!examId) return;
  currentExamId = Number(examId);
  currentExamTitle = examTitle;
  currentPassMark = Number(passMark) || 0;

  allExamUsers = await fetchAllPaged('exam_users', 'id, exam_id, user_id', q => q.eq('exam_id', currentExamId));
  if (!allExamUsers || allExamUsers.length === 0) { msgBox.textContent = 'هیچ کاربری برای این آزمون تعریف نشده است.'; return; }
  const allowedUserIds = allExamUsers.map(r => r.user_id);

  allExamResults = await fetchAllPaged('exam_results', 'id, exam_id, user_id, score, submitted_at', q => q.eq('exam_id', currentExamId));

  const userStats = {};
  allowedUserIds.forEach(uid => { userStats[uid] = { count: 0, maxScore: 0, ids: [] }; });
  allExamResults.forEach(row => {
    const uid = row.user_id;
    if (!userStats[uid]) userStats[uid] = { count: 0, maxScore: 0, ids: [] };
    userStats[uid].count++;
    if (typeof row.score === 'number' && row.score > userStats[uid].maxScore) userStats[uid].maxScore = row.score;
    userStats[uid].ids.push({ id: row.id, score: row.score, submitted_at: row.submitted_at });
  });

  resultsSummary = Object.keys(userStats).map(uid => {
    const u = userMap[uid] ?? 'نامشخص';
    const count = userStats[uid].count || 0;
    const maxScore = userStats[uid].maxScore || 0;
    return { username: u, user_id: uid, count, maxScore };
  });
  resultsSummary.sort((a,b) => b.maxScore - a.maxScore);
  filteredResults = resultsSummary.slice();

  const totalAllowed = resultsSummary.length;
  const participants = resultsSummary.filter(r => r.count > 0).length;
  const avg = (() => { const arr = resultsSummary.filter(r => r.count>0).map(r => r.maxScore); return arr.length===0?0:Math.round((arr.reduce((s,x)=>s+x,0)/arr.length)*100)/100; })();
  statTotal.querySelector('strong').textContent = totalAllowed;
  statParticipants.querySelector('strong').textContent = participants;
  statAvg.querySelector('strong').textContent = avg;
  statsArea.style.display = 'flex';

  renderResultsTable(filteredResults);
  downloadBtn.style.display = 'inline-block';
}

function renderResultsTable(list) {
  if (!list || list.length===0) { resultsTable.innerHTML='<p class="center muted">نتیجه‌ای یافت نشد.</p>'; return; }
  let html = `<table>
    <thead>
      <tr>
        <th>ردیف</th>
        <th>نام کاربری<br><span class="small muted">(کد پرسنلی/کد ملی)</span></th>
        <th>بیشترین نمره</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody>`;
  list.forEach((r,i)=>{
    html+=`<tr>
      <td>${i+1}</td>
      <td>${escapeHtml(r.username)}</td>
      <td>${r.maxScore}</td>
      <td><button class="action-btn remove-btn" onclick="confirmRemoveUserFromExam('${r.user_id}')">حذف از آزمون</button></td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  resultsTable.innerHTML = html;
}

function filterResultsByUsername(q) {
  q = (q||'').trim().toLowerCase();
  filteredResults = !q ? resultsSummary.slice() : resultsSummary.filter(r => (String(r.username)||'').toLowerCase().includes(q));
  renderResultsTable(filteredResults);
}

function confirmRemoveUserFromExam(uid) {
  if (!confirm('آیا مطمئن هستید که می‌خواهید این کاربر را از لیست مجاز این آزمون حذف کنید؟')) return;
  removeUserFromExam(uid);
}

async function removeUserFromExam(uid) {
  try {
    const { error } = await supabase.from('exam_users').delete().eq('exam_id', currentExamId).eq('user_id', uid);
    if (error) { alert('خطا در حذف کاربر از آزمون.'); return; }
    allExamUsers = allExamUsers.filter(r => r.user_id != uid);
    refreshAfterDataChange();
  } catch(e) { console.error(e); }
}

async function refreshAfterDataChange() {
  const allowedIds = allExamUsers.map(u=>u.user_id);
  const userStats = {};
  allowedIds.forEach(uid => userStats[uid] = { count:0, maxScore:0, ids:[] });
  allExamResults.forEach(r => { if (!userStats[r.user_id]) userStats[r.user_id]={count:0,maxScore:0,ids:[]}; userStats[r.user_id].count++; if(r.score>userStats[r.user_id].maxScore) userStats[r.user_id].maxScore=r.score; userStats[r.user_id].ids.push(r); });
  resultsSummary = Object.keys(userStats).map(uid=>({ username:userMap[uid]||'نامشخص', user_id:uid, count:userStats[uid].count, maxScore:userStats[uid].maxScore }));
  resultsSummary.sort((a,b)=>b.maxScore - a.maxScore);
  filteredResults = resultsSummary.slice();
  const totalAllowed = resultsSummary.length;
  const participants = resultsSummary.filter(r=>r.count>0).length;
  const avg = (()=>{ const arr = resultsSummary.filter(r=>r.count>0).map(r=>r.maxScore); return arr.length===0?0:Math.round(arr.reduce((s,x)=>s+x,0)/arr.length*100)/100; })();
  statTotal.querySelector('strong').textContent=totalAllowed;
  statParticipants.querySelector('strong').textContent=participants;
  statAvg.querySelector('strong').textContent=avg;
  renderResultsTable(filteredResults);
}

function downloadExcelTwoColumns() {
  if (!filteredResults || filteredResults.length===0) return;
  const wb = XLSX.utils.book_new();
  const ws_data = filteredResults.map(r=>[r.username, r.maxScore]);
  ws_data.unshift(['کد پرسنلی/کد ملی','نمره']);
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, 'نتایج');
  XLSX.writeFile(wb, `Exam_${currentExamTitle}_TwoColumns.xlsx`);
}

function escapeHtml(text) { return (text+'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' })[m]); }
</script>
</body>
</html>

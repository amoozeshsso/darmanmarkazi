<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مشاهده نتایج آزمون</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            background: #f8f8f8;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 700px;
            margin: 30px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 28px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4e54c8;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.01rem;
            transition: color 0.2s;
        }
        .back-link:hover {
            color: #1c5980;
            text-decoration: underline;
        }
        .select-label {
            font-size: 1.05rem;
            margin-left: 10px;
        }
        select {
            font-family: inherit;
            font-size: 1.01rem;
            padding: 7px 12px;
            border-radius: 6px;
            border: 1px solid #bbb;
            background: #f4f6fb;
            margin-bottom: 20px;
            min-width: 180px;
        }
        .search-input {
            width: 100%;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 7px;
            border-radius: 6px;
            border: 1px solid #bbb;
            font-size: 1.01rem;
            font-family: inherit;
            box-sizing: border-box;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 28px;
            background: #fcfcfc;
        }
        th, td {
            border: 1px solid #d6d6d6;
            padding: 8px 6px;
            text-align: center;
        }
        th {
            background: #e3eafc;
            color: #2d3a4b;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #f4f6fb;
        }
        .download-btn {
            margin-top: 18px;
            padding: 8px 26px;
            background: #4e54c8;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .download-btn:hover {
            background: #1c5980;
        }
        .delete-btn {
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            padding: 3px 8px;
            cursor: pointer;
            margin: 0 2px;
            transition: background 0.2s;
        }
        .delete-btn:hover {
            background: #c0392b;
        }
        .delete-all-btn {
            margin-top: 18px;
            padding: 8px 26px;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-block;
        }
        .delete-all-btn:hover {
            background: #c0392b;
        }
        .msg {
            margin-top: 30px;
            color: #b35c00;
            font-size: 1.04rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="admin_exam.html" class="back-link">بازگشت به منوی مدیریت</a>
        <h1>مشاهده نتایج آزمون</h1>
        <label class="select-label" for="examSelect">انتخاب آزمون:</label>
        <select id="examSelect">
            <option value="">-- آزمون را انتخاب کنید --</option>
        </select>
        <!-- کادر جستجو برای نام کاربری -->
        <input type="text" id="searchInput" class="search-input" placeholder="جستجو بر اساس نام کاربری...">
        <button class="download-btn" onclick="downloadExcel()" style="display:none;" id="downloadBtn">دانلود اکسل نتایج</button>
        <div id="resultsTable"></div>
        <button class="delete-all-btn" style="display:none;" id="deleteAllBtn" onclick="deleteAllResults()">حذف همه نتایج این آزمون</button>
        <div class="msg" id="msg"></div>
    </div>

    <script>
    // تنظیمات Supabase
    const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDU5MzMxNDAsImV4cCI6MjAyMTUwOTE0MH0.ZkG9S7VO2Mk0nEMXqhBvcmowL8kGyPpNZ2HMrbbOGCA';
    
    // ایجاد کلاینت Supabase با تنظیمات صحیح
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
            autoRefreshToken: true,
            persistSession: true
        }
    });

    let userMap = {};
    let resultsSummary = [];
    let filteredResults = [];
    let currentExamTitle = "";
    let currentPassMark = 0;
    let currentExamId = null;
    let allResults = [];

    window.onload = async () => {
        try {
            await loadUserMap();
            await loadExams();
            document.getElementById('searchInput').addEventListener('input', function() {
                filterResultsByUsername(this.value);
            });
        } catch (error) {
            console.error("Error in initialization:", error);
            document.getElementById('msg').textContent = 'خطا در بارگذاری اطلاعات. لطفاً صفحه را مجدداً بارگذاری کنید.';
        }
    };

    async function loadUserMap() {
        try {
            const { data: users, error } = await supabase
                .from('users')
                .select('id, username');

            if (error) {
                console.error("Error loading users:", error);
                throw error;
            }

            console.log("Loading users...");
            console.log("Users loaded:", users?.length);
            
            userMap = {};
            if (users && users.length > 0) {
                users.forEach(u => {
                    if (u.id && u.username) {
                        userMap[String(u.id)] = u.username;
                    }
                });
            }
            
            console.log("UserMap size:", Object.keys(userMap).length);
            console.log("First few users in map:", Object.entries(userMap).slice(0, 3));
        } catch (error) {
            console.error("Error in loadUserMap:", error);
            throw error;
        }
    }

    async function loadExams() {
        try {
            const { data: exams, error } = await supabase
                .from('exams')
                .select('id, title, pass_mark')
                .order('id', { ascending: false });

            if (error) {
                console.error("Error loading exams:", error);
                throw error;
            }
            
            const select = document.getElementById('examSelect');
            select.innerHTML = '<option value="">-- آزمون را انتخاب کنید --</option>';
            
            if (exams && exams.length > 0) {
                exams.forEach(exam => {
                    const opt = document.createElement('option');
                    opt.value = exam.id;
                    opt.textContent = exam.title;
                    opt.setAttribute('data-passmark', exam.pass_mark || 0);
                    select.appendChild(opt);
                });
            }
            
            select.onchange = () => {
                const passMark = select.options[select.selectedIndex].getAttribute('data-passmark');
                loadResults(select.value, select.options[select.selectedIndex].textContent, passMark);
            };
        } catch (error) {
            console.error("Error in loadExams:", error);
            document.getElementById('msg').textContent = 'خطا در بارگذاری لیست آزمون‌ها';
        }
    }

    async function loadResults(examId, examTitle, passMark) {
        try {
            document.getElementById('msg').textContent = '';
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('downloadBtn').style.display = "none";
            document.getElementById('deleteAllBtn').style.display = "none";
            
            if (!examId) return;
            
            currentExamTitle = examTitle;
            currentPassMark = Number(passMark) || 0;
            currentExamId = Number(examId);

            const { data: results, error } = await supabase
                .from('exam_results')
                .select('id, user_id, score')
                .eq('exam_id', Number(examId));

            if (error) {
                console.error("Error loading results:", error);
                throw error;
            }

            console.log("Loading results for exam:", examId);
            console.log("Results count:", results?.length);

            allResults = results || [];

            if (!results || results.length === 0) {
                document.getElementById('msg').textContent = 'نتیجه‌ای برای این آزمون یافت نشد.';
                resultsSummary = [];
                filteredResults = [];
                renderResultsTable(filteredResults);
                return;
            }

            const userStats = {};
            results.forEach(row => {
                const cleanUserId = String(row.user_id);
                if (!userStats[cleanUserId]) {
                    userStats[cleanUserId] = {
                        count: 0,
                        maxScore: 0,
                        ids: []
                    };
                }
                userStats[cleanUserId].count++;
                if (row.score > userStats[cleanUserId].maxScore) {
                    userStats[cleanUserId].maxScore = row.score;
                }
                userStats[cleanUserId].ids.push(row.id);
            });

            console.log("Processing user stats...");
            console.log("UserStats:", userStats);
            
            resultsSummary = Object.keys(userStats).map(user_id => {
                const username = userMap[user_id];
                console.log(`Processing user ${user_id}: username = ${username}`);
                
                return {
                    username: username || 'نامشخص',
                    user_id,
                    count: userStats[user_id].count,
                    maxScore: userStats[user_id].maxScore,
                    status: userStats[user_id].maxScore >= currentPassMark ? 'قبول' : 'رد',
                    ids: userStats[user_id].ids
                };
            });

            filteredResults = resultsSummary.slice();
            renderResultsTable(filteredResults);
            document.getElementById('downloadBtn').style.display = "inline-block";
            document.getElementById('deleteAllBtn').style.display = "inline-block";
        } catch (error) {
            console.error("Error in loadResults:", error);
            document.getElementById('msg').textContent = 'خطا در بارگذاری نتایج';
        }
    }

    // ... بقیه توابع بدون تغییر ...
    
</script>
</body>
</html>

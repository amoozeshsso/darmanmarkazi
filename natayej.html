<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; direction: rtl; text-align: center; }
    table { border-collapse: collapse; width: 95%; margin: 15px auto; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f0f0f0; }
    tr:nth-child(even) { background: #fafafa; }
    .buttons { margin: 10px; }
  </style>
</head>
<body>

  <h2>ğŸ”¹ Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h2>

  <select id="examSelect" onchange="loadResultsForSelectedExam()">
    <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† --</option>
  </select>

  <div id="msg" style="margin:10px;color:red"></div>
  <table id="resultsTable"></table>

  <div class="buttons">
    <button id="downloadBtn" style="display:none" onclick="downloadExcel()">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„</button>
    <button id="deleteAllBtn" style="display:none" onclick="deleteAllResults()">ğŸ—‘ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
  </div>

  <script>
  // ====== ØªÙ†Ø¸ÛŒÙ… Supabase ======
  const supabase = window.supabase.createClient(
    "https://qdccjbakfuywvdqfcoyg.supabase.co",
    "public-anon-key"
  );

  let currentExamTitle = "";
  let currentPassMark = 0;
  let currentExamId = null;
  let userMap = {};
  let resultsSummary = [];
  let filteredResults = [];

  // ====== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ======
  window.onload = async function() {
    await loadExams();
    await loadUserMap();
  };

  async function loadExams() {
    const { data, error } = await supabase.from("exams").select("id, title, pass_mark").order("id", { ascending: false });
    if (error) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§"); return; }

    const sel = document.getElementById("examSelect");
    data.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e.title;
      opt.dataset.pass = e.pass_mark;
      sel.appendChild(opt);
    });
  }

  async function loadUserMap() {
    const users = await fetchAll("users", "id, username");
    userMap = {};
    users.forEach(u => userMap[u.id] = u.username);
  }

  async function fetchAll(table, columns) {
    let all = [];
    let from = 0;
    const step = 1000;
    while (true) {
      const { data, error } = await supabase.from(table).select(columns).range(from, from + step - 1);
      if (error) break;
      all = all.concat(data);
      if (data.length < step) break;
      from += step;
    }
    return all;
  }

  async function loadResultsForSelectedExam() {
    const sel = document.getElementById("examSelect");
    const examId = sel.value;
    const examTitle = sel.options[sel.selectedIndex].text;
    const passMark = sel.options[sel.selectedIndex].dataset.pass;
    await loadResults(examId, examTitle, passMark);
  }

  async function loadResults(examId, examTitle, passMark) {
    document.getElementById('msg').textContent = '';
    document.getElementById('resultsTable').innerHTML = '';
    document.getElementById('downloadBtn').style.display = "none";
    document.getElementById('deleteAllBtn').style.display = "none";
    if (!examId) return;
    currentExamTitle = examTitle;
    currentPassMark = Number(passMark) || 0;
    currentExamId = Number(examId);

    // Ú¯Ø§Ù… Û±: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¬Ø§Ø² Ø¢Ø²Ù…ÙˆÙ†
    const examUsers = await fetchAll("exam_users", "user_id, exam_id");
    const allowedUserIds = examUsers.filter(eu => eu.exam_id === currentExamId).map(u => u.user_id);

    if (allowedUserIds.length === 0) {
      document.getElementById('msg').textContent = 'Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
      return;
    }

    // Ú¯Ø§Ù… Û²: Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬ ÙˆØ§Ù‚Ø¹ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¬Ø§Ø²
    const allResults = await fetchAll("exam_results", "exam_id, user_id, score");
    const results = allResults.filter(r => r.exam_id === currentExamId && allowedUserIds.includes(r.user_id));

    // Ú¯Ø§Ù… Û³: ØªØ±Ú©ÛŒØ¨ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¬Ø§Ø² Ùˆ Ù†ØªØ§ÛŒØ¬
    const userStats = {};
    allowedUserIds.forEach(uid => {
      userStats[uid] = { count: 0, maxScore: 0 };
    });

    results.forEach(row => {
      if (!userStats[row.user_id]) userStats[row.user_id] = { count: 0, maxScore: 0 };
      userStats[row.user_id].count++;
      if (row.score > userStats[row.user_id].maxScore) {
        userStats[row.user_id].maxScore = row.score;
      }
    });

    resultsSummary = Object.keys(userStats).map(user_id => {
      const username = userMap[user_id] || 'Ù†Ø§Ù…Ø´Ø®Øµ';
      const count = userStats[user_id].count;
      const maxScore = userStats[user_id].maxScore;
      const status = maxScore >= currentPassMark ? 'Ù‚Ø¨ÙˆÙ„' : 'Ø±Ø¯';
      return { username, user_id, count, maxScore, status };
    });

    // ğŸ”¹ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡ Ø§Ø² Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¨Ù‡ Ú©Ù…ØªØ±ÛŒÙ†
    resultsSummary.sort((a, b) => b.maxScore - a.maxScore);

    filteredResults = resultsSummary.slice();
    renderResultsTable(filteredResults);
    document.getElementById('downloadBtn').style.display = "inline-block";
    document.getElementById('deleteAllBtn').style.display = "inline-block";
  }

  function renderResultsTable(list) {
    const tbl = document.getElementById("resultsTable");
    tbl.innerHTML = `
      <tr>
        <th>Ø±Ø¯ÛŒÙ</th>
        <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±</th>
        <th>Ø´Ù†Ø§Ø³Ù‡</th>
        <th>ØªØ¹Ø¯Ø§Ø¯ Ø¯ÙØ¹Ø§Øª Ø´Ø±Ú©Øª</th>
        <th>Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù†Ù…Ø±Ù‡</th>
        <th>ÙˆØ¶Ø¹ÛŒØª</th>
      </tr>
      ${list.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${r.username}</td>
          <td>${r.user_id}</td>
          <td>${r.count}</td>
          <td>${r.maxScore}</td>
          <td>${r.status}</td>
        </tr>
      `).join('')}
    `;
  }

  function downloadExcel() {
    let csv = "Ø±Ø¯ÛŒÙ,Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±,Ø´Ù†Ø§Ø³Ù‡,ØªØ¹Ø¯Ø§Ø¯ Ø¯ÙØ¹Ø§Øª,Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù†Ù…Ø±Ù‡,ÙˆØ¶Ø¹ÛŒØª\n";
    filteredResults.forEach((r, i) => {
      csv += `${i + 1},${r.username},${r.user_id},${r.count},${r.maxScore},${r.status}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = currentExamTitle + ".csv";
    link.click();
  }

  async function deleteAllResults() {
    if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù‡Ù…Ù‡ Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
    const { error } = await supabase.from("exam_results").delete().eq("exam_id", currentExamId);
    if (error) alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù†ØªØ§ÛŒØ¬.");
    else loadResults(currentExamId, currentExamTitle, currentPassMark);
  }

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مدیریت نتایج آزمون</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
  font-family: sans-serif;
  background: #f3f4f6;
  margin: 30px;
  direction: rtl;
}
button {
  background: #4f46e5;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  margin: 6px 0;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: #fff;
}
th, td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: center;
}
th {
  background: #e5e7eb;
}
</style>
</head>
<body>

<h2>📋 نتایج آزمون‌ها</h2>

<label>انتخاب آزمون:</label>
<select id="examSelect" onchange="loadResults(this.value)">
  <option value="">-- انتخاب آزمون --</option>
</select>

<p id="msg" style="color:red;"></p>
<table id="resultsTable"></table>
<button id="downloadBtn" style="display:none;" onclick="downloadExcel()">📥 خروجی اکسل</button>

<script>
const supabase = window.supabase.createClient(
  "https://qdccjbakfuywvdqfcoyg.supabase.co",
  "PASTE-YOUR-ANON-KEY-HERE"
);

let currentExamId = null;
let currentPassMark = 0;
let currentExamTitle = "";
let resultsSummary = [];
let userMap = {};

document.addEventListener("DOMContentLoaded", loadExams);

async function loadExams() {
  document.getElementById('msg').textContent = '';
  const { data, error } = await supabase.from('exams').select('id, title, pass_mark').order('id', { ascending: true });
  if (error) {
    document.getElementById('msg').textContent = 'خطا در دریافت لیست آزمون‌ها';
    console.error(error);
    return;
  }
  const examSelect = document.getElementById('examSelect');
  data.forEach(exam => {
    const opt = document.createElement('option');
    opt.value = exam.id;
    opt.textContent = exam.title;
    opt.dataset.pass = exam.pass_mark;
    examSelect.appendChild(opt);
  });
}

async function loadResults(examId) {
  const examSelect = document.getElementById("examSelect");
  const examOption = examSelect.options[examSelect.selectedIndex];
  currentExamTitle = examOption.textContent;
  currentPassMark = Number(examOption.dataset.pass) || 0;
  currentExamId = Number(examId);

  if (!examId) return;

  document.getElementById('msg').textContent = '';
  document.getElementById('resultsTable').innerHTML = '';
  document.getElementById('downloadBtn').style.display = "none";

  // مرحله ۱: دریافت کاربران مجاز
  const examUsers = await fetchAllRows("exam_users", "user_id", q => q.eq("exam_id", examId));
  const allowedUserIds = examUsers.map(u => u.user_id);

  if (!allowedUserIds.length) {
    document.getElementById('msg').textContent = 'هیچ کاربری برای این آزمون تعریف نشده است.';
    return;
  }

  // مرحله ۲: دریافت نتایج کاربران (در چند مرحله برای بیش از 1000)
  const results = await fetchAllRows("exam_results", "user_id, score", q =>
    q.eq("exam_id", examId).in("user_id", allowedUserIds)
  );

  // مرحله ۳: ساخت نقشه کاربران برای نمایش نام
  const users = await fetchAllRows("users", "id, national_id", q => q.in("id", allowedUserIds));
  userMap = {};
  users.forEach(u => userMap[u.id] = u.national_id || u.id);

  // مرحله ۴: ترکیب نتایج
  const userStats = {};
  allowedUserIds.forEach(uid => userStats[uid] = { maxScore: 0 });
  results.forEach(r => {
    if (r.score > userStats[r.user_id].maxScore)
      userStats[r.user_id].maxScore = r.score;
  });

  resultsSummary = Object.keys(userStats).map(uid => ({
    username: userMap[uid] || uid,
    user_id: uid,
    score: userStats[uid].maxScore || 0
  }));

  // مرتب‌سازی از بیشترین نمره به کمترین
  resultsSummary.sort((a, b) => b.score - a.score);

  renderResultsTable(resultsSummary);
  document.getElementById('downloadBtn').style.display = "inline-block";
}

// 🔁 تابع کمکی برای دریافت بیش از 1000 رکورد
async function fetchAllRows(table, columns, filterFn) {
  const allRows = [];
  let from = 0, to = 999;
  while (true) {
    let query = supabase.from(table).select(columns).range(from, to);
    if (filterFn) query = filterFn(query);
    const { data, error } = await query;
    if (error) {
      console.error("Error fetching from", table, error);
      break;
    }
    if (!data || data.length === 0) break;
    allRows.push(...data);
    if (data.length < 1000) break;
    from += 1000; to += 1000;
  }
  return allRows;
}

function renderResultsTable(data) {
  const table = document.getElementById('resultsTable');
  if (!data.length) {
    table.innerHTML = '<tr><td>هیچ نتیجه‌ای یافت نشد</td></tr>';
    return;
  }
  let html = `<tr><th>کد پرسنلی / کد ملی</th><th>نمره</th></tr>`;
  data.forEach(row => {
    html += `<tr>
      <td>${row.username}</td>
      <td>${row.score}</td>
    </tr>`;
  });
  table.innerHTML = html;
}

function downloadExcel() {
  const wsData = [["کد پرسنلی / کد ملی", "نمره"]];
  resultsSummary.forEach(r => {
    wsData.push([r.username, r.score]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "نتایج");
  XLSX.writeFile(wb, "نتایج_" + currentExamTitle + ".xlsx");
}
</script>
</body>
</html>

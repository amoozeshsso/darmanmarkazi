<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¯ÛŒØ±ÛŒØª Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
  font-family: sans-serif;
  background: #f3f4f6;
  margin: 30px;
  direction: rtl;
}
button {
  background: #4f46e5;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  margin: 6px 0;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: #fff;
}
th, td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: center;
}
th {
  background: #e5e7eb;
}
</style>
</head>
<body>

<h2>ğŸ“‹ Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h2>

<label>Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ†:</label>
<select id="examSelect" onchange="loadResults(this.value)">
  <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† --</option>
</select>

<p id="msg" style="color:red;"></p>
<table id="resultsTable"></table>
<button id="downloadBtn" style="display:none;" onclick="downloadExcel()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>

<script>
const supabase = window.supabase.createClient(
  "https://qdccjbakfuywvdqfcoyg.supabase.co",
  "PASTE-YOUR-ANON-KEY-HERE"
);

let currentExamId = null;
let currentPassMark = 0;
let currentExamTitle = "";
let resultsSummary = [];
let userMap = {};

document.addEventListener("DOMContentLoaded", loadExams);

async function loadExams() {
  document.getElementById('msg').textContent = '';
  const { data, error } = await supabase.from('exams').select('id, title, pass_mark').order('id', { ascending: true });
  if (error) {
    document.getElementById('msg').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§';
    console.error(error);
    return;
  }
  const examSelect = document.getElementById('examSelect');
  data.forEach(exam => {
    const opt = document.createElement('option');
    opt.value = exam.id;
    opt.textContent = exam.title;
    opt.dataset.pass = exam.pass_mark;
    examSelect.appendChild(opt);
  });
}

async function loadResults(examId) {
  const examSelect = document.getElementById("examSelect");
  const examOption = examSelect.options[examSelect.selectedIndex];
  currentExamTitle = examOption.textContent;
  currentPassMark = Number(examOption.dataset.pass) || 0;
  currentExamId = Number(examId);

  if (!examId) return;

  document.getElementById('msg').textContent = '';
  document.getElementById('resultsTable').innerHTML = '';
  document.getElementById('downloadBtn').style.display = "none";

  // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¬Ø§Ø²
  const examUsers = await fetchAllRows("exam_users", "user_id", q => q.eq("exam_id", examId));
  const allowedUserIds = examUsers.map(u => u.user_id);

  if (!allowedUserIds.length) {
    document.getElementById('msg').textContent = 'Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
    return;
  }

  // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø¯Ø±ÛŒØ§ÙØª Ù†ØªØ§ÛŒØ¬ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø¯Ø± Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒØ´ Ø§Ø² 1000)
  const results = await fetchAllRows("exam_results", "user_id, score", q =>
    q.eq("exam_id", examId).in("user_id", allowedUserIds)
  );

  // Ù…Ø±Ø­Ù„Ù‡ Û³: Ø³Ø§Ø®Øª Ù†Ù‚Ø´Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù…
  const users = await fetchAllRows("users", "id, national_id", q => q.in("id", allowedUserIds));
  userMap = {};
  users.forEach(u => userMap[u.id] = u.national_id || u.id);

  // Ù…Ø±Ø­Ù„Ù‡ Û´: ØªØ±Ú©ÛŒØ¨ Ù†ØªØ§ÛŒØ¬
  const userStats = {};
  allowedUserIds.forEach(uid => userStats[uid] = { maxScore: 0 });
  results.forEach(r => {
    if (r.score > userStats[r.user_id].maxScore)
      userStats[r.user_id].maxScore = r.score;
  });

  resultsSummary = Object.keys(userStats).map(uid => ({
    username: userMap[uid] || uid,
    user_id: uid,
    score: userStats[uid].maxScore || 0
  }));

  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø§Ø² Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù†Ù…Ø±Ù‡ Ø¨Ù‡ Ú©Ù…ØªØ±ÛŒÙ†
  resultsSummary.sort((a, b) => b.score - a.score);

  renderResultsTable(resultsSummary);
  document.getElementById('downloadBtn').style.display = "inline-block";
}

// ğŸ” ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¨ÛŒØ´ Ø§Ø² 1000 Ø±Ú©ÙˆØ±Ø¯
async function fetchAllRows(table, columns, filterFn) {
  const allRows = [];
  let from = 0, to = 999;
  while (true) {
    let query = supabase.from(table).select(columns).range(from, to);
    if (filterFn) query = filterFn(query);
    const { data, error } = await query;
    if (error) {
      console.error("Error fetching from", table, error);
      break;
    }
    if (!data || data.length === 0) break;
    allRows.push(...data);
    if (data.length < 1000) break;
    from += 1000; to += 1000;
  }
  return allRows;
}

function renderResultsTable(data) {
  const table = document.getElementById('resultsTable');
  if (!data.length) {
    table.innerHTML = '<tr><td>Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
    return;
  }
  let html = `<tr><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ / Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ù†Ù…Ø±Ù‡</th></tr>`;
  data.forEach(row => {
    html += `<tr>
      <td>${row.username}</td>
      <td>${row.score}</td>
    </tr>`;
  });
  table.innerHTML = html;
}

function downloadExcel() {
  const wsData = [["Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ / Ú©Ø¯ Ù…Ù„ÛŒ", "Ù†Ù…Ø±Ù‡"]];
  resultsSummary.forEach(r => {
    wsData.push([r.username, r.score]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªØ§ÛŒØ¬");
  XLSX.writeFile(wb, "Ù†ØªØ§ÛŒØ¬_" + currentExamTitle + ".xlsx");
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مدیریت آزمون‌ها</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ترتیب صحیح بارگذاری -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@0.1.8/dist/persian-date.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <!-- SheetJS برای خروجی xlsx -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Tahoma; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1100px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #2c3e50; color: #fff; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f7ef; }
    button { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    .add-btn { background: #27ae60; color: #fff; width: 100%; font-size: 16px; }
    .edit-btn { background: #2980b9; color: #fff; }
    .delete-btn { background: #c0392b; color: #fff; }
    .result-btn { background: #f39c12; color: #fff; }
    .questions-btn { background: #16a085; color: #fff; }
    #formBox { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    label { display: block; margin-top: 10px; color: #555; font-weight: bold; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    input:focus, textarea:focus { outline: none; border-color: #3498db; }
    #loading { display: none; text-align: center; margin: 20px 0; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #error, #success { display: none; padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; }
    #error { background: rgba(231,76,60,0.8); color: #fff; }
    #success { background: rgba(46,204,113,0.8); color: #fff; }
    .back { margin-bottom: 18px; text-align: right; }
    .back a { background: #4e54c8; color: #fff; padding: 8px 18px; border-radius: 5px; text-decoration: none; }
    #resultsBox { margin-top: 30px; background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    #resultsBox table { margin: auto; width: 90%; }
    #resultsBox th { background: #f39c12; }
  </style>
</head>
<body>
  <div class="container">
    <div class="back">
      <a href="admin-dashboard.html">بازگشت به داشبورد ادمین</a>
    </div>
    <h1>مدیریت آزمون‌ها</h1>
    <div id="formBox">
      <h3 id="formTitle">افزودن آزمون جدید</h3>
      <form id="examForm" autocomplete="off">
        <input type="hidden" id="editId" />
        <label for="title">عنوان آزمون:</label>
        <input type="text" id="title" required />
        <label for="maxAttempts">تعداد دفعات مجاز شرکت در آزمون:</label>
        <input type="number" id="maxAttempts" min="1" max="20" value="1" required />
        <label for="durationMinutes">مدت زمان آزمون (دقیقه):</label>
        <input type="number" id="durationMinutes" min="1" max="300" value="20" required />
        <label for="startAt">تاریخ و ساعت شروع آزمون:</label>
        <input type="text" id="startAt" class="jalali-picker" required autocomplete="off" placeholder="انتخاب از تقویم" readonly />
        <label for="endAt">تاریخ و ساعت پایان آزمون (اختیاری):</label>
        <input type="text" id="endAt" class="jalali-picker" autocomplete="off" placeholder="انتخاب از تقویم" readonly />
        <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
      </form>
      <div id="error"></div>
      <div id="success"></div>
    </div>
    <div id="loading">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>عنوان آزمون</th>
          <th>تعداد دفعات مجاز</th>
          <th>مدت آزمون (دقیقه)</th>
          <th>شروع</th>
          <th>پایان</th>
          <th>تاریخ ایجاد</th>
          <th>فعال؟</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="examList">
        <tr><td colspan="9">در حال بارگذاری آزمون‌ها...</td></tr>
      </tbody>
    </table>
    <div id="resultsBox" style="display:none;"></div>
  </div>
  <script>
    // راه‌اندازی تقویم شمسی بازشو فقط با انتخاب (تایپ غیرفعال)
    $(function() {
      $('.jalali-picker').persianDatepicker({
        format: 'YYYY/MM/DD HH:mm',
        timePicker: { enabled: true },
        initialValue: false,
        autoClose: true,
        calendar: { persian: { locale: 'fa' } }
      }).attr('readonly', true);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      if (sessionStorage.getItem('userRole') !== 'admin') {
        alert('شما دسترسی ادمین ندارید!');
        window.location.href = 'index.html';
      }

      const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const form = document.getElementById('examForm');
      const list = document.getElementById('examList');
      const loading = document.getElementById('loading');
      const errEl = document.getElementById('error');
      const okEl = document.getElementById('success');
      const formTitle = document.getElementById('formTitle');
      const editIdInput = document.getElementById('editId');
      const submitBtn = document.getElementById('submitBtn');
      const maxAttemptsInput = document.getElementById('maxAttempts');
      const durationInput = document.getElementById('durationMinutes');
      const startAtInput = document.getElementById('startAt');
      const endAtInput = document.getElementById('endAt');
      const resultsBox = document.getElementById('resultsBox');

      const showLoading = show => loading.style.display = show ? 'block' : 'none';
      const showError = msg => { errEl.textContent = msg; errEl.style.display = 'block'; okEl.style.display = 'none'; };
      const showSuccess = msg => { okEl.textContent = msg; okEl.style.display = 'block'; errEl.style.display = 'none'; };
      const hideMessages = () => { errEl.style.display = okEl.style.display = 'none'; };

      // تبدیل تاریخ میلادی به شمسی برای نمایش
      function toJalaliDatetime(dt) {
        if (!dt) return '';
        try {
          return new persianDate(new Date(dt)).format('YYYY/MM/DD HH:mm');
        } catch (e) {
          return '';
        }
      }

      // تبدیل تاریخ شمسی به میلادی برای ذخیره
      function jalaliToIso(jalaliStr) {
        if (!jalaliStr) return null;
        try {
          return new persianDate().parse('YYYY/MM/DD HH:mm', jalaliStr).toDate().toISOString();
        } catch (e) {
          return null;
        }
      }

      // بارگذاری لیست آزمون‌ها
      async function loadExams() {
        showLoading(true); hideMessages();
        const { data, error } = await supabase.from('exams').select('*').order('id');
        if (error) {
          showError(error.message || 'خطا در دریافت داده‌ها');
          list.innerHTML = '<tr><td colspan="9">خطا در دریافت داده‌ها</td></tr>';
        } else {
          list.innerHTML = data.length ? data.map(exam => `
            <tr>
              <td>${exam.id}</td>
              <td>${exam.title}</td>
              <td>${exam.max_attempts || 1}</td>
              <td>${exam.duration_minutes || 20}</td>
              <td>${exam.start_at ? toJalaliDatetime(exam.start_at) : '-'}</td>
              <td>${exam.end_at ? toJalaliDatetime(exam.end_at) : '-'}</td>
              <td>${exam.created_at ? toJalaliDatetime(exam.created_at) : ''}</td>
              <td>
                <input type="checkbox" class="active-toggle" data-id="${exam.id}" ${exam.active ? 'checked' : ''} />
                <span style="font-size:12px; color:${exam.active ? '#27ae60' : '#c0392b'}">${exam.active ? 'فعال' : 'غیرفعال'}</span>
              </td>
              <td>
                <button class="edit-btn" data-id="${exam.id}" 
                  data-title="${exam.title}" 
                  data-max_attempts="${exam.max_attempts || 1}"
                  data-duration="${exam.duration_minutes || 20}"
                  data-start="${exam.start_at ? toJalaliDatetime(exam.start_at) : ''}"
                  data-end="${exam.end_at ? toJalaliDatetime(exam.end_at) : ''}"
                >ویرایش</button>
                <button class="delete-btn" data-id="${exam.id}">حذف</button>
                <button class="result-btn" data-id="${exam.id}" data-title="${exam.title}">مشاهده نتایج</button>
              </td>
            </tr>`).join('') : '<tr><td colspan="9">آزمونی یافت نشد</td></tr>';
        }
        showLoading(false);
      }

      // افزودن یا ویرایش آزمون
      form.addEventListener('submit', async e => {
        e.preventDefault();
        hideMessages();
        const id = editIdInput.value;
        const title = document.getElementById('title').value.trim();
        const maxAttempts = parseInt(maxAttemptsInput.value) || 1;
        const duration = parseInt(durationInput.value) || 20;
        const startAt = jalaliToIso(startAtInput.value);
        const endAt = jalaliToIso(endAtInput.value);

        if (!title) return showError('عنوان آزمون را وارد کنید.');
        if (maxAttempts < 1) return showError('تعداد دفعات مجاز باید حداقل ۱ باشد.');
        if (duration < 1) return showError('مدت آزمون باید حداقل ۱ دقیقه باشد.');
        if (!startAt) return showError('تاریخ و ساعت شروع آزمون را وارد کنید.');

        showLoading(true);

        // چک تکراری نبودن عنوان آزمون
        const { data: exists } = await supabase.from('exams').select('id').eq('title', title);
        if (exists && exists.length && (!id || exists[0].id != id)) {
          showError('آزمونی با این عنوان قبلاً ثبت شده است!');
          showLoading(false);
          return;
        }

        const examData = {
          title,
          max_attempts: maxAttempts,
          duration_minutes: duration,
          start_at: startAt,
          end_at: endAt || null,
          active: true
        };

        if (id) {
          const { error } = await supabase.from('exams').update(examData).eq('id', id);
          if (error) showError(error.message);
          else showSuccess('آزمون با موفقیت ویرایش شد');
        } else {
          const { error } = await supabase.from('exams').insert([examData]);
          if (error) showError(error.message);
          else showSuccess('آزمون جدید اضافه شد');
        }
        form.reset();
        editIdInput.value = '';
        formTitle.textContent = 'افزودن آزمون جدید';
        submitBtn.textContent = 'ذخیره';
        maxAttemptsInput.value = 1;
        durationInput.value = 20;
        startAtInput.value = '';
        endAtInput.value = '';
        await loadExams();
        showLoading(false);
      });

      list.addEventListener('click', async e => {
        const btn = e.target;
        const id = btn.dataset.id;
        if (btn.classList.contains('edit-btn')) {
          editIdInput.value = id;
          document.getElementById('title').value = btn.dataset.title;
          maxAttemptsInput.value = btn.dataset.max_attempts || 1;
          durationInput.value = btn.dataset.duration || 20;
          startAtInput.value = btn.dataset.start || '';
          endAtInput.value = btn.dataset.end || '';
          $('.jalali-picker').persianDatepicker('destroy').persianDatepicker({
            format: 'YYYY/MM/DD HH:mm',
            timePicker: { enabled: true },
            initialValue: false,
            autoClose: true,
            calendar: { persian: { locale: 'fa' } }
          }).attr('readonly', true);
          formTitle.textContent = 'ویرایش آزمون';
          submitBtn.textContent = 'به‌روزرسانی';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (btn.classList.contains('delete-btn')) {
          if (confirm('آیا از حذف آزمون مطمئن هستید؟')) {
            showLoading(true);
            const { error } = await supabase.from('exams').delete().eq('id', id);
            if (error) showError(error.message);
            else showSuccess('آزمون حذف شد');
            await loadExams();
            showLoading(false);
          }
        }
        if (btn.classList.contains('result-btn')) {
          await showExamResults(id, btn.dataset.title);
        }
      });

      // تابع خروجی xlsx برای اکسل با SheetJS
      function exportToXLSX(rows, filename) {
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, filename);
      }

      // نمایش نتایج آزمون و دکمه خروجی اکسل و حذف کاربران
      async function showExamResults(examId, examTitle) {
        resultsBox.style.display = 'block';
        resultsBox.innerHTML = `<h3>نتایج آزمون: ${examTitle}</h3><div class="spinner"></div>`;

        const numericExamId = Number(examId);

        // گرفتن همه نتایج این آزمون
        const { data: results, error: resErr } = await supabase
          .from('exam_results')
          .select('user_id, score, id')
          .eq('exam_id', numericExamId);

        if (resErr) {
          resultsBox.innerHTML = 'خطا در دریافت نتایج!';
          return;
        }
        if (!results || !results.length) {
          resultsBox.innerHTML = 'هنوز هیچ کاربری در این آزمون شرکت نکرده است!';
          return;
        }

        // گرفتن نام کاربری‌ها
        const { data: users, error: uErr } = await supabase
          .from('users')
          .select('id, username');
        if (uErr) {
          resultsBox.innerHTML = 'خطا در دریافت کاربران!';
          return;
        }

        // ساخت آرایه خروجی برای اکسل
        const xlsxRows = [];
        xlsxRows.push(['نام کاربری', 'نمره']);
        results.forEach(res => {
          const user = users.find(u => u.id == res.user_id);
          xlsxRows.push([user ? user.username : res.user_id, res.score]);
        });

        // ساخت جدول نمایش و دکمه خروجی اکسل و حذف
        let html = `
          <button id="exportExcel" style="background:#27ae60;color:#fff;margin-bottom:18px;padding:8px 22px;border-radius:6px;cursor:pointer;">دانلود خروجی اکسل</button>
          <button id="deleteAllUsers" style="background:#c0392b;color:#fff;margin-bottom:18px;padding:8px 22px;border-radius:6px;cursor:pointer;">حذف همه کاربران این آزمون</button>
          <table>
            <tr>
              <th>نام کاربری</th>
              <th>نمره</th>
              <th>عملیات</th>
            </tr>`;
        results.forEach(res => {
          const user = users.find(u => u.id == res.user_id);
          html += `<tr>
            <td>${user ? user.username : res.user_id}</td>
            <td>${res.score}</td>
            <td>
              <button class="delete-user-exam" data-userid="${res.user_id}" data-examid="${numericExamId}" style="background:#c0392b;color:#fff;">حذف کاربر</button>
            </td>
          </tr>`;
        });
        html += `</table>`;
        resultsBox.innerHTML = `<h3>نتایج آزمون: ${examTitle}</h3>${html}`;
        resultsBox.scrollIntoView({ behavior: 'smooth' });

        // رویداد دکمه خروجی اکسل
        document.getElementById('exportExcel').onclick = function() {
          exportToXLSX(xlsxRows, `exam_${examId}_results.xlsx`);
        };

        // رویداد حذف یک کاربر از آزمون
        document.querySelectorAll('.delete-user-exam').forEach(btn => {
          btn.onclick = async function() {
            if (!confirm('آیا از حذف این کاربر از لیست آزمون مطمئن هستید؟')) return;
            const userId = btn.dataset.userid;
            const examId = btn.dataset.examid;
            const { error } = await supabase
              .from('exam_results')
              .delete()
              .eq('exam_id', examId)
              .eq('user_id', userId);
            if (error) {
              alert('خطا در حذف!');
            } else {
              alert('کاربر از لیست آزمون حذف شد.');
              await showExamResults(examId, examTitle);
            }
          };
        });

        // رویداد حذف همه کاربران آزمون
        document.getElementById('deleteAllUsers').onclick = async function() {
          if (!confirm('آیا از حذف همه کاربران این آزمون مطمئن هستید؟')) return;
          const { error } = await supabase
            .from('exam_results')
            .delete()
            .eq('exam_id', numericExamId);
          if (error) {
            alert('خطا در حذف همه!');
          } else {
            alert('همه کاربران این آزمون حذف شدند.');
            await showExamResults(numericExamId, examTitle);
          }
        };
      }

      await loadExams();
    });
  </script>
</body>
</html>

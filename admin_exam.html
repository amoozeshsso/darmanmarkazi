<!-- ... (همان head و style قبلی) ... -->
<body>
  <div class="container">
    <!-- ... (بخش مدیریت آزمون) ... -->
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>عنوان آزمون</th>
          <th>تاریخ ایجاد</th>
          <th>فعال؟</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="examList">
        <tr><td colspan="5">در حال بارگذاری آزمون‌ها...</td></tr>
      </tbody>
    </table>
    <div id="resultsBox" style="display:none;"></div>

    <!-- بخش مدیریت سوالات -->
    <div id="questionsSection" style="display:none; margin-top:40px;">
      <h2>مدیریت سوالات آزمون: <span id="questionsExamTitle"></span></h2>
      <button id="closeQuestions" style="margin-bottom:18px;background:#b2bec3;color:#222;padding:8px 16px;border-radius:5px;">بستن</button>
      <div id="questionFormBox">
        <h3 id="qFormTitle">افزودن سوال جدید</h3>
        <form id="questionForm">
          <input type="hidden" id="qEditId" />
          <label>متن سوال:</label>
          <textarea id="questionText" required></textarea>
          <label>گزینه ۱:</label>
          <input type="text" id="option1" required />
          <label>گزینه ۲:</label>
          <input type="text" id="option2" required />
          <label>گزینه ۳:</label>
          <input type="text" id="option3" required />
          <label>گزینه ۴:</label>
          <input type="text" id="option4" required />
          <label>گزینه صحیح (شماره ۱ تا ۴):</label>
          <input type="number" id="correctOption" min="1" max="4" required />
          <button type="submit" class="add-btn" id="qSubmitBtn">ذخیره سوال</button>
        </form>
        <div id="qError"></div>
        <div id="qSuccess"></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>شناسه</th>
            <th>متن سوال</th>
            <th>گزینه ۱</th>
            <th>گزینه ۲</th>
            <th>گزینه ۳</th>
            <th>گزینه ۴</th>
            <th>گزینه صحیح</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody id="questionsList">
          <tr><td colspan="8">در حال بارگذاری سوالات...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // ... (کد مدیریت آزمون مثل قبل)

      // سوالات
      const questionsSection = document.getElementById('questionsSection');
      const questionsExamTitle = document.getElementById('questionsExamTitle');
      const closeQuestions = document.getElementById('closeQuestions');
      const questionForm = document.getElementById('questionForm');
      const qFormTitle = document.getElementById('qFormTitle');
      const qEditId = document.getElementById('qEditId');
      const questionText = document.getElementById('questionText');
      const option1 = document.getElementById('option1');
      const option2 = document.getElementById('option2');
      const option3 = document.getElementById('option3');
      const option4 = document.getElementById('option4');
      const correctOption = document.getElementById('correctOption');
      const qSubmitBtn = document.getElementById('qSubmitBtn');
      const questionsList = document.getElementById('questionsList');
      const qError = document.getElementById('qError');
      const qSuccess = document.getElementById('qSuccess');

      // ... (کد مدیریت آزمون مثل قبل)

      // مدیریت سوالات هر آزمون
      let currentExamId = null;
      async function openQuestionsSection(examId, examTitle) {
        currentExamId = examId;
        questionsExamTitle.textContent = examTitle;
        questionsSection.style.display = 'block';
        await loadQuestionsList();
        window.scrollTo({ top: questionsSection.offsetTop - 20, behavior: 'smooth' });
      }
      closeQuestions.addEventListener('click', () => {
        questionsSection.style.display = 'none';
        questionForm.reset();
        qEditId.value = '';
        qFormTitle.textContent = 'افزودن سوال جدید';
        qSubmitBtn.textContent = 'ذخیره سوال';
        qError.style.display = qSuccess.style.display = 'none';
      });

      async function loadQuestionsList() {
        qError.style.display = qSuccess.style.display = 'none';
        questionsList.innerHTML = '<tr><td colspan="8">در حال بارگذاری سوالات...</td></tr>';
        const { data, error } = await supabase
          .from('questions')
          .select('*')
          .eq('exam_id', currentExamId)
          .order('id');
        if (error) {
          questionsList.innerHTML = '<tr><td colspan="8">خطا در دریافت سوالات</td></tr>';
        } else if (!data.length) {
          questionsList.innerHTML = '<tr><td colspan="8">سوالی ثبت نشده است</td></tr>';
        } else {
          questionsList.innerHTML = data.map(q => `
            <tr>
              <td>${q.id}</td>
              <td>${q.question_text}</td>
              <td>${q.option1}</td>
              <td>${q.option2}</td>
              <td>${q.option3}</td>
              <td>${q.option4}</td>
              <td>${q.correct_option}</td>
              <td>
                <button class="edit-q-btn" data-id="${q.id}">ویرایش</button>
                <button class="delete-q-btn" data-id="${q.id}">حذف</button>
              </td>
            </tr>
          `).join('');
        }
      }

      questionForm.addEventListener('submit', async e => {
        e.preventDefault();
        qError.style.display = qSuccess.style.display = 'none';
        const qid = qEditId.value;
        const qtext = questionText.value.trim();
        const op1 = option1.value.trim();
        const op2 = option2.value.trim();
        const op3 = option3.value.trim();
        const op4 = option4.value.trim();
        const correct = Number(correctOption.value);

        if (!qtext || !op1 || !op2 || !op3 || !op4 || ![1,2,3,4].includes(correct)) {
          qError.textContent = 'همه فیلدها را کامل و صحیح وارد کنید.'; qError.style.display = 'block'; return;
        }

        if (qid) {
          // ویرایش سوال
          const { error } = await supabase.from('questions').update({
            question_text: qtext,
            option1: op1,
            option2: op2,
            option3: op3,
            option4: op4,
            correct_option: correct
          }).eq('id', qid);
          if (error) { qError.textContent = error.message; qError.style.display = 'block'; }
          else { qSuccess.textContent = 'سوال ویرایش شد.'; qSuccess.style.display = 'block'; }
        } else {
          // افزودن سوال جدید
          const { error } = await supabase.from('questions').insert([{
            exam_id: currentExamId,
            question_text: qtext,
            option1: op1,
            option2: op2,
            option3: op3,
            option4: op4,
            correct_option: correct
          }]);
          if (error) { qError.textContent = error.message; qError.style.display = 'block'; }
          else { qSuccess.textContent = 'سوال جدید اضافه شد.'; qSuccess.style.display = 'block'; }
        }
        questionForm.reset();
        qEditId.value = '';
        qFormTitle.textContent = 'افزودن سوال جدید';
        qSubmitBtn.textContent = 'ذخیره سوال';
        await loadQuestionsList();
      });

      questionsList.addEventListener('click', async e => {
        const btn = e.target;
        const id = btn.dataset.id;
        if (btn.classList.contains('edit-q-btn')) {
          // گرفتن اطلاعات سوال و پر کردن فرم
          const { data, error } = await supabase.from('questions').select('*').eq('id', id).maybeSingle();
          if (!data || error) {
            qError.textContent = 'خطا در دریافت اطلاعات سوال!'; qError.style.display = 'block'; return;
          }
          qEditId.value = data.id;
          questionText.value = data.question_text;
          option1.value = data.option1;
          option2.value = data.option2;
          option3.value = data.option3;
          option4.value = data.option4;
          correctOption.value = data.correct_option;
          qFormTitle.textContent = 'ویرایش سوال';
          qSubmitBtn.textContent = 'به‌روزرسانی سوال';
        }
        if (btn.classList.contains('delete-q-btn')) {
          if (confirm('آیا از حذف سوال مطمئن هستید؟')) {
            const { error } = await supabase.from('questions').delete().eq('id', id);
            if (error) { qError.textContent = 'خطا در حذف سوال!'; qError.style.display = 'block'; }
            else { qSuccess.textContent = 'سوال حذف شد.'; qSuccess.style.display = 'block'; }
            await loadQuestionsList();
          }
        }
      });

      // ... (بقیه کد مدیریت آزمون مثل قبل)

      // اضافه کردن دکمه مدیریت سوالات به هر آزمون
      const oldLoadExams = loadExams;
      window.loadExams = async function() {
        await oldLoadExams();
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.insertAdjacentHTML('afterend', `<button class="questions-btn" data-id="${btn.dataset.id}" data-title="${btn.dataset.title}">سوالات آزمون</button>`);
        });
        document.querySelectorAll('.questions-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            e.preventDefault();
            await openQuestionsSection(btn.dataset.id, btn.dataset.title);
          });
        });
      };

      // بارگذاری اولیه آزمون‌ها
      await loadExams();
    });
  </script>
</body>
</html>

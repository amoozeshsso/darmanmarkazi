<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مدیریت آزمون‌ها</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Tahoma; background: #f8f8f8; margin: 0; padding: 20px; } [cite: 141, 142]
    h1 { text-align: center; color: #333; } [cite: 142]
    .container { max-width: 1100px; margin: auto; } [cite: 143]
    table { width: 100%; border-collapse: collapse; margin-top: 20px; } [cite: 143, 144]
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } [cite: 144]
    th { background: #2c3e50; color: #fff; } [cite: 145]
    tr:nth-child(even) { background: #f2f2f2; } [cite: 145]
    tr:hover { background: #e9f7ef; } [cite: 146]
    button { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; } [cite: 146, 147]
    .add-btn { background: #27ae60; color: #fff; width: 100%; font-size: 16px; } [cite: 147]
    .edit-btn { background: #2980b9; color: #fff; } [cite: 148]
    .delete-btn { background: #c0392b; color: #fff; } [cite: 148]
    .result-btn { background: #f39c12; color: #fff; } [cite: 149]
    .questions-btn { background: #16a085; color: #fff; } [cite: 149]
    #formBox, #questionFormBox { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 20px; } [cite: 150]
    label { display: block; margin-top: 10px; color: #555; font-weight: bold; } [cite: 151]
    input[type="text"], input[type="number"], input[type="datetime-local"], textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; } [cite: 152, 153]
    input:focus, textarea:focus { outline: none; border-color: #3498db; } [cite: 153, 154]
    #loading { display: none; text-align: center; margin: 20px 0; } [cite: 154, 155]
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; } [cite: 155, 156]
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } [cite: 156, 157]
    #error, #success, #qError, #qSuccess { display: none; padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; } [cite: 157, 158]
    #error, #qError { background: rgba(231,76,60,0.8); color: #fff; } [cite: 158, 159]
    #success, #qSuccess { background: rgba(46,204,113,0.8); color: #fff; } [cite: 159]
    .back { margin-bottom: 18px; text-align: right; } [cite: 160]
    .back a { background: #4e54c8; color: #fff; padding: 8px 18px; border-radius: 5px; text-decoration: none; } [cite: 160, 161]
    #resultsBox { margin-top: 30px; background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); } [cite: 161, 162]
    #resultsBox table { margin: auto; width: 90%; } [cite: 162]
    #resultsBox th { background: #f39c12; } [cite: 162, 163]
    #questionsSection { margin-top: 40px; } [cite: 163]
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; } [cite: 163, 164]
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="back">
      <a href="admin-dashboard.html">بازگشت به داشبورد ادمین</a>
    </div>
    <h1>مدیریت آزمون‌ها</h1>
    <div id="formBox">
      <h3 id="formTitle">افزودن آزمون جدید</h3>
      <form id="examForm">
        <input type="hidden" id="editId" />
        <label for="title">عنوان آزمون:</label>
        <input type="text" id="title" required />
        <label for="maxAttempts">تعداد دفعات مجاز شرکت در آزمون:</label> [cite: 164, 165]
        <input type="number" id="maxAttempts" min="1" max="20" value="1" required />
        <label for="passMark">نمره قبولی (حداقل نمره برای قبولی):</label>
        <input type="number" id="passMark" min="1" max="100" value="10" required />
        <label for="randomQuestionCount">تعداد سوال تصادفی برای هر کاربر:</label>
        <input type="number" id="randomQuestionCount" min="1" max="100" value="2" required />
        <label for="durationMinutes">مدت زمان آزمون (دقیقه):</label>
        <input type="number" id="durationMinutes" min="1" max="300" value="20" required /> [cite: 165, 166]
        <label for="startAt">تاریخ و ساعت شروع آزمون:</label>
        <input type="datetime-local" id="startAt" required />
        <label for="endAt">تاریخ و ساعت پایان آزمون (اختیاری):</label>
        <input type="datetime-local" id="endAt" />
        <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
      </form>
      <div id="error"></div>
      <div id="success"></div>
    </div>
    <div id="loading">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p> [cite: 167]
    </div>
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>عنوان آزمون</th>
          <th>تعداد دفعات مجاز</th>
          <th>نمره قبولی</th>
          <th>مدت آزمون (دقیقه)</th>
          <th>شروع</th>
          <th>پایان</th> [cite: 167, 168]
          <th>تاریخ ایجاد</th>
          <th>فعال؟</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="examList">
        <tr><td colspan="9">در حال بارگذاری آزمون‌ها...</td></tr>
      </tbody>
    </table>
    <div id="resultsBox" style="display:none;"></div>

    <div id="questionsSection" style="display:none;">
      <h2>مدیریت سوالات آزمون: <span id="questionsExamTitle"></span></h2> [cite: 168, 169]
      <button id="closeQuestions" style="margin-bottom:18px;background:#b2bec3;color:#222;padding:8px 16px;border-radius:5px;">بستن</button>
      <div id="questionFormBox">
        <button id="importExcelBtn" style="background:#16a085;color:#fff;margin-bottom:12px;">وارد کردن اکسل سوالات</button>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none;">
        <div>
          <b>ساختار فایل اکسل سوالات باید دقیقاً به این صورت باشد:</b> [cite: 169]
          <table style="margin-top:8px;direction:rtl;font-size:15px;border:1px solid #bbb;">
            <thead>
              <tr style="background:#f1f1f1;">
                <th>question_text</th>
                <th>option1</th>
                <th>option2</th> [cite: 170]
                <th>option3</th>
                <th>option4</th>
                <th>correct_option</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>پایتخت ایران کدام است؟</td>
                <td>تهران</td>
                <td>اراک</td>
                <td>بوشهر</td>
                <td>بندر</td>
                <td>1</td>
              </tr>
            </tbody>
          </table>
          <div style="font-size:13px;color:#555;margin-top:6px;"></div>
        </div>

        <h3 id="qFormTitle">افزودن سوال جدید</h3>
        <form id="questionForm">
          <input type="hidden" id="qEditId" />
          <label>متن سوال:</label>
          <textarea id="questionText" required></textarea>
          <label>گزینه ۱:</label>
          <input type="text" id="option1" required /> [cite: 171, 172]
          <label>گزینه ۲:</label>
          <input type="text" id="option2" required />
          <label>گزینه ۳:</label>
          <input type="text" id="option3" required />
          <label>گزینه ۴:</label>
          <input type="text" id="option4" required />
          <label>گزینه صحیح (شماره ۱ تا ۴):</label>
          <input type="number" id="correctOption" min="1" max="4" required /> [cite: 172, 173]
          <button type="submit" class="add-btn" id="qSubmitBtn">ذخیره سوال</button>
        </form>
        <div id="qError"></div>
        <div id="qSuccess"></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>شناسه</th>
            <th>متن سوال</th> [cite: 174]
            <th>گزینه ۱</th>
            <th>گزینه ۲</th>
            <th>گزینه ۳</th>
            <th>گزینه ۴</th>
            <th>گزینه صحیح</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody id="questionsList">
          <tr><td colspan="8">در حال بارگذاری سوالات...</td></tr> [cite: 175]
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (sessionStorage.getItem('userRole') !== 'admin') {
        alert('شما دسترسی ادمین ندارید!'); [cite: 175, 176]
        window.location.href = 'index.html';
      }

      const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co'; [cite: 176]
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU'; [cite: 176, 177]
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); [cite: 177]

      const form = document.getElementById('examForm'); [cite: 177]
      const list = document.getElementById('examList'); [cite: 177]
      const loading = document.getElementById('loading'); [cite: 177]
      const errEl = document.getElementById('error'); [cite: 178]
      const okEl = document.getElementById('success'); [cite: 178]
      const formTitle = document.getElementById('formTitle'); [cite: 178]
      const editIdInput = document.getElementById('editId'); [cite: 178]
      const submitBtn = document.getElementById('submitBtn'); [cite: 179]
      const maxAttemptsInput = document.getElementById('maxAttempts'); [cite: 179]
      const durationInput = document.getElementById('durationMinutes'); [cite: 179]
      const startAtInput = document.getElementById('startAt'); [cite: 179]
      const endAtInput = document.getElementById('endAt'); [cite: 179]
      const resultsBox = document.getElementById('resultsBox'); [cite: 179]
      const passMarkInput = document.getElementById('passMark'); [cite: 180]

      // سوالات
      const questionsSection = document.getElementById('questionsSection'); [cite: 180]
      const questionsExamTitle = document.getElementById('questionsExamTitle'); [cite: 180, 181]
      const closeQuestions = document.getElementById('closeQuestions'); [cite: 181]
      const questionForm = document.getElementById('questionForm'); [cite: 181]
      const qFormTitle = document.getElementById('qFormTitle'); [cite: 181]
      const qEditId = document.getElementById('qEditId'); [cite: 181, 182]
      const questionText = document.getElementById('questionText'); [cite: 181, 182]
      const option1 = document.getElementById('option1'); [cite: 182]
      const option2 = document.getElementById('option2'); [cite: 182]
      const option3 = document.getElementById('option3'); [cite: 182]
      const option4 = document.getElementById('option4'); [cite: 182, 183]
      const correctOption = document.getElementById('correctOption'); [cite: 183]
      const qSubmitBtn = document.getElementById('qSubmitBtn'); [cite: 183]
      const questionsList = document.getElementById('questionsList'); [cite: 183, 184]
      const qError = document.getElementById('qError'); [cite: 183]
      const qSuccess = document.getElementById('qSuccess'); [cite: 183]
      const showLoading = show => loading.style.display = show ? 'block' : 'none'; [cite: 184, 185]
      const showError = msg => { errEl.textContent = msg; errEl.style.display = 'block'; okEl.style.display = 'none'; }; [cite: 185]
      const showSuccess = msg => { okEl.textContent = msg; okEl.style.display = 'block'; errEl.style.display = 'none'; }; [cite: 186]
      const hideMessages = () => { errEl.style.display = okEl.style.display = 'none'; }; [cite: 187]
      const showQError = msg => { qError.textContent = msg; qError.style.display = 'block'; qSuccess.style.display = 'none'; }; [cite: 188]
      const showQSuccess = msg => { qSuccess.textContent = msg; qSuccess.style.display = 'block'; qError.style.display = 'none'; }; [cite: 189]
      const hideQMessages = () => { qError.style.display = qSuccess.style.display = 'none'; }; [cite: 190]

      // بارگذاری لیست آزمون‌ها
      async function loadExams() {
        showLoading(true); [cite: 191]
        hideMessages(); [cite: 192]
        const { data, error } = await supabase.from('exams').select('*').order('id'); [cite: 192]
        if (error) {
          showError(error.message || 'خطا در دریافت داده‌ها'); [cite: 192]
          list.innerHTML = '<tr><td colspan="9">خطا در دریافت داده‌ها</td></tr>'; [cite: 193]
        } else {
          list.innerHTML = data.length ?
            data.map(exam => `
              <tr>
                <td>${exam.id}</td>
                <td>${exam.title}</td>
                <td>${exam.max_attempts || 1}</td>
                <td>${exam.pass_mark || '-'}</td>
                <td>${exam.duration_minutes || 20}</td>
                <td>${exam.start_at ? new Date(exam.start_at).toLocaleString('fa-IR') : '-'}</td>
                <td>${exam.end_at ? new Date(exam.end_at).toLocaleString('fa-IR') : '-'}</td> [cite: 194, 195, 196]
                <td>${exam.created_at ? new Date(exam.created_at).toLocaleString('fa-IR') : ''}</td>
                <td>
                  <input type="checkbox" class="active-toggle" data-id="${exam.id}" ${exam.active ? 'checked' : ''} />
                  <span style="font-size:12px; color:${exam.active ? '#27ae60' : '#c0392b'}">${exam.active ? 'فعال' : 'غیرفعال'}</span>
                </td>
                <td>
                  <button class="edit-btn" data-id="${exam.id}" 
                    data-title="${exam.title}" 
                    data-max_attempts="${exam.max_attempts || 1}"
                    data-duration="${exam.duration_minutes || 20}"
                    data-start="${exam.start_at ? new Date(exam.start_at).toISOString().slice(0,16) : ''}"
                    data-end="${exam.end_at ? new Date(exam.end_at).toISOString().slice(0,16) : ''}" [cite: 195, 196]
                    data-random_question_count="${exam.random_question_count || 2}" [cite: 196, 197]
                    data-pass_mark="${exam.pass_mark || 10}" [cite: 197, 198]
                  >ویرایش</button>
                  <button class="delete-btn" data-id="${exam.id}">حذف</button>
                  <button class="result-btn" data-id="${exam.id}" data-title="${exam.title}">مشاهده نتایج</button>
                  <button class="questions-btn" data-id="${exam.id}" data-title="${exam.title}">سوالات آزمون</button>
                </td>
              </tr>
            `).join('') : '<tr><td colspan="10">آزمونی یافت نشد</td></tr>'; [cite: 193, 194]
        }
        showLoading(false); [cite: 194]
      }

      // جلوگیری از ثبت آزمون تکراری (در افزودن و ویرایش)
      form.addEventListener('submit', async e => {
        e.preventDefault();
        hideMessages();
        const id = editIdInput.value; [cite: 198, 199]
        const title = document.getElementById('title').value.trim(); [cite: 199]
        const maxAttempts = parseInt(maxAttemptsInput.value) || 1; [cite: 199]
        const duration = parseInt(durationInput.value) || 20; [cite: 199]
        const startAt = startAtInput.value ? new Date(startAtInput.value).toISOString() : null; [cite: 199, 200]
        const endAt = endAtInput.value ? new Date(endAtInput.value).toISOString() : null; [cite: 200]
        const randomQuestionCount = parseInt(document.getElementById('randomQuestionCount').value) || 10; [cite: 200]
        const passMark = parseInt(passMarkInput.value) || 10; [cite: 200]

        if (!title) return showError('عنوان آزمون را وارد کنید.'); [cite: 202]
        if (maxAttempts < 1) return showError('تعداد دفعات مجاز باید حداقل ۱ باشد.'); [cite: 203]
        if (duration < 1) return showError('مدت آزمون باید حداقل ۱ دقیقه باشد.'); [cite: 204]
        if (!startAt) return showError('تاریخ و ساعت شروع آزمون را وارد کنید.'); [cite: 205]

        showLoading(true); [cite: 205]
        // چک تکراری نبودن عنوان آزمون
        const { data: exists } = await supabase.from('exams').select('id').eq('title', title); [cite: 206]
        if (exists && exists.length && (!id || exists[0].id != id)) {
          showError('آزمونی با این عنوان قبلاً ثبت شده است!'); [cite: 207]
          showLoading(false); [cite: 208]
          return;
        }

        const examData = {
          title,
          max_attempts: maxAttempts,
          duration_minutes: duration,
          start_at: startAt,
          end_at: endAt || null, [cite: 209, 210]
          active: true,
          random_question_count: randomQuestionCount, [cite: 210]
          pass_mark: passMark
        };

        if (id) {
          const { error } = await supabase.from('exams').update(examData).eq('id', id); [cite: 211]
          if (error) showError(error.message); [cite: 212]
          else showSuccess('آزمون با موفقیت ویرایش شد'); [cite: 212]
        } else {
          const { error } = await supabase.from('exams').insert([examData]); [cite: 212, 213]
          if (error) showError(error.message); [cite: 213]
          else showSuccess('آزمون جدید اضافه شد'); [cite: 213]
        }
        form.reset(); [cite: 213]
        editIdInput.value = ''; [cite: 213, 214]
        formTitle.textContent = 'افزودن آزمون جدید'; [cite: 214]
        submitBtn.textContent = 'ذخیره'; [cite: 214]
        maxAttemptsInput.value = 1; [cite: 214]
        durationInput.value = 20; [cite: 214]
        startAtInput.value = ''; [cite: 214]
        endAtInput.value = ''; [cite: 215]
        await loadExams(); [cite: 215]
        showLoading(false); [cite: 215]
      });

      list.addEventListener('click', async e => {
        const btn = e.target;
        const id = btn.dataset.id;
        if (btn.classList.contains('edit-btn')) {
          editIdInput.value = id; [cite: 215]
          document.getElementById('title').value = btn.dataset.title; [cite: 215]
          maxAttemptsInput.value = btn.dataset.max_attempts || 1; [cite: 215]
          durationInput.value = btn.dataset.duration || 20; [cite: 215]
          startAtInput.value = btn.dataset.start || ''; [cite: 216]
          endAtInput.value = btn.dataset.end || ''; [cite: 216]
          document.getElementById('randomQuestionCount').value = btn.dataset.random_question_count || 2; [cite: 216]
          document.getElementById('passMark').value = btn.dataset.pass_mark || 10; [cite: 216, 217]
          formTitle.textContent = 'ویرایش آزمون'; [cite: 217]
          submitBtn.textContent = 'به‌روزرسانی';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (btn.classList.contains('delete-btn')) {
          if (confirm('آیا از حذف آزمون مطمئن هستید؟')) {
            showLoading(true); [cite: 217, 218]
            const { error } = await supabase.from('exams').delete().eq('id', id); [cite: 218]
            if (error) showError(error.message); [cite: 218]
            else showSuccess('آزمون حذف شد'); [cite: 218]
            await loadExams(); [cite: 218, 219]
            showLoading(false); [cite: 219]
          }
        }
        if (btn.classList.contains('result-btn')) {
          await showExamResults(id, btn.dataset.title); [cite: 219, 220]
        }
        if (btn.classList.contains('questions-btn')) {
          await openQuestionsSection(id, btn.dataset.title); [cite: 220, 221]
        }
      });

      // تغییر وضعیت فعال/غیرفعال
      list.addEventListener('change', async e => {
        if (e.target.classList.contains('active-toggle')) {
          const examId = e.target.dataset.id;
          const isActive = e.target.checked;
          showLoading(true);
          const { error } = await supabase.from('exams').update({ active: isActive }).eq('id', examId); [cite: 221]
          if (error) showError('خطا در تغییر وضعیت آزمون!'); [cite: 222]
          else showSuccess(isActive ? 'آزمون فعال شد' : 'آزمون غیرفعال شد'); [cite: 222]
          await loadExams(); [cite: 222]
          showLoading(false); [cite: 222]
        }
      });

      // نمایش نتایج کاربران شرکت‌کننده در آزمون (با امکان حذف کاربر یا حذف همه)
      async function showExamResults(examId, examTitle) {
        resultsBox.style.display = 'block'; [cite: 223, 224]
        resultsBox.innerHTML = `<h3>نتایج آزمون: ${examTitle}</h3><div class="spinner"></div>`; [cite: 224]

        const numericExamId = Number(examId); [cite: 224]
        // گرفتن همه نتایج این آزمون
        const { data: results, error: resErr } = await supabase
          .from('exam_results')
          .select('user_id, score, id')
          .eq('exam_id', numericExamId); [cite: 225]
        if (resErr) {
          resultsBox.innerHTML = 'خطا در دریافت نتایج!'; [cite: 226]
          return;
        }
        if (!results || !results.length) {
          resultsBox.innerHTML = 'هنوز هیچ کاربری در این آزمون شرکت نکرده است!'; [cite: 227]
          return;
        }

        // گرفتن نام کاربری‌ها
        const { data: users, error: uErr } = await supabase
          .from('users')
          .select('id, username'); [cite: 228]
        if (uErr) {
          resultsBox.innerHTML = 'خطا در دریافت کاربران!'; [cite: 229]
          return;
        }

        // ساخت آرایه نهایی: بیشترین نمره و تعداد دفعات شرکت هر کاربر
        const userResultsMap = {}; [cite: 230]
        results.forEach(res => {
          if (!userResultsMap[res.user_id]) {
            userResultsMap[res.user_id] = { maxScore: res.score, count: 1, id: res.id };
          } else {
            userResultsMap[res.user_id].count += 1;
            if (res.score > userResultsMap[res.user_id].maxScore) {
              userResultsMap[res.user_id].maxScore = res.score;
              userResultsMap[res.user_id].id = res.id;
            }
          }
        });
        const finalResults = Object.entries(userResultsMap).map(([user_id, data]) => { [cite: 231]
          const user = users.find(u => u.id == user_id);
          return {
            user_id,
            username: user ? user.username : 'نامشخص',
            maxScore: data.maxScore,
            count: data.count,
            result_id: data.id
          };
        });

        // دریافت نمره قبولی برای نمایش وضعیت
        const { data: examData, error: examError } = await supabase
            .from('exams')
            .select('pass_mark')
            .eq('id', numericExamId)
            .single();

        const passMark = examData ? examData.pass_mark : 0; // Default to 0 if not found

        // ساخت جدول نتایج با دکمه حذف تکی
        let table = `
          <table>
            <thead>
              <tr>
                <th>ردیف</th>
                <th>نام کاربری</th>
                <th>بیشترین نمره</th>
                <th>تعداد دفعات شرکت</th>
                <th>وضعیت</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              ${finalResults.map((r, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${r.username}</td>
                  <td>${r.maxScore}</td>
                  <td>${r.count}</td>
                  <td>${r.maxScore >= passMark ? 'قبول' : 'مردود'}</td> [cite: 234, 235]
                  <td>
                    <button class="delete-user-result-btn" data-userid="${r.user_id}" data-examid="${examId}">حذف</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <button id="exportExcelBtn" style="margin-top:18px;background:#27ae60;color:#fff;padding:8px 22px;border-radius:6px;font-size:15px;">دانلود اکسل</button>
          <button id="deleteAllResultsBtn" style="margin-top:18px;background:#c0392b;color:#fff;padding:8px 22px;border-radius:6px;font-size:15px;margin-right:8px;">حذف همه نتایج</button>
          <button id="closeResultsBtn" style="margin-top:18px;background:#b2bec3;color:#222;padding:8px 22px;border-radius:6px;font-size:15px;margin-right:8px;">بستن</button>
        `;
        resultsBox.innerHTML = table; [cite: 236]

        // دکمه بستن نتایج
        resultsBox.querySelector('#closeResultsBtn').onclick = () => {
          resultsBox.style.display = 'none'; [cite: 237, 238]
          resultsBox.innerHTML = ''; [cite: 238]
        };

        // دکمه خروجی اکسل فقط با نام کاربری و بیشترین نمره
        resultsBox.querySelector('#exportExcelBtn').onclick = function() {
          const exportData = finalResults.map(item => ({
            "نام کاربری": item.username,
            "بیشترین نمره": item.maxScore,
            "وضعیت": item.maxScore >= passMark ? 'قبول' : 'مردود'
          })); [cite: 238, 239]
          const ws = XLSX.utils.json_to_sheet(exportData); [cite: 239]
          const wb = XLSX.utils.book_new(); [cite: 239]
          XLSX.utils.book_append_sheet(wb, ws, "Results"); [cite: 239]
          XLSX.writeFile(wb, (examTitle || "results") + ".xlsx"); [cite: 239]
        };

        // دکمه حذف همه نتایج کاربران این آزمون
        resultsBox.querySelector('#deleteAllResultsBtn').onclick = async function() {
          if (confirm('آیا از حذف همه نتایج کاربران این آزمون مطمئن هستید؟')) {
            const { error } = await supabase.from('exam_results').delete().eq('exam_id', examId); [cite: 240]
            if (error) alert('خطا در حذف!'); [cite: 241]
            else {
              alert('همه نتایج کاربران این آزمون حذف شد.'); [cite: 241]
              resultsBox.style.display = 'none'; [cite: 242]
              resultsBox.innerHTML = ''; [cite: 242]
            }
          }
        };

        // حذف تکی نتیجه کاربر (بیشترین نمره)
        resultsBox.addEventListener('click', async function(e) {
          if (e.target.classList.contains('delete-user-result-btn')) {
            const userId = e.target.dataset.userid;
            if (confirm('آیا از حذف نتیجه این کاربر مطمئن هستید؟')) {
              // فقط رکوردی که بیشترین نمره را دارد حذف می‌شود
              const best = results.find(r => r.user_id == userId && r.score == userResultsMap[userId].maxScore); [cite: 243, 244]
              if (best) {
                const { error } = await supabase.from('exam_results').delete().eq('id', best.id); [cite: 244]
                if (error) alert('خطا در حذف!'); [cite: 244]
                else {
                  alert('نتیجه کاربر حذف شد.'); [cite: 244]
                  await showExamResults(examId, examTitle); // رفرش نتایج
                }
              }
            }
          }
        });
      }

      // مدیریت سوالات هر آزمون
      let currentExamId = null; [cite: 245, 246]
      async function openQuestionsSection(examId, examTitle) {
        currentExamId = examId; [cite: 246]
        questionsExamTitle.textContent = examTitle; [cite: 246]
        questionsSection.style.display = 'block'; [cite: 246]
        await loadQuestionsList(); [cite: 246]
        window.scrollTo({ top: questionsSection.offsetTop - 20, behavior: 'smooth' }); [cite: 247]
      }

      closeQuestions.addEventListener('click', () => {
        questionsSection.style.display = 'none'; [cite: 250]
        questionForm.reset(); [cite: 250]
        qEditId.value = ''; [cite: 250]
        qFormTitle.textContent = 'افزودن سوال جدید'; [cite: 250]
        qSubmitBtn.textContent = 'ذخیره سوال'; [cite: 250]
        hideQMessages(); [cite: 250, 251]
      });

      async function loadQuestionsList() {
        hideQMessages(); [cite: 251]
        questionsList.innerHTML = '<tr><td colspan="8">در حال بارگذاری سوالات...</td></tr>'; [cite: 251, 252]
        const { data, error } = await supabase
          .from('questions')
          .select('*')
          .eq('exam_id', currentExamId)
          .order('id'); [cite: 252]
        if (error) {
          questionsList.innerHTML = '<tr><td colspan="8">خطا در دریافت سوالات</td></tr>'; [cite: 253]
        } else if (!data.length) {
          questionsList.innerHTML = '<tr><td colspan="8">سوالی ثبت نشده است</td></tr>'; [cite: 254]
        } else {
          questionsList.innerHTML = data.map(q => `
            <tr>
              <td>${q.id}</td>
              <td>${q.question_text}</td>
              <td>${q.option1}</td>
              <td>${q.option2}</td>
              <td>${q.option3}</td>
              <td>${q.option4}</td> [cite: 255, 256]
              <td>${q.correct_option}</td>
              <td>
                <button class="edit-q-btn" data-id="${q.id}">ویرایش</button>
                <button class="delete-q-btn" data-id="${q.id}">حذف</button>
              </td>
            </tr>
          `).join(''); [cite: 256, 257]
        }
      }

      questionForm.addEventListener('submit', async e => {
        e.preventDefault();
        hideQMessages(); [cite: 258]
        const qid = qEditId.value; [cite: 258]
        const qtext = questionText.value.trim(); [cite: 258]
        const op1 = option1.value.trim(); [cite: 258]
        const op2 = option2.value.trim(); [cite: 258]
        const op3 = option3.value.trim(); [cite: 258]
        const op4 = option4.value.trim(); [cite: 259]
        const correct = Number(correctOption.value); [cite: 259]

        if (!qtext || !op1 || !op2 || !op3 || !op4 || ![1, 2, 3, 4].includes(correct)) {
          showQError('همه فیلدها را کامل و صحیح وارد کنید.'); [cite: 259]
          return;
        }

        if (qid) {
          const { error } = await supabase.from('questions').update({
            question_text: qtext, [cite: 260]
            option1: op1,
            option2: op2,
            option3: op3,
            option4: op4,
            correct_option: correct
          }).eq('id', qid); [cite: 260]
          if (error) showQError(error.message); [cite: 261]
          else showQSuccess('سوال ویرایش شد.'); [cite: 261]
        } else {
          const { error } = await supabase.from('questions').insert([{
            exam_id: currentExamId,
            question_text: qtext,
            option1: op1,
            option2: op2,
            option3: op3,
            option4: op4, [cite: 261, 262]
            correct_option: correct
          }]);
          if (error) showQError(error.message); [cite: 263]
          else showQSuccess('سوال جدید اضافه شد.'); [cite: 263]
        }
        questionForm.reset(); [cite: 263]
        qEditId.value = ''; [cite: 263, 264]
        qFormTitle.textContent = 'افزودن سوال جدید'; [cite: 264]
        qSubmitBtn.textContent = 'ذخیره سوال'; [cite: 264]
        await loadQuestionsList(); [cite: 264]
      });

      questionsList.addEventListener('click', async e => {
        const btn = e.target;
        const id = btn.dataset.id;
        if (btn.classList.contains('edit-q-btn')) {
          const { data, error } = await supabase.from('questions').select('*').eq('id', id).maybeSingle(); [cite: 265]
          if (!data || error) {
            showQError('خطا در دریافت اطلاعات سوال!'); [cite: 265]
            return;
          }
          qEditId.value = data.id; [cite: 266]
          questionText.value = data.question_text; [cite: 266]
          option1.value = data.option1; [cite: 266]
          option2.value = data.option2; [cite: 266]
          option3.value = data.option3; [cite: 266]
          option4.value = data.option4; [cite: 266]
          correctOption.value = data.correct_option; [cite: 267]
          qFormTitle.textContent = 'ویرایش سوال'; [cite: 267]
          qSubmitBtn.textContent = 'به‌روزرسانی سوال'; [cite: 267]
        }
        if (btn.classList.contains('delete-q-btn')) {
          if (confirm('آیا از حذف سوال مطمئن هستید؟')) {
            const { error } = await supabase.from('questions').delete().eq('id', id); [cite: 267, 268]
            if (error) showQError('خطا در حذف سوال!'); [cite: 268]
            else showQSuccess('سوال حذف شد.'); [cite: 268]
            await loadQuestionsList(); [cite: 268, 269]
          }
        }
      });

      await loadExams(); [cite: 269]

      document.getElementById('importExcelBtn').onclick = () => { [cite: 270]
        document.getElementById('excelInput').click(); [cite: 270]
      };

      document.getElementById('excelInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!currentExamId) {
          alert('ابتدا آزمون مورد نظر را انتخاب کنید.');
          return;
        }
        const reader = new FileReader();
        reader.onload = async (evt) => {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          // اضافه کردن exam_id به هر ردیف
          for (const row of rows) { [cite: 271]
            row.exam_id = currentExamId;
          }

          // ارسال همه سوالات به صورت یکجا
          const { error } = await supabase.from('questions').insert(rows); [cite: 271]
          if (error) {
            alert('خطا در وارد کردن سوالات: ' + error.message);
          } else {
            alert('سوالات با موفقیت وارد شدند!');
            await loadQuestionsList();
          }
          e.target.value = ''; // ریست input
        };
        reader.readAsArrayBuffer(file); [cite: 271, 272]
      });
    });
  </script>
</body>
</html>

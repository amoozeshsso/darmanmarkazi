<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ویرایش صفحه اصلی و منابع</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; padding: 30px 25px; box-shadow: 0 3px 18px rgba(44,62,80,0.07);}
    h1 { color: #4e54c8; margin-bottom: 30px; }
    label { font-weight: bold; color: #2c3e50; margin-top: 18px; display: block; }
    input, textarea, select { width: 100%; padding: 10px; margin: 6px 0 14px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
    textarea { resize: vertical; min-height: 60px; }
    button { padding: 12px 30px; background: #4e54c8; color: #fff; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; margin-top: 15px; }
    button:hover { background: #2c3e50; }
    .links-section { background: #f5f7fa; border-radius: 8px; padding: 15px 10px; margin-bottom: 25px; }
    .link-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;}
    .link-row label { margin: 0 0 0 8px; min-width: 90px; }
    .link-row input { width: 30%; min-width: 120px; }
    .link-row select { width: 18%; min-width: 80px; }
    #loading { display: none; margin: 18px 0; color: #4e54c8; font-size: 18px;}
    #error, #success { display: none; padding: 12px; border-radius: 4px; margin: 18px 0; font-size: 16px;}
    #error { background: #ffebee; color: #c0392b; }
    #success { background: #e8f5e9; color: #27ae60; }
    @media (max-width: 700px) {
      .container { padding: 10px 2vw; }
      .link-row { flex-direction: column; gap: 2px; }
      .link-row input, .link-row select { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ویرایش صفحه اصلی و منابع</h1>
    <form id="contentForm" autocomplete="off">
      <label for="welcome_text">متن خوش‌آمدگویی:</label>
      <textarea id="welcome_text" name="welcome_text" placeholder="متن خوش آمدگویی..."></textarea>

      <label for="image_url">آدرس تصویر اصلی (اختیاری):</label>
      <input type="text" id="image_url" name="image_url" placeholder="https://...">

      <div class="links-section">
        <h3 style="margin-bottom:10px;">لینک‌های سایت (حداکثر ۲۰ لینک):</h3>
        <div id="linksContainer"></div>
      </div>

      <button type="submit">ذخیره تغییرات</button>
      <div id="loading">در حال ذخیره...</div>
      <div id="error"></div>
      <div id="success"></div>
    </form>
  </div>

  <script>
    // --- Supabase Config ---
    const supabase = window.supabase.createClient(
      'https://qdccjbakfuywvdqfcoyg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU'
    );

    // --- ایجاد فیلدهای لینک به صورت داینامیک ---
    const linksContainer = document.getElementById('linksContainer');
    const linkCount = 20;
    for (let i = 1; i <= linkCount; i++) {
      const row = document.createElement('div');
      row.className = 'link-row';
      row.innerHTML = `
        <label>لینک ${i}:</label>
        <input type="text" id="link${i}_url" name="link${i}_url" placeholder="آدرس لینک ${i}">
        <input type="text" id="link${i}_text" name="link${i}_text" placeholder="متن لینک ${i}">
        <input type="number" id="link${i}_exam_id" name="link${i}_exam_id" placeholder="کد آزمون (اختیاری)">
      `;
      linksContainer.appendChild(row);
    }

    // --- نمایش پیام ---
    function showMsg(type, msg) {
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
      if (type === 'error') {
        document.getElementById('error').textContent = msg;
        document.getElementById('error').style.display = 'block';
      } else if (type === 'success') {
        document.getElementById('success').textContent = msg;
        document.getElementById('success').style.display = 'block';
      }
    }

    // --- بارگذاری داده‌های فعلی سایت ---
    async function loadContent() {
      document.getElementById('loading').style.display = 'block';
      const { data, error } = await supabase.from('site_content').select('*').order('id', {ascending: true}).limit(1);
      document.getElementById('loading').style.display = 'none';
      if (error) {
        showMsg('error', 'خطا در دریافت اطلاعات سایت');
        return;
      }
      if (data && data.length) {
        const content = data[0];
        document.getElementById('welcome_text').value = content.welcome_text || '';
        document.getElementById('image_url').value = content.image_url || '';
        for (let i = 1; i <= linkCount; i++) {
          document.getElementById(`link${i}_url`).value = content[`link${i}_url`] || '';
          document.getElementById(`link${i}_text`).value = content[`link${i}_text`] || '';
          document.getElementById(`link${i}_exam_id`).value = content[`link${i}_exam_id`] || '';
        }
        // ذخیره id رکورد برای ویرایش
        document.getElementById('contentForm').dataset.rowId = content.id;
      }
    }

    // --- ذخیره تغییرات ---
    document.getElementById('contentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      document.getElementById('loading').style.display = 'block';
      showMsg('error', ''); showMsg('success', '');

      // جمع‌آوری داده‌ها
      const data = {
        welcome_text: document.getElementById('welcome_text').value,
        image_url: document.getElementById('image_url').value,
        updated_at: new Date().toISOString()
      };
      for (let i = 1; i <= linkCount; i++) {
        data[`link${i}_url`] = document.getElementById(`link${i}_url`).value;
        data[`link${i}_text`] = document.getElementById(`link${i}_text`).value;
        data[`link${i}_exam_id`] = document.getElementById(`link${i}_exam_id`).value || null;
      }

      // ویرایش یا درج
      const rowId = this.dataset.rowId;
      let res;
      if (rowId) {
        res = await supabase.from('site_content').update(data).eq('id', rowId);
      } else {
        res = await supabase.from('site_content').insert([data]);
      }
      document.getElementById('loading').style.display = 'none';

      if (res.error) {
        showMsg('error', 'خطا در ذخیره اطلاعات: ' + res.error.message);
      } else {
        showMsg('success', 'تغییرات با موفقیت ذخیره شد.');
        if (!rowId) loadContent();
      }
    });

    // --- بارگذاری اولیه ---
    loadContent();
  </script>
</body>
</html>

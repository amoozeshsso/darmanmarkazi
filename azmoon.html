<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تعریف و مدیریت آزمون</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- بارگذاری جلالی از CDN معتبر -->
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.1.0/dist/jalaali.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1100px; margin: auto; }
    .back { margin-bottom: 18px; text-align: right; }
    .back a { background: #4e54c8; color: #fff; padding: 8px 18px; border-radius: 5px; text-decoration: none; }
    #formBox { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    #formGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px 32px; }
    #formGrid > div { display: flex; flex-direction: column; }
    label { margin-bottom: 5px; color: #555; font-weight: bold; }
    input, select { padding: 9px; border: 1.5px solid #ddd; border-radius: 4px; font-size: 15px; }
    input:focus, select:focus { outline: none; border-color: #3498db; }
    .multi-select { min-height: 90px; background: #fafdff; }
    .multi-select option { padding: 6px; }
    button { padding: 10px 0; margin: 2px 0; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; }
    .add-btn { background: #27ae60; color: #fff; width: 100%; margin-top: 10px; }
    .edit-btn { background: #2980b9; color: #fff; }
    .delete-btn { background: #c0392b; color: #fff; }
    #error, #success { display: none; padding: 10px; margin-top: 15px; border-radius: 4px; text-align: center; }
    #error { background: rgba(231,76,60,0.8); color: #fff; }
    #success { background: rgba(46,204,113,0.8); color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
    th { background: #2c3e50; color: #fff; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f7ef; }
    .action-column { min-width: 120px; }
    #loading { display: none; text-align: center; margin: 20px 0; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 900px) {
      #formGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back">
      <a href="admin_exam.html">بازگشت به منوی مدیریت</a>
    </div>
    <h1>تعریف و مدیریت آزمون</h1>
    <div id="formBox">
      <h3 id="formTitle">افزودن آزمون جدید</h3>
      <form id="examForm">
        <input type="hidden" id="editId" />
        <div id="formGrid">
          <div>
            <label for="title">عنوان آزمون:</label>
            <input type="text" id="title" required />
          </div>
          <div>
            <label for="max_attempts">تعداد دفعات مجاز شرکت در آزمون:</label>
            <input type="number" id="max_attempts" min="1" required />
          </div>
          <div>
            <label for="random_question_count">تعداد سوال تصادفی برای هر کاربر:</label>
            <input type="number" id="random_question_count" min="1" required />
          </div>
          <div>
            <label for="duration_minutes">مدت زمان آزمون (دقیقه):</label>
            <input type="number" id="duration_minutes" min="1" required />
          </div>
          <div>
            <label for="start_at">تاریخ و ساعت شروع آزمون:</label>
            <input type="datetime-local" id="start_at" required />
          </div>
          <div>
            <label for="end_at">تاریخ و ساعت پایان آزمون (اختیاری):</label>
            <input type="datetime-local" id="end_at" />
          </div>
          <div>
            <label for="pass_mark">نمره قبولی:</label>
            <input type="number" id="pass_mark" min="1" required />
          </div>
          <div>
            <label for="active">فعال؟</label>
            <select id="active" required>
              <option value="true">بله</option>
              <option value="false">خیر</option>
            </select>
          </div>
          <div style="grid-column:1/3;">
            <label for="allowed_users">کاربران مجاز به شرکت در آزمون:</label>
            <select id="allowed_users" multiple class="multi-select"></select>
          </div>
        </div>
        <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
      </form>
      <div id="error"></div>
      <div id="success"></div>
    </div>
    <div id="loading">
      <div class="spinner"></div>
      <p>در حال بارگذاری...</p>
    </div>
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>عنوان آزمون</th>
          <th>تعداد دفعات مجاز</th>
          <th>نمره قبولی</th>
          <th>مدت آزمون (دقیقه)</th>
          <th>شروع</th>
          <th>پایان</th>
          <th>تاریخ ایجاد</th>
          <th>فعال؟</th>
          <th class="action-column">عملیات</th>
        </tr>
      </thead>
      <tbody id="examList">
        <tr><td colspan="10">در حال بارگذاری آزمونها...</td></tr>
      </tbody>
    </table>
  </div>
  <script>
    // تبدیل تاریخ میلادی به شمسی فقط برای جدول نمایش
    function toJalaliStr(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (!window.jalaali || !window.jalaali.toJalaali) return iso;
      const j = window.jalaali.toJalaali(d.getFullYear(), d.getMonth() + 1, d.getDate());
      const pad = n => n < 10 ? '0' + n : n;
      return `${j.jy}/${pad(j.jm)}/${pad(j.jd)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const examForm = document.getElementById('examForm');
      const examList = document.getElementById('examList');
      const loading = document.getElementById('loading');
      const errEl = document.getElementById('error');
      const okEl = document.getElementById('success');
      const formTitle = document.getElementById('formTitle');
      const editIdInput = document.getElementById('editId');
      const submitBtn = document.getElementById('submitBtn');
      const allowedUsersSelect = document.getElementById('allowed_users');

      // بارگذاری کاربران برای انتخاب مجازها
      async function loadUsers() {
        const { data, error } = await supabase.from('users').select('id,username,role').order('username');
        if (error) {
          allowedUsersSelect.innerHTML = '<option disabled>خطا در دریافت کاربران</option>';
        } else {
          allowedUsersSelect.innerHTML = data.filter(u => u.role !== 'admin').map(
            u => `<option value="${u.id}">${u.username}</option>`
          ).join('');
        }
      }

      // بارگذاری کاربران مجاز برای آزمون
      async function loadAllowedUsersForExam(exam_id) {
        const { data, error } = await supabase
          .from('exam_allowed_users')
          .select('user_id')
          .eq('exam_id', exam_id);
        if (!error && data) {
          const userIds = data.map(r => r.user_id);
          for (const opt of allowedUsersSelect.options) {
            opt.selected = userIds.includes(Number(opt.value));
          }
        }
      }

      const showLoading = show => loading.style.display = show ? 'block' : 'none';
      const showError = msg => { errEl.textContent = msg; errEl.style.display = 'block'; okEl.style.display = 'none'; };
      const showSuccess = msg => { okEl.textContent = msg; okEl.style.display = 'block'; errEl.style.display = 'none'; };
      const hideMessages = () => { errEl.style.display = okEl.style.display = 'none'; };

      async function loadExams() {
        showLoading(true); hideMessages();
        const { data, error } = await supabase.from('exams').select('*').order('id', { ascending: false });
        if (error) {
          examList.innerHTML = '<tr><td colspan="10">خطا در دریافت آزمون‌ها</td></tr>';
        } else {
          examList.innerHTML = data.length ? data.map(exam => `
            <tr>
              <td>${exam.id}</td>
              <td>${exam.title}</td>
              <td>${exam.max_attempts}</td>
              <td>${exam.pass_mark}</td>
              <td>${exam.duration_minutes}</td>
              <td>${toJalaliStr(exam.start_at)}</td>
              <td>${toJalaliStr(exam.end_at)}</td>
              <td>${toJalaliStr(exam.created_at)}</td>
              <td>${exam.active ? 'بله' : 'خیر'}</td>
              <td>
                <button class="edit-btn" data-id="${exam.id}">ویرایش</button>
                <button class="delete-btn" data-id="${exam.id}">حذف</button>
              </td>
            </tr>`).join('') : '<tr><td colspan="10">آزمونی ثبت نشده است</td></tr>';
        }
        showLoading(false);
      }

      // درج/ویرایش آزمون و کاربران مجاز
      examForm.addEventListener('submit', async e => {
        e.preventDefault();
        hideMessages();
        const id = editIdInput.value;
        const title = document.getElementById('title').value.trim();
        const max_attempts = parseInt(document.getElementById('max_attempts').value);
        const random_question_count = parseInt(document.getElementById('random_question_count').value);
        const duration_minutes = parseInt(document.getElementById('duration_minutes').value);
        const start_at = document.getElementById('start_at').value;
        const end_at = document.getElementById('end_at').value;
        const pass_mark = parseInt(document.getElementById('pass_mark').value);
        const active = document.getElementById('active').value === 'true';
        const allowed_user_ids = Array.from(allowedUsersSelect.selectedOptions).map(opt => Number(opt.value));

        if (!title || !max_attempts || !random_question_count || !duration_minutes || !start_at || !pass_mark) {
          showError('همه فیلدهای ضروری را پر کنید');
          return;
        }
        showLoading(true);

        if (id) {
          // ویرایش آزمون
          const { error } = await supabase.from('exams').update({
            title, max_attempts, random_question_count, duration_minutes,
            start_at, end_at: end_at || null, pass_mark, active
          }).eq('id', id);
          if (error) {
            showError('خطا در ویرایش آزمون: ' + error.message);
            showLoading(false);
            return;
          }
          // ویرایش کاربران مجاز
          await supabase.from('exam_allowed_users').delete().eq('exam_id', id);
          if (allowed_user_ids.length) {
            const allowedRows = allowed_user_ids.map(uid => ({ exam_id: id, user_id: uid }));
            await supabase.from('exam_allowed_users').insert(allowedRows);
          }
          showSuccess('آزمون و کاربران مجاز با موفقیت ویرایش شد');
        } else {
          // درج آزمون جدید
          const { data, error } = await supabase.from('exams').insert([{
            title, max_attempts, random_question_count, duration_minutes,
            start_at, end_at: end_at || null, pass_mark, active
          }]).select('id');
          if (error || !data || !data[0]) {
            showError('خطا در ثبت آزمون: ' + (error ? error.message : ''));
            showLoading(false);
            return;
          }
          const newExamId = data[0].id;
          if (allowed_user_ids.length) {
            const allowedRows = allowed_user_ids.map(uid => ({ exam_id: newExamId, user_id: uid }));
            await supabase.from('exam_allowed_users').insert(allowedRows);
          }
          showSuccess('آزمون جدید و کاربران مجاز با موفقیت ثبت شد');
        }
        examForm.reset();
        editIdInput.value = '';
        formTitle.textContent = 'افزودن آزمون جدید';
        submitBtn.textContent = 'ذخیره';
        await loadExams();
        showLoading(false);
      });

      // ویرایش آزمون
      examList.addEventListener('click', async e => {
        const btn = e.target;
        if (btn.classList.contains('edit-btn')) {
          const id = btn.dataset.id;
          showLoading(true);
          const { data, error } = await supabase.from('exams').select('*').eq('id', id).single();
          if (error || !data) {
            showError('خطا در دریافت اطلاعات آزمون');
            showLoading(false);
            return;
          }
          editIdInput.value = data.id;
          document.getElementById('title').value = data.title;
          document.getElementById('max_attempts').value = data.max_attempts;
          document.getElementById('random_question_count').value = data.random_question_count;
          document.getElementById('duration_minutes').value = data.duration_minutes;
          document.getElementById('start_at').value = data.start_at ? data.start_at.substring(0,16) : '';
          document.getElementById('end_at').value = data.end_at ? data.end_at.substring(0,16) : '';
          document.getElementById('pass_mark').value = data.pass_mark;
          document.getElementById('active').value = data.active ? 'true' : 'false';
          formTitle.textContent = 'ویرایش آزمون';
          submitBtn.textContent = 'ثبت ویرایش';
          await loadAllowedUsersForExam(id);
          showLoading(false);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (btn.classList.contains('delete-btn')) {
          if (confirm('آیا از حذف این آزمون مطمئن هستید؟')) {
            showLoading(true);
            const id = btn.dataset.id;
            await supabase.from('exam_allowed_users').delete().eq('exam_id', id);
            const { error } = await supabase.from('exams').delete().eq('id', id);
            if (error) showError('خطا در حذف آزمون: ' + error.message);
            else showSuccess('آزمون حذف شد');
            await loadExams();
            showLoading(false);
          }
        }
      });

      await loadUsers();
      await loadExams();
    });
  </script>
</body>
</html>

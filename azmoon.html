<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تعریف و مدیریت آزمون</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1100px; margin: auto; }
    #formBox form { display: flex; flex-wrap: wrap; gap: 20px 40px; }
    #formBox label, #formBox input, #formBox textarea { width: 100%; box-sizing: border-box; font-size: 14px; color: #555; }
    .form-group { flex: 1 1 calc(50% - 40px); min-width: 280px; display: flex; flex-direction: column; }
    #submitBtn { width: 100%; margin-top: 12px; padding: 12px; font-size: 16px; background-color: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; }
    #submitBtn:hover { background-color: #219150; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
    th { background: #2c3e50; color: #fff; }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f7ef; }
    button { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .add-btn { background: #27ae60; color: #fff; }
    .edit-btn { background: #2980b9; color: #fff; }
    .delete-btn { background: #c0392b; color: #fff; }
    #formBox { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .back { margin-bottom: 18px; text-align: right; }
    .back a { background: #4e54c8; color: #fff; padding: 8px 18px; border-radius: 5px; text-decoration: none; font-size: 14px; }
    @media (max-width: 768px) { .form-group { flex: 1 1 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="back">
      <a href="admin_exam.html">بازگشت به منوی مدیریت</a>
    </div>
    <h1>تعریف و مدیریت آزمون</h1>
    <div id="formBox">
      <h3 id="formTitle">افزودن آزمون جدید</h3>
      <form id="examForm">
        <input type="hidden" id="editId" />
        <div class="form-group">
          <label for="title">عنوان آزمون:</label>
          <input type="text" id="title" required />
        </div>
        <div class="form-group">
          <label for="maxAttempts">تعداد دفعات مجاز شرکت در آزمون:</label>
          <input type="number" id="maxAttempts" min="1" max="20" value="1" required />
        </div>
        <div class="form-group">
          <label for="randomQuestionCount">تعداد سوال تصادفی برای هر کاربر:</label>
          <input type="number" id="randomQuestionCount" min="1" max="100" value="2" required />
        </div>
        <div class="form-group">
          <label for="durationMinutes">مدت زمان آزمون (دقیقه):</label>
          <input type="number" id="durationMinutes" min="1" max="300" value="20" required />
        </div>
        <div class="form-group">
          <label for="startAtPersian">تاریخ و ساعت شروع آزمون:</label>
          <input type="text" id="startAtPersian" required />
          <input type="hidden" id="startAtISO" />
        </div>
        <div class="form-group">
          <label for="endAtPersian">تاریخ و ساعت پایان آزمون (اختیاری):</label>
          <input type="text" id="endAtPersian" />
          <input type="hidden" id="endAtISO" />
        </div>
        <div class="form-group">
          <label for="passMark">نمره قبولی:</label>
          <input type="number" id="passMark" min="1" max="100" value="10" required />
        </div>
        <button type="submit" id="submitBtn" class="add-btn">ذخیره</button>
      </form>
      <div id="error"></div>
      <div id="success"></div>
    </div>
    <div id="loading" style="display:none; text-align:center; margin:20px 0;">
      <div style="border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:auto;"></div>
      <p>در حال بارگذاری...</p>
    </div>
    <table>
      <thead>
        <tr>
          <th>شناسه</th>
          <th>عنوان آزمون</th>
          <th>تعداد دفعات مجاز</th>
          <th>نمره قبولی</th>
          <th>مدت آزمون (دقیقه)</th>
          <th>شروع</th>
          <th>پایان</th>
          <th>تاریخ ایجاد</th>
          <th>فعال؟</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody id="examList">
        <tr><td colspan="10">در حال بارگذاری آزمون‌ها...</td></tr>
      </tbody>
    </table>
  </div>

<script>
$(document).ready(function () {
  $('#startAtPersian').persianDatepicker({
    format: 'YYYY/MM/DD HH:mm',
    timePicker: { enabled: true },
    altField: '#startAtISO',
    altFormat: 'YYYY-MM-DDTHH:mm:ssZ',
  });
  $('#endAtPersian').persianDatepicker({
    format: 'YYYY/MM/DD HH:mm',
    timePicker: { enabled: true },
    altField: '#endAtISO',
    altFormat: 'YYYY-MM-DDTHH:mm:ssZ',
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const SUPABASE_URL = 'https://qdccjbakfuywvdqfcoyg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkY2NqYmFrZnV5d3ZkcWZjb3lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzk3MTEsImV4cCI6MjA2MTk1NTcxMX0.cwpbvCF3Qs3Mg1GAYPimijXnyDDzQERuTb_k2XZl5ZU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const form = document.getElementById('examForm');
  const startAtISO = document.getElementById('startAtISO');
  const endAtISO = document.getElementById('endAtISO');
  const editIdInput = document.getElementById('editId');
  const list = document.getElementById('examList');
  const showLoading = show => document.getElementById('loading').style.display = show ? 'block' : 'none';
  const showError = msg => { document.getElementById('error').textContent = msg; };
  const showSuccess = msg => { document.getElementById('success').textContent = msg; };

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const maxAttempts = parseInt(document.getElementById('maxAttempts').value) || 1;
    const duration = parseInt(document.getElementById('durationMinutes').value) || 20;
    const randomQuestionCount = parseInt(document.getElementById('randomQuestionCount').value) || 2;
    const passMark = parseInt(document.getElementById('passMark').value) || 10;

    const startAtPersian = $('#startAtPersian').val();
    const endAtPersian = $('#endAtPersian').val();

    if (!startAtPersian) return showError('تاریخ شروع آزمون الزامی است.');

    let startAt, endAt;
    try {
      const startPicker = $('#startAtPersian').data('datepicker');
      const endPicker = $('#endAtPersian').data('datepicker');
      startAt = new persianDate(startPicker.getState().selected.unixDate).toDate().toISOString();
      endAt = endPicker.getState().selected.unixDate
        ? new persianDate(endPicker.getState().selected.unixDate).toDate().toISOString()
        : null;
    } catch (err) {
      return showError('خطا در تبدیل تاریخ. لطفاً تاریخ را صحیح وارد کنید.');
    }

    const id = editIdInput.value;

    const examData = {
      title,
      max_attempts: maxAttempts,
      duration_minutes: duration,
      random_question_count: randomQuestionCount,
      pass_mark: passMark,
      start_at: startAt,
      end_at: endAt,
      active: true
    };

    showLoading(true);
    try {
      if (id) {
        await supabase.from('exams').update(examData).eq('id', id);
        showSuccess('آزمون با موفقیت ویرایش شد');
      } else {
        await supabase.from('exams').insert([examData]);
        showSuccess('آزمون جدید اضافه شد');
      }
      form.reset();
      $('#startAtPersian').val('');
      $('#endAtPersian').val('');
      editIdInput.value = '';
      await loadExams();
    } catch (err) {
      showError('خطا در ذخیره آزمون: ' + err.message);
    }
    showLoading(false);
  });

  list.addEventListener('click', async e => {
    const btn = e.target;
    const row = btn.closest('tr');
    const id = btn.dataset.id;
    if (btn.classList.contains('edit-btn')) {
      const { data, error } = await supabase.from('exams').select('*').eq('id', id).single();
      if (!error) {
        document.getElementById('title').value = data.title;
        document.getElementById('maxAttempts').value = data.max_attempts;
        document.getElementById('randomQuestionCount').value = data.random_question_count;
        document.getElementById('durationMinutes').value = data.duration_minutes;
        document.getElementById('passMark').value = data.pass_mark;
        editIdInput.value = data.id;
        if (data.start_at) {
          const pd = new persianDate(new Date(data.start_at)).format('YYYY/MM/DD HH:mm');
          $('#startAtPersian').persianDatepicker('setDate', pd);
        }
        if (data.end_at) {
          const pd = new persianDate(new Date(data.end_at)).format('YYYY/MM/DD HH:mm');
          $('#endAtPersian').persianDatepicker('setDate', pd);
        }
      }
    }
    if (btn.classList.contains('delete-btn')) {
      if (confirm('آیا از حذف این آزمون مطمئن هستید؟')) {
        await supabase.from('exams').delete().eq('id', id);
        await loadExams();
      }
    }
    if (btn.classList.contains('active-toggle')) {
      const active = btn.checked;
      await supabase.from('exams').update({ active }).eq('id', id);
    }
  });

  async function loadExams() {
    persianDate.toLocale('fa').utcMode(false);
    showLoading(true);
    const { data, error } = await supabase.from('exams').select('*').order('id');
    if (error) {
      list.innerHTML = '<tr><td colspan="10">خطا در دریافت داده‌ها</td></tr>';
    } else {
      if (!data.length) {
        list.innerHTML = '<tr><td colspan="10">آزمونی یافت نشد</td></tr>';
      } else {
        list.innerHTML = data.map(exam => `
          <tr>
            <td>${exam.id}</td>
            <td>${exam.title}</td>
            <td>${exam.max_attempts || 1}</td>
            <td>${exam.pass_mark || '-'}</td>
            <td>${exam.duration_minutes || 20}</td>
            <td>${exam.start_at ? new persianDate(new Date(exam.start_at)).format('YYYY/MM/DD HH:mm') : '-'}</td>
            <td>${exam.end_at ? new persianDate(new Date(exam.end_at)).format('YYYY/MM/DD HH:mm') : '-'}</td>
            <td>${exam.created_at ? new persianDate(new Date(exam.created_at)).format('YYYY/MM/DD HH:mm') : ''}</td>
            <td>
              <input type="checkbox" class="active-toggle" data-id="${exam.id}" ${exam.active ? 'checked' : ''} />
              <span style="font-size:12px; color:${exam.active ? '#27ae60' : '#c0392b'}">${exam.active ? 'فعال' : 'غیرفعال'}</span>
            </td>
            <td>
              <button class="edit-btn" data-id="${exam.id}">ویرایش</button>
              <button class="delete-btn" data-id="${exam.id}">حذف</button>
            </td>
          </tr>`).join('');
      }
    }
    showLoading(false);
  }
  await loadExams();
});
</script>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</body>
</html>

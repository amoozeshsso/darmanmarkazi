<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>تعریف و مدیریت آزمون</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@33.003.0/dist/font-face.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <style>
        body {
            font-family: Vazirmatn, Tahoma, Arial, sans-serif;
            direction: rtl;
            background: #f7f7f7;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 12px #ddd;
            padding: 28px;
        }
        h2 { margin-bottom: 18px; }
        .form-section { margin-bottom: 30px; }
        label { display: block; margin: 8px 0 4px; }
        input, select {
            padding: 6px 8px;
            width: 260px;
            border: 1px solid #bbb;
            border-radius: 5px;
            font-family: Vazirmatn, Tahoma, Arial, sans-serif;
        }
        .btn {
            padding: 7px 18px;
            margin-top: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            font-family: Vazirmatn, Tahoma, Arial, sans-serif;
            font-size: 15px;
        }
        .btn-danger { background: #d9534f; color: #fff; }
        .btn-edit { background: #0275d8; color: #fff; }
        .btn-add { background: #5cb85c; color: #fff; }
        .btn-cancel { background: #888; color: #fff; }
        .btn:hover { opacity: 0.88; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
        th { background: #f2f2f2; }
        .loading { color: #888; font-style: italic; }
        .hidden { display: none; }
        .actions button { margin-left: 4px; }
        #showFormBtn { margin-bottom: 18px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@0.1.8/dist/persian-date.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.1.0/dist/jalaali.js"></script>
</head>
<body>
<div class="container">
    <h2>تعریف و مدیریت آزمون</h2>
    <button class="btn btn-add" id="showFormBtn">افزودن آزمون جدید</button>

    <div class="form-section hidden" id="examFormSection">
        <form id="examForm">
            <input type="hidden" id="exam_id">
            <label>عنوان آزمون:</label>
            <input type="text" id="title" required>
            <label>تعداد دفعات مجاز شرکت در آزمون:</label>
            <input type="number" id="max_attempts" min="1" required>
            <label>تعداد سوال تصادفی برای هر کاربر:</label>
            <input type="number" id="random_questions" min="1" required>
            <label>مدت زمان آزمون (دقیقه):</label>
            <input type="number" id="duration" min="1" required>
            <label>تاریخ و ساعت شروع آزمون:</label>
            <input type="text" id="start_date" required readonly style="background:#fff;cursor:pointer;">
            <label>تاریخ و ساعت پایان آزمون (اختیاری):</label>
            <input type="text" id="end_date" readonly style="background:#fff;cursor:pointer;">
            <label>نمره قبولی:</label>
            <input type="number" id="pass_score" min="0" required>
            <br>
            <button type="submit" class="btn btn-add">ذخیره</button>
            <button type="button" class="btn btn-cancel" id="cancelEdit">انصراف</button>
        </form>
    </div>

    <div id="loadingMsg" class="loading">در حال بارگذاری آزمون‌ها...</div>
    <table>
        <thead>
            <tr>
                <th>شناسه</th>
                <th>عنوان آزمون</th>
                <th>تعداد دفعات مجاز</th>
                <th>تعداد سوال تصادفی</th>
                <th>نمره قبولی</th>
                <th>مدت آزمون (دقیقه)</th>
                <th>شروع</th>
                <th>پایان</th>
                <th>تاریخ ایجاد</th>
                <th>فعال؟</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="examTableBody">
            <tr><td colspan="11" class="loading">در حال بارگذاری...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // داده نمونه
    let exams = [
        {
            id: 1,
            title: "آزمون اول",
            max_attempts: 2,
            random_questions: 3,
            pass_score: 12,
            duration: 30,
            start: "2025-05-29T09:00",
            end: "2025-06-10T18:00",
            created: "2025-05-20T12:00",
            active: true
        },
        {
            id: 2,
            title: "آزمون دوم",
            max_attempts: 1,
            random_questions: 5,
            pass_score: 15,
            duration: 45,
            start: "2025-06-01T10:00",
            end: "2025-06-15T17:00",
            created: "2025-05-25T10:00",
            active: false
        }
    ];

    // تبدیل تاریخ میلادی به شمسی
    function toJalali(dateStr) {
        if (!dateStr) return '';
        var parts = dateStr.split('T');
        var date = parts[0].split('-');
        var g = window.jalaali.toJalaali(Number(date[0]), Number(date[1]), Number(date[2]));
        return g.jy + '/' + (g.jm < 10 ? '0' : '') + g.jm + '/' + (g.jd < 10 ? '0' : '') + g.jd + (parts[1] ? ' ' + parts[1] : '');
    }

    // تبدیل تاریخ شمسی (yyyy/mm/dd HH:mm) به میلادی (YYYY-MM-DDTHH:mm)
    function jalaliToGregorian(jalaliDateTime) {
        if (!jalaliDateTime) return '';
        var parts = jalaliDateTime.split(' ');
        var date = parts[0].split('/');
        var g = window.jalaali.toGregorian(Number(date[0]), Number(date[1]), Number(date[2]));
        return g.gy + '-' + (g.gm < 10 ? '0' : '') + g.gm + '-' + (g.gd < 10 ? '0' : '') + g.gd + (parts[1] ? 'T' + parts[1] : '');
    }

    function renderExams() {
        const tbody = document.getElementById('examTableBody');
        tbody.innerHTML = '';
        if (!exams.length) {
            tbody.innerHTML = '<tr><td colspan="11" class="loading">آزمونی وجود ندارد.</td></tr>';
            return;
        }
        exams.forEach(exam => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${exam.id}</td>
                <td>${exam.title}</td>
                <td>${exam.max_attempts}</td>
                <td>${exam.random_questions}</td>
                <td>${exam.pass_score}</td>
                <td>${exam.duration}</td>
                <td>${toJalali(exam.start)}</td>
                <td>${toJalali(exam.end)}</td>
                <td>${toJalali(exam.created)}</td>
                <td>${exam.active ? 'بله' : 'خیر'}</td>
                <td class="actions">
                    <button class="btn btn-edit" onclick="editExam(${exam.id})">ویرایش</button>
                    <button class="btn btn-danger" onclick="deleteExam(${exam.id})">حذف</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // مقداردهی اولیه تقویم شمسی
    function initDatePickers() {
        $("#start_date").persianDatepicker({
            format: "YYYY/MM/DD HH:mm",
            timePicker: { enabled: true },
            initialValue: false,
            autoClose: true
        });
        $("#end_date").persianDatepicker({
            format: "YYYY/MM/DD HH:mm",
            timePicker: { enabled: true },
            initialValue: false,
            autoClose: true
        });
    }

    // نمایش فرم افزودن/ویرایش
    document.getElementById('showFormBtn').onclick = function() {
        document.getElementById('examFormSection').classList.remove('hidden');
        document.getElementById('examForm').reset();
        $("#start_date, #end_date").val('');
        document.getElementById('exam_id').value = '';
        initDatePickers();
    };

    // ثبت یا ویرایش آزمون
    document.getElementById('examForm').onsubmit = function(e) {
        e.preventDefault();
        let id = document.getElementById('exam_id').value;
        let title = document.getElementById('title').value;
        let max_attempts = document.getElementById('max_attempts').value;
        let random_questions = document.getElementById('random_questions').value;
        let duration = document.getElementById('duration').value;
        let start_jalali = document.getElementById('start_date').value;
        let end_jalali = document.getElementById('end_date').value;
        let pass_score = document.getElementById('pass_score').value;

        let start = jalaliToGregorian(start_jalali);
        let end = jalaliToGregorian(end_jalali);

        if (id) {
            // ویرایش
            let exam = exams.find(e => e.id == id);
            exam.title = title;
            exam.max_attempts = Number(max_attempts);
            exam.random_questions = Number(random_questions);
            exam.duration = Number(duration);
            exam.start = start;
            exam.end = end;
            exam.pass_score = Number(pass_score);
        } else {
            // افزودن جدید
            exams.push({
                id: exams.length ? Math.max(...exams.map(e => e.id)) + 1 : 1,
                title,
                max_attempts: Number(max_attempts),
                random_questions: Number(random_questions),
                duration: Number(duration),
                start,
                end,
                created: new Date().toISOString().slice(0,16),
                pass_score: Number(pass_score),
                active: true
            });
        }
        renderExams();
        document.getElementById('examFormSection').classList.add('hidden');
    };

    // ویرایش آزمون
    window.editExam = function(id) {
        let exam = exams.find(e => e.id == id);
        document.getElementById('examFormSection').classList.remove('hidden');
        document.getElementById('exam_id').value = exam.id;
        document.getElementById('title').value = exam.title;
        document.getElementById('max_attempts').value = exam.max_attempts;
        document.getElementById('random_questions').value = exam.random_questions;
        document.getElementById('duration').value = exam.duration;
        document.getElementById('pass_score').value = exam.pass_score;
        $("#start_date").val(toJalali(exam.start));
        $("#end_date").val(toJalali(exam.end));
        initDatePickers();
    };

    // لغو ویرایش یا افزودن
    document.getElementById('cancelEdit').onclick = function() {
        document.getElementById('examFormSection').classList.add('hidden');
    };

    // حذف آزمون
    window.deleteExam = function(id) {
        if (confirm('آیا مطمئن هستید که این آزمون حذف شود؟')) {
            exams = exams.filter(e => e.id != id);
            renderExams();
            document.getElementById('examFormSection').classList.add('hidden');
        }
    };

    // بارگذاری اولیه
    window.onload = function() {
        renderExams();
        document.getElementById('loadingMsg').style.display = 'none';
    };
</script>
</body>
</html>
